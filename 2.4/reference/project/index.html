<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Dj-Stripe Team">
  <link rel="canonical" href="https://dj-stripe.github.io/dj-stripe/2.4/reference/project/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Project - Dj-Stripe</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
  <link href="../../css/version-select.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Project";
    var mkdocs_page_input_path = "reference/project.md";
    var mkdocs_page_url = "/dj-stripe/2.4/reference/project/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Dj-Stripe</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../project/sponsors/">Sponsors</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Getting Started</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../installation/">Installation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api_keys/">Managing Stripe API Keys</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api_versions/">A note on Stripe API Versions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../stripe_elements_js/">Integrating Stripe Elements</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Release notes</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../history/2_4_x/">dj-stripe 2.4.1 release notes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../history/2_4_0/">dj-stripe 2.4 release notes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../history/2_x/">dj-stripe 2.0 ~ 2.3 release notes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../history/1_x/">dj-stripe 1.x release notes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../history/0_x/">dj-stripe 0.x release notes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Usage</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../usage/webhooks/">Using Stripe Webhooks</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../usage/subscribing_customers/">Subscribing a customer to a plan</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../usage/managing_subscriptions/">Managing subscriptions and payment sources</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../usage/manually_syncing_with_stripe/">Manually syncing data with Stripe</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../usage/creating_individual_charges/">Creating individual charges</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Project</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../project/contributing/">Contributing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../project/test_fixtures/">Test Fixtures</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../project/authors/">Credits</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../project/support/">Support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../project/release_process/">Release Process</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Reference</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../context_managers/">Context Managers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../decorators/">Decorators</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../enums/">Enumerations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../managers/">Managers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../middleware/">Middleware</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../models/">Models</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../settings/">Settings</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../utils/">Utilities</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Dj-Stripe</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Project</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/dj-stripe/dj-stripe/edit/master/docs/reference/project.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <!-- We load the djstripe and tests packages in order for mkdocstrings to create links to them and their sub-packages and modules, but we don't expose their contents directy to users in the documentation  -->
<!-- ::: djstripe -->


  <div class="doc doc-object doc-module">

<a id="tests"></a>
    <div class="doc doc-contents first">

      <p>A Fake or multiple fakes for each stripe object.</p>
<p>Originally collected using API VERSION 2015-07-28.
Updated to API VERSION 2016-03-07 with bogus fields.</p>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_ACCOUNT" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_ACCOUNT</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BALANCE_TRANSACTION" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BALANCE_TRANSACTION</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BALANCE_TRANSACTION_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BALANCE_TRANSACTION_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BALANCE_TRANSACTION_III" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BALANCE_TRANSACTION_III</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BALANCE_TRANSACTION_IV" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BALANCE_TRANSACTION_IV</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BALANCE_TRANSACTION_REFUND" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BANK_ACCOUNT" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BANK_ACCOUNT</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BANK_ACCOUNT_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BANK_ACCOUNT_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_BANK_ACCOUNT_SOURCE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CARD" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CARD_AS_PAYMENT_METHOD" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CARD_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CARD_III" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_III</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CARD_IV" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_IV</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CARD_V" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_V</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CHARGE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CHARGE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CHARGE_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CHARGE_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CHARGE_REFUNDED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CHARGE_REFUNDED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_COUPON" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_COUPON</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CUSTOMER" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CUSTOMER_BEFORE_TAX_ID" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_BEFORE_TAX_ID</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CUSTOMER_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CUSTOMER_III" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_III</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CUSTOMER_IV" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_IV</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CUSTOMER_WITHOUT_TAX_ID" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_WITHOUT_TAX_ID</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_CUSTOMER_WITH_TAX_ID" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_WITH_TAX_ID</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_DISCOUNT_CUSTOMER" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_DISCOUNT_CUSTOMER</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_DISPUTE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_DISPUTE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_ACCOUNT_APPLICATION_DEAUTHORIZED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_ACCOUNT_APPLICATION_DEAUTHORIZED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CARD_PAYMENT_METHOD_ATTACHED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CARD_PAYMENT_METHOD_ATTACHED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CARD_PAYMENT_METHOD_DETACHED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CARD_PAYMENT_METHOD_DETACHED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CHARGE_SUCCEEDED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CHARGE_SUCCEEDED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_DISCOUNT_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_DISCOUNT_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_DISCOUNT_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_DISCOUNT_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_SOURCE_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_SOURCE_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_SOURCE_DELETED_DUPE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_DELETED_DUPE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_SUBSCRIPTION_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_SUBSCRIPTION_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_CUSTOMER_SUBSCRIPTION_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_CUSTOMER_SUBSCRIPTION_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_DISPUTE_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_DISPUTE_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_INVOICEITEM_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_INVOICEITEM_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_INVOICEITEM_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_INVOICEITEM_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_INVOICE_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_INVOICE_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_INVOICE_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_INVOICE_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_INVOICE_UPCOMING" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_INVOICE_UPCOMING</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PAYMENT_INTENT_SUCCEEDED_DESTINATION_CHARGE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PAYMENT_INTENT_SUCCEEDED_DESTINATION_CHARGE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PAYMENT_METHOD_ATTACHED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PAYMENT_METHOD_ATTACHED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PAYMENT_METHOD_DETACHED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PAYMENT_METHOD_DETACHED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PLAN_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PLAN_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PLAN_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PLAN_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PLAN_REQUEST_IS_OBJECT" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PLAN_REQUEST_IS_OBJECT</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PRICE_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PRICE_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PRICE_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PRICE_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_PRICE_UPDATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_PRICE_UPDATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CANCELED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CANCELED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_SUBSCRIPTION_SCHEDULE_RELEASED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_RELEASED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_SUBSCRIPTION_SCHEDULE_UPDATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_UPDATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_TEST_CHARGE_SUCCEEDED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_TEST_CHARGE_SUCCEEDED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_TRANSFER_CREATED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_EVENT_TRANSFER_DELETED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_EVENT_TRANSFER_DELETED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_FILEUPLOAD_ICON" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_FILEUPLOAD_ICON</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_FILEUPLOAD_LOGO" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_FILEUPLOAD_LOGO</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_INVOICE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_INVOICEITEM" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICEITEM</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_INVOICEITEM_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICEITEM_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_INVOICEITEM_III" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICEITEM_III</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_INVOICE_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICE_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_INVOICE_III" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICE_III</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_INVOICE_IV" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICE_IV</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PAYMENT_INTENT_DESTINATION_CHARGE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PAYMENT_INTENT_DESTINATION_CHARGE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PAYMENT_INTENT_I" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PAYMENT_INTENT_I</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PAYMENT_INTENT_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PAYMENT_INTENT_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PAYMENT_METHOD_I" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PAYMENT_METHOD_I</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PAYMENT_METHOD_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PAYMENT_METHOD_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PLAN" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PLAN</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PLAN_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PLAN_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PLAN_METERED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PLAN_METERED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PRICE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRICE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PRICE_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRICE_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PRICE_METERED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRICE_METERED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PRICE_ONETIME" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRICE_ONETIME</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PRICE_TIER" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRICE_TIER</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_PRODUCT" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRODUCT</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_REFUND" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_REFUND</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SESSION_I" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SESSION_I</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SETUP_INTENT_I" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SETUP_INTENT_I</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SOURCE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SOURCE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SOURCE_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SOURCE_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_CANCELED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_CANCELED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_CANCELED_AT_PERIOD_END" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_CANCELED_AT_PERIOD_END</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_III" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_III</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_METERED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_METERED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_MULTI_PLAN" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_NOT_PERIOD_CURRENT" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_NOT_PERIOD_CURRENT</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_SUBSCRIPTION_SCHEDULE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_SCHEDULE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TAX_ID" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TAX_ID</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TAX_RATE_EXAMPLE_1_VAT" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TAX_RATE_EXAMPLE_2_SALES" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TAX_RATE_EXAMPLE_2_SALES</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TIER_PLAN" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TIER_PLAN</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TOKEN" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TOKEN</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TRANSFER" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TRANSFER</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TRANSFER_II" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TRANSFER_II</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_TRANSFER_III" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TRANSFER_III</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FAKE_UPCOMING_INVOICE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_UPCOMING_INVOICE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FIXTURE_DIR_PATH" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FIXTURE_DIR_PATH</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.FUTURE_DATE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">FUTURE_DATE</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.IS_STATICMETHOD_AUTOSPEC_SUPPORTED" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 id="tests.logger" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">logger</span></code>


</h3>

    <div class="doc doc-contents ">

    </div>

  </div>


<h2 id="tests-classes">Classes</h2>

  <div class="doc doc-object doc-class">



<h3 id="tests.AssertStripeFksMixin" class="doc doc-heading">
        <code>
tests.AssertStripeFksMixin        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h4 id="tests.AssertStripeFksMixin-methods">Methods</h4>

  <div class="doc doc-object doc-method">



<h5 id="tests.AssertStripeFksMixin.assert_fks" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">AssertStripeFksMixin</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="p">,</span> <span class="n">processed_stripe_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Recursively walk through fks on obj, asserting they're not-none
:param obj:
:param expected_blank_fks: fields that are expected to be None
:param processed_stripe_ids: set of objects ids already processed
:return:</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">assert_fks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="p">,</span> <span class="n">processed_stripe_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively walk through fks on obj, asserting they&#39;re not-none</span>
<span class="sd">    :param obj:</span>
<span class="sd">    :param expected_blank_fks: fields that are expected to be None</span>
<span class="sd">    :param processed_stripe_ids: set of objects ids already processed</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">processed_stripe_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">processed_stripe_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">processed_stripe_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
        <span class="n">field_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_str</span> <span class="ow">or</span> <span class="n">field_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.djstripe_owner_account&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="n">field_value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">field_str</span> <span class="ow">in</span> <span class="n">expected_blank_fks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">field_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">field_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">field_value</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_stripe_ids</span><span class="p">:</span>
                <span class="c1"># recurse into the object if it&#39;s not already been checked</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
                    <span class="n">field_value</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="p">,</span> <span class="n">processed_stripe_ids</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;checked </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_str</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.BankAccountDict" class="doc doc-heading">
        <code>
tests.BankAccountDict        </code>



</h3>

    <div class="doc doc-contents ">




    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.CardDict" class="doc doc-heading">
        <code>
tests.CardDict        </code>



</h3>

    <div class="doc doc-contents ">




    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.ChargeDict" class="doc doc-heading">
        <code>
tests.ChargeDict        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h4 id="tests.ChargeDict-methods">Methods</h4>

  <div class="doc doc-object doc-method">



<h5 id="tests.ChargeDict.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">ChargeDict</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Match Stripe's behavior: return a stripe iterable on <code>charge.refunds</code>.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Match Stripe&#39;s behavior: return a stripe iterable on `charge.refunds`.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">refunds</span> <span class="o">=</span> <span class="n">StripeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refunds</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.ChargeDict.capture" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">ChargeDict</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;captured&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.ChargeDict.refund" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">ChargeDict</span><span class="o">.</span><span class="n">refund</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">refund</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;refunded&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;amount_refunded&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.CustomerDict" class="doc doc-heading">
        <code>
tests.CustomerDict        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tests.CustomerDict.sources" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">CustomerDict</span><span class="o">.</span><span class="n">sources</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.CustomerDict.tax_ids" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">CustomerDict</span><span class="o">.</span><span class="n">tax_ids</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

    </div>

  </div>






  <div class="doc doc-object doc-method">



<h5 id="tests.CustomerDict.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">CustomerDict</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_source_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[])):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_source_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.CustomerDict.create_for_user" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">CustomerDict</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">djstripe.models</span> <span class="kn">import</span> <span class="n">Customer</span>

    <span class="n">stripe_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">stripe_customer</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">stripe_customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stripe_customer</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.CustomerDict.delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">CustomerDict</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.CustomerDict.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">CustomerDict</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idempotency_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idempotency_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.InvoiceDict" class="doc doc-heading">
        <code>
tests.InvoiceDict        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h4 id="tests.InvoiceDict-methods">Methods</h4>

  <div class="doc doc-object doc-method">



<h5 id="tests.InvoiceDict.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">InvoiceDict</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Match Stripe's behavior: return a stripe iterable on <code>invoice.lines</code>.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Match Stripe&#39;s behavior: return a stripe iterable on `invoice.lines`.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">StripeList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.InvoiceDict.pay" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">InvoiceDict</span><span class="o">.</span><span class="n">pay</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.LegacySourceDict" class="doc doc-heading">
        <code>
tests.LegacySourceDict        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="tests.LegacySourceDict.delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">LegacySourceDict</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.PaymentMethodDict" class="doc doc-heading">
        <code>
tests.PaymentMethodDict        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="tests.PaymentMethodDict.detach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">PaymentMethodDict</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.SourceDict" class="doc doc-heading">
        <code>
tests.SourceDict        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="tests.SourceDict.detach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">SourceDict</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;consumed&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.Sources" class="doc doc-heading">
        <code>
tests.Sources        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="tests.Sources.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_fakes</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_fakes</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">card_fakes</span> <span class="o">=</span> <span class="n">card_fakes</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.Sources.create" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fake_card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">card_fakes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fake_card</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fake_card</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.Sources.list" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">card_fakes</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.Sources.retrieve" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># noqa</span>
    <span class="k">for</span> <span class="n">fake_card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">card_fakes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fake_card</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fake_card</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.StripeItem" class="doc doc-heading">
        <code>
tests.StripeItem        </code>



</h3>

    <div class="doc doc-contents ">

      <p>Flexible class built to mock any generic Stripe object.</p>
<p>Implements object access + deletion methods to match the behavior
of Stripe's library, which allows both object + dictionary access.</p>
<p>Has a delete method since (most) Stripe objects can be deleted.</p>




  <div class="doc doc-children">







<h4 id="tests.StripeItem-methods">Methods</h4>

  <div class="doc doc-object doc-method">



<h5 id="tests.StripeItem.__delattr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeItem</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No such attribute: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeItem.__getattr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeItem</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Give StripeItem normal object access to match Stripe behavior.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Give StripeItem normal object access to match Stripe behavior.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No such attribute: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeItem.__setattr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeItem</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeItem.class_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeItem</span><span class="o">.</span><span class="n">class_url</span><span class="p">()</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">class_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;/v1/test-items/&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeItem.delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeItem</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Superficial mock that adds a deleted attribute.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Superficial mock that adds a deleted attribute.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeItem.instance_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeItem</span><span class="o">.</span><span class="n">instance_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Superficial mock that emulates instance_url.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">instance_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Superficial mock that emulates instance_url.&quot;&quot;&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_url</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeItem.request" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeItem</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Superficial mock that emulates request method.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Superficial mock that emulates request method.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;post&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.StripeList" class="doc doc-heading">
        <code>
tests.StripeList        </code>



</h3>

    <div class="doc doc-contents ">

      <p>Mock a generic Stripe Iterable.</p>
<p>It has the relevant attributes of a stripe iterable (has_more, data).</p>
<p>This mock is important so we can use stripe's <code>list</code> method in our testing.
StripeList.list() will return the StripeList.</p>
<p>Additionally, iterating over instances of MockStripeIterable will iterate over
the data attribute, just like Stripe iterables.</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>has_more</code></td>
        <td></td>
        <td><p>mock has_more flag. Default False.</p></td>
      </tr>
      <tr>
        <td><code>**kwargs</code></td>
        <td></td>
        <td><p>all of the fields of the stripe object, generally as a dictionary.</p></td>
      </tr>
  </tbody>
</table>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tests.StripeList.has_more" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="n">has_more</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.StripeList.object" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="n">object</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.StripeList.total_count" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="n">total_count</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.StripeList.url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="n">url</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>




<h4 id="tests.StripeList-methods">Methods</h4>

  <div class="doc doc-object doc-method">



<h5 id="tests.StripeList.__delattr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No such attribute: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeList.__getattr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Give StripeItem normal object access to match Stripe behavior.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Give StripeItem normal object access to match Stripe behavior.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No such attribute: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeList.__iter__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Make StripeList an iterable, to match the Stripe iterable behavior.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Make StripeList an iterable, to match the Stripe iterable behavior.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">iter_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeList.__next__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Define iteration for StripeList.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StripeItem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Define iteration for StripeList.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_copy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeList.__setattr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeList.auto_paging_iter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="n">auto_paging_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Add an auto_paging_iter method to the StripeList which returns itself.</p>
<p>The StripeList is an iterable, so this mimics the real behavior.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">auto_paging_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StripeList&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Add an auto_paging_iter method to the StripeList which returns itself.</span>

<span class="sd">    The StripeList is an iterable, so this mimics the real behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.StripeList.list" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">StripeList</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Add a list method to the StripeList which returns itself.</p>
<p>list() accepts arbitrary kwargs, be careful is you expect the
argument-accepting functionality of Stripe's list() method.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StripeList&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Add a list method to the StripeList which returns itself.</span>

<span class="sd">    list() accepts arbitrary kwargs, be careful is you expect the</span>
<span class="sd">    argument-accepting functionality of Stripe&#39;s list() method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="tests.SubscriptionDict" class="doc doc-heading">
        <code>
tests.SubscriptionDict        </code>



</h3>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h4 id="tests.SubscriptionDict-methods">Methods</h4>

  <div class="doc doc-object doc-method">



<h5 id="tests.SubscriptionDict.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">SubscriptionDict</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">

      <p>Match Stripe's behavior: return a stripe iterable on <code>subscription.items</code>.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Match Stripe&#39;s behavior: return a stripe iterable on `subscription.items`.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StripeList</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.SubscriptionDict.__setattr__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">SubscriptionDict</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Special case for price and plan</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">FAKE_PRICE</span><span class="p">,</span>
            <span class="n">FAKE_PRICE_II</span><span class="p">,</span>
            <span class="n">FAKE_PRICE_TIER</span><span class="p">,</span>
            <span class="n">FAKE_PRICE_METERED</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">price</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">price</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;plan&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="p">[</span><span class="n">FAKE_PLAN</span><span class="p">,</span> <span class="n">FAKE_PLAN_II</span><span class="p">,</span> <span class="n">FAKE_TIER_PLAN</span><span class="p">,</span> <span class="n">FAKE_PLAN_METERED</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">plan</span>

    <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.SubscriptionDict.delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">SubscriptionDict</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Superficial mock that adds a deleted attribute.</p>

        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;at_period_end&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;cancel_at_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;at_period_end&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tests.SubscriptionDict.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">SubscriptionDict</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idempotency_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idempotency_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="tests.convert_source_dict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">convert_source_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">convert_source_dict</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">source_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;card&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">CardDict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;bank_account&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">BankAccountDict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">SourceDict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown source type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_type</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="tests.datetime_to_unix" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">datetime_</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">datetime_to_unix</span><span class="p">(</span><span class="n">datetime_</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime_</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="tests.default_account" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">default_account</span><span class="p">()</span></code>


</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">default_account</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">djstripe.models</span> <span class="kn">import</span> <span class="n">Account</span>

    <span class="k">return</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;acct_TESTXXXXX&quot;</span><span class="p">,</span>
        <span class="n">charges_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">details_submitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">payouts_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="tests.load_fixture" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">load_fixture</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/__init__.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load_fixture</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">FIXTURE_DIR_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



<h2 id="tests-modules">Modules</h2>

  <div class="doc doc-object doc-module">



<h3 id="tests.apps" class="doc doc-heading">
        <code>tests.apps</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








<h4 id="tests.apps-modules">Modules</h4>

  <div class="doc doc-object doc-module">



<h5 id="tests.apps.example" class="doc doc-heading">
        <code>tests.apps.example</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








<h6 id="tests.apps.example-modules">Modules</h6>

  <div class="doc doc-object doc-module">



<h7 id="tests.apps.example.forms" class="doc doc-heading">
        <code>tests.apps.example.forms</code>



</h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h9 id="tests.apps.example.forms.PaymentIntentForm" class="doc doc-heading">
        <code>
tests.apps.example.forms.PaymentIntentForm        </code>



</h9>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.forms.PaymentIntentForm.media" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">PaymentIntentForm</span><span class="o">.</span><span class="n">media</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h11>

    <div class="doc doc-contents ">

    </div>

  </div>








  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h9 id="tests.apps.example.forms.PurchaseSubscriptionForm" class="doc doc-heading">
        <code>
tests.apps.example.forms.PurchaseSubscriptionForm        </code>



</h9>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.forms.PurchaseSubscriptionForm.media" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">PurchaseSubscriptionForm</span><span class="o">.</span><span class="n">media</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h11>

    <div class="doc doc-contents ">

    </div>

  </div>








  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h7 id="tests.apps.example.management" class="doc doc-heading">
        <code>tests.apps.example.management</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








<h8 id="tests.apps.example.management-modules">Modules</h8>

  <div class="doc doc-object doc-module">



<h9 id="tests.apps.example.management.commands" class="doc doc-heading">
        <code>tests.apps.example.management.commands</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h9>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








<h10 id="tests.apps.example.management.commands-modules">Modules</h10>

  <div class="doc doc-object doc-module">



<h11 id="tests.apps.example.management.commands.regenerate_test_fixtures" class="doc doc-heading">
        <code>tests.apps.example.management.commands.regenerate_test_fixtures</code>



</h11>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h13 id="tests.apps.example.management.commands.regenerate_test_fixtures.FAKE_ID_METADATA_KEY" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">FAKE_ID_METADATA_KEY</span></code>


</h13>

    <div class="doc doc-contents ">

    </div>

  </div>


<h12 id="tests.apps.example.management.commands.regenerate_test_fixtures-classes">Classes</h12>

  <div class="doc doc-object doc-class">



<h13 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command" class="doc doc-heading">
        <code>
tests.apps.example.management.commands.regenerate_test_fixtures.Command        </code>



</h13>

    <div class="doc doc-contents ">

      <p>This does the following:</p>
<p>1) Load existing fixtures from JSON files
2) Attempts to read the corresponding objects from Stripe
3) If found, for types Stripe doesn't allow us to choose ids for,
    we build a map between the fake ids in the fixtures and real Stripe ids
3) If not found, creates objects in Stripe from the fixtures
4) Save objects back as fixtures, using fake ids if available</p>
<p>The rationale for this is so that the fixtures can automatically be updated
with Stripe schema changes running this command.</p>
<p>This should make keeping our tests and model schema compatible with Stripe
schema changes less pain-staking and simplify the process of upgrading
the targeted Stripe API version.</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.fake_data_map" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">fake_data_map</span></code>


</h15>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.fake_id_map" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">fake_id_map</span></code>


</h15>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.help" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">help</span></code>


</h15>

    <div class="doc doc-contents ">

    </div>

  </div>




<h14 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command-methods">Methods</h14>

  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.add_arguments" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">add_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>Entry point for subclassed commands to add custom arguments.</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--delete-stale&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Delete any untouched fixtures in the directory&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--update-sideeffect-fields&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Don&#39;t preserve sideeffect fields such as &#39;created&#39;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.fake_json_ids" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">fake_json_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_str</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>Replace real ids with fakes ones in the JSON fixture</p>
<p>Do this on the serialized JSON string since it's a simple string replace
:param json_str:
:return:</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">fake_json_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace real ids with fakes ones in the JSON fixture</span>

<span class="sd">    Do this on the serialized JSON string since it&#39;s a simple string replace</span>
<span class="sd">    :param json_str:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fake_id</span><span class="p">,</span> <span class="n">actual_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_id_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">actual_id</span><span class="p">,</span> <span class="n">fake_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json_str</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_fake_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_fake_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>Get a stable fake id from a real Stripe object, we use this so that fixtures
 are stable
:param obj:
:return:</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_fake_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a stable fake id from a real Stripe object, we use this so that fixtures</span>
<span class="sd">     are stable</span>
<span class="sd">    :param obj:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fake_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">real_id</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">real_id_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_id_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">fake_id</span> <span class="o">=</span> <span class="n">real_id_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">real_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
        <span class="c1"># Note: not all objects have a metadata dict</span>
        <span class="c1"># (eg Account, BalanceTransaction don&#39;t)</span>
        <span class="n">fake_id</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FAKE_ID_METADATA_KEY</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;balance_transaction&quot;</span><span class="p">:</span>
        <span class="c1"># assume for purposes of fixture generation that 1 balance_transaction per</span>
        <span class="c1"># source charge (etc)</span>
        <span class="n">fake_source_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fake_id</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>

        <span class="n">fake_id</span> <span class="o">=</span> <span class="s2">&quot;txn_fake_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fake_source_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fake_id</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_account" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Account</span><span class="p">()</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_balance_transaction" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_balance_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_balance_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ch_&quot;</span><span class="p">):</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Charge</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">StripeModel</span><span class="o">.</span><span class="n">_id_from_data</span><span class="p">(</span>
            <span class="n">charge</span><span class="p">[</span><span class="s2">&quot;balance_transaction&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BalanceTransaction</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    found </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Expected to find balance transaction via source&quot;</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_bank_account" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_bank_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_bank_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    found&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    creating&quot;</span><span class="p">)</span>

        <span class="n">create_obj</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">old_obj</span><span class="p">)</span>

        <span class="c1"># create in Stripe</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">readonly_fields</span><span class="p">:</span>
            <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># see https://stripe.com/docs/connect/testing#account-numbers</span>
        <span class="c1"># we&#39;ve stash the account number in the metadata</span>
        <span class="c1"># so we can regenerate the fixture</span>
        <span class="n">create_obj</span><span class="p">[</span><span class="s2">&quot;account_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span>
            <span class="s2">&quot;djstripe_test_fixture_account_number&quot;</span>
        <span class="p">]</span>
        <span class="n">create_obj</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bank_account&quot;</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">create_obj</span><span class="p">)</span>

        <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_card" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    found&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    creating&quot;</span><span class="p">)</span>

        <span class="n">create_obj</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">old_obj</span><span class="p">)</span>

        <span class="c1"># create in Stripe</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">readonly_fields</span><span class="p">:</span>
            <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">create_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_charge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Invoice</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;invoice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">invoice</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Charge</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    found </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Expected to find charge via invoice&quot;</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">writable_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># merge dicts (eg metadata)</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_invoice" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">):</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Subscription</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">subscription</span><span class="p">[</span><span class="s2">&quot;latest_invoice&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Invoice</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    found </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Expected to find invoice via subscription&quot;</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">writable_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># merge dicts (eg metadata)</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_payment_intent" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_payment_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_payment_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Invoice</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;invoice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">invoice</span><span class="p">[</span><span class="s2">&quot;payment_intent&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentIntent</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    found </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Expected to find payment_intent via invoice&quot;</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">writable_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># merge dicts (eg metadata)</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_payment_method" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_payment_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_payment_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="p">):</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">]</span>
    <span class="n">type_</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentMethod</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    found&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    creating&quot;</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentMethod</span><span class="p">()</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">type_</span><span class="p">,</span> <span class="n">card</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">stripe</span><span class="o">.</span><span class="n">PaymentMethod</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="n">customer</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">djstripe</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">writable_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># merge dicts (eg metadata)</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.get_or_create_stripe_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">get_or_create_stripe_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_or_create_stripe_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    found&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    creating&quot;</span><span class="p">)</span>

        <span class="n">create_obj</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">old_obj</span><span class="p">)</span>

        <span class="c1"># create in Stripe</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">readonly_fields</span><span class="p">:</span>
            <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">source_obj</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;card&quot;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_obj</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">create_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.handle" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>The actual logic of the command. Subclasses must implement
this method.</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="n">do_delete_stale_fixtures</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;delete_stale&quot;</span><span class="p">]</span>
    <span class="n">do_preserve_sideeffect_fields</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;update_sideeffect_fields&quot;</span><span class="p">]</span>
    <span class="n">common_readonly_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;created&quot;</span><span class="p">,</span> <span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="s2">&quot;livemode&quot;</span><span class="p">]</span>
    <span class="n">common_sideeffect_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">]</span>

    <span class="c1"># TODO - is it be possible to get a list of which fields are writable from</span>
    <span class="c1">#  the API?  maybe using https://github.com/stripe/openapi ?</span>
    <span class="c1">#  (though that&#39;s only for current version)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fields that we treat as read-only.</span>
<span class="sd">    Most of these will cause an error if sent to the Stripe API.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_extra_readonly_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Account</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;account_balance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default_source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delinquent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;invoice_prefix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;subscriptions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sources&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BankAccount</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bank_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fingerprint&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Card</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;address_line1_check&quot;</span><span class="p">,</span>
            <span class="s2">&quot;address_zip_check&quot;</span><span class="p">,</span>
            <span class="s2">&quot;brand&quot;</span><span class="p">,</span>
            <span class="s2">&quot;country&quot;</span><span class="p">,</span>
            <span class="s2">&quot;customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cvc_check&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamic_last4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;exp_month&quot;</span><span class="p">,</span>
            <span class="s2">&quot;exp_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fingerprint&quot;</span><span class="p">,</span>
            <span class="s2">&quot;funding&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tokenization_method&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentIntent</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentMethod</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Plan</span><span class="p">:</span> <span class="p">[</span>
            <span class="c1"># Can only specify one of amount and amount_decimal</span>
            <span class="s2">&quot;amount_decimal&quot;</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Source</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">,</span>
            <span class="s2">&quot;card&quot;</span><span class="p">,</span>
            <span class="s2">&quot;client_secret&quot;</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statement_descriptor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;usage&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Subscription</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="c1"># not actually read-only</span>
            <span class="s2">&quot;billing_cycle_anchor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;billing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;current_period_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;current_period_start&quot;</span><span class="p">,</span>
            <span class="c1"># workaround for &quot;the</span>
            <span class="c1"># `invoice_customer_balance_settings[consume_applied_balance_on_void]`</span>
            <span class="c1"># parameter is only supported in API version 2019-11-05 and below.</span>
            <span class="c1"># See</span>
            <span class="c1"># https://stripe.com/docs/api#versioning and</span>
            <span class="c1"># https://stripe.com/docs/upgrades#2019-12-03 for more detail.</span>
            <span class="s2">&quot;invoice_customer_balance_settings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latest_invoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TaxRate</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
    <span class="p">}</span>  <span class="c1"># type: Dict[Type[djstripe.models.StripeModel], List[str]]</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fields that we don&#39;t care about the value of, and that preserving</span>
<span class="sd">    allows us to avoid churn in the fixtures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_sideeffect_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BalanceTransaction</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;available_on&quot;</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Source</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;client_secret&quot;</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Charge</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;receipt_url&quot;</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Subscription</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;billing_cycle_anchor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;current_period_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;current_period_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_date&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">SubscriptionItem</span><span class="p">:</span> <span class="p">[</span>
            <span class="c1"># we don&#39;t currently track separate fixtures for SubscriptionItems</span>
            <span class="s2">&quot;id&quot;</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Invoice</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finalized_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hosted_invoice_url&quot;</span><span class="p">,</span>
            <span class="s2">&quot;invoice_pdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;webhooks_delivered_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;period_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;period_end&quot;</span><span class="p">,</span>
            <span class="c1"># we don&#39;t currently track separate fixtures for SubscriptionItems</span>
            <span class="s2">&quot;subscription_item&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>  <span class="c1"># type: Dict[Type[djstripe.models.StripeModel], List[str]]</span>

    <span class="n">object_sideeffect_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">model</span><span class="o">.</span><span class="n">stripe_class</span><span class="o">.</span><span class="n">OBJECT_NAME</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_sideeffect_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>  <span class="c1"># type: Dict[str, Set[str]]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fake_data_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># djstripe.models.Account: [tests.FAKE_ACCOUNT],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_III</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BankAccount</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Card</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_II</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_V</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Source</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SOURCE</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Plan</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PLAN</span><span class="p">,</span> <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PLAN_II</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Price</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRICE</span><span class="p">,</span> <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRICE_II</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PRODUCT</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TaxRate</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_TAX_RATE_EXAMPLE_2_SALES</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Subscription</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_II</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">SubscriptionSchedule</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_SUBSCRIPTION_SCHEDULE</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Invoice</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICE</span><span class="p">,</span> <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_INVOICE_IV</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Charge</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CHARGE</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentIntent</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentMethod</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">,</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BalanceTransaction</span><span class="p">:</span> <span class="p">[</span><span class="n">tests</span><span class="o">.</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">init_fake_id_map</span><span class="p">()</span>

    <span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Regenerate each of the fixture objects via Stripe</span>
    <span class="c1"># We re-fetch objects in a second pass if they were created during</span>
    <span class="c1"># the first pass, to ensure nested objects are up to date</span>
    <span class="c1"># (eg Customer.subscriptions),</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">any_created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating fixture objects, pass </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># reset the objects list since we don&#39;t want to keep those from</span>
        <span class="c1"># the first pass</span>
        <span class="n">objs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">old_objs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_data_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">common_readonly_fields</span>
                <span class="o">+</span> <span class="n">model_extra_readonly_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">old_obj</span> <span class="ow">in</span> <span class="n">old_objs</span><span class="p">:</span>
                <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_fixture_obj</span><span class="p">(</span>
                    <span class="n">old_obj</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">old_obj</span><span class="p">),</span>
                    <span class="n">model_class</span><span class="o">=</span><span class="n">model_class</span><span class="p">,</span>
                    <span class="n">readonly_fields</span><span class="o">=</span><span class="n">readonly_fields</span><span class="p">,</span>
                    <span class="n">do_preserve_sideeffect_fields</span><span class="o">=</span><span class="n">do_preserve_sideeffect_fields</span><span class="p">,</span>
                    <span class="n">object_sideeffect_fields</span><span class="o">=</span><span class="n">object_sideeffect_fields</span><span class="p">,</span>
                    <span class="n">common_sideeffect_fields</span><span class="o">=</span><span class="n">common_sideeffect_fields</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">any_created</span> <span class="o">=</span> <span class="n">created</span> <span class="ow">or</span> <span class="n">any_created</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">any_created</span><span class="p">:</span>
            <span class="c1"># nothing created on this pass, no need to continue</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;Warning, unexpected behaviour - some fixtures still being created &quot;</span>
            <span class="s2">&quot;in second pass?&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Now the fake_id_map should be complete and the objs should be up to date,</span>
    <span class="c1"># save all the fixtures</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_fixture</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_delete_stale_fixtures</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tests</span><span class="o">.</span><span class="n">FIXTURE_DIR_PATH</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;deleting </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.init_fake_id_map" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">init_fake_id_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>Build a mapping between fake ids stored in Stripe metadata and those obj's
actual ids</p>
<p>We do this so we can have fixtures with stable ids for objects Stripe doesn't
allow us to specify an id for (eg Card).</p>
<p>Fixtures and tests will use the fake ids, when we talk to stripe we use the
real ids
:return:</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">init_fake_id_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a mapping between fake ids stored in Stripe metadata and those obj&#39;s</span>
<span class="sd">    actual ids</span>

<span class="sd">    We do this so we can have fixtures with stable ids for objects Stripe doesn&#39;t</span>
<span class="sd">    allow us to specify an id for (eg Card).</span>

<span class="sd">    Fixtures and tests will use the fake ids, when we talk to stripe we use the</span>
<span class="sd">    real ids</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">fake_customer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_data_map</span><span class="p">[</span><span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># can only access Cards via the customer</span>
            <span class="n">customer</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fake customer </span><span class="si">{</span><span class="n">fake_customer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> doesn&#39;t exist in Stripe yet&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># assume that test customers don&#39;t have more than 100 cards...</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_fake_id_map</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">payment_method</span> <span class="ow">in</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentMethod</span><span class="o">.</span><span class="n">api_list</span><span class="p">(</span>
            <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;card&quot;</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_fake_id_map</span><span class="p">(</span><span class="n">payment_method</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">subscription</span> <span class="ow">in</span> <span class="n">customer</span><span class="p">[</span><span class="s2">&quot;subscriptions&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_fake_id_map</span><span class="p">(</span><span class="n">subscription</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tax_rate</span> <span class="ow">in</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TaxRate</span><span class="o">.</span><span class="n">api_list</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_fake_id_map</span><span class="p">(</span><span class="n">tax_rate</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.pre_process_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">pre_process_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_obj</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pre_process_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_obj</span><span class="p">):</span>
    <span class="c1"># flatten plan/items/tax rates on create</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">create_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="c1"># don&#39;t try and create with both plan and item (list of plans)</span>
        <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;quantity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># TODO - move this to SubscriptionItem handling?</span>
        <span class="n">subscription_item_create_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;billing_thresholds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
            <span class="s2">&quot;quantity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tax_rates&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">create_items</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">create_item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">subscription_item_create_fields</span>
            <span class="p">}</span>

            <span class="n">create_item</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">StripeModel</span><span class="o">.</span><span class="n">_id_from_data</span><span class="p">(</span>
                <span class="n">create_item</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">create_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tax_rates&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">create_item</span><span class="p">[</span><span class="s2">&quot;tax_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">StripeModel</span><span class="o">.</span><span class="n">_id_from_data</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">create_item</span><span class="p">[</span><span class="s2">&quot;tax_rates&quot;</span><span class="p">]</span>
                <span class="p">]</span>

            <span class="n">create_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">create_item</span><span class="p">)</span>

        <span class="n">create_obj</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_items</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># don&#39;t try and send empty items list</span>
        <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">create_obj</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">StripeModel</span><span class="o">.</span><span class="n">_id_from_data</span><span class="p">(</span>
            <span class="n">create_obj</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">create_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_tax_rates&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">create_obj</span><span class="p">[</span><span class="s2">&quot;default_tax_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">StripeModel</span><span class="o">.</span><span class="n">_id_from_data</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">create_obj</span><span class="p">[</span><span class="s2">&quot;default_tax_rates&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># don&#39;t send both default_tax_rates and tax_percent</span>
        <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tax_percent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">create_obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.preserve_old_sideeffect_values" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">preserve_old_sideeffect_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">,</span> <span class="n">object_sideeffect_fields</span><span class="p">,</span> <span class="n">common_sideeffect_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>Try to preserve values of side-effect fields from old_obj,
to reduce churn in fixtures</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">preserve_old_sideeffect_values</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">,</span> <span class="n">object_sideeffect_fields</span><span class="p">,</span> <span class="n">common_sideeffect_fields</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to preserve values of side-effect fields from old_obj,</span>
<span class="sd">    to reduce churn in fixtures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="n">new_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">)</span>
    <span class="n">sideeffect_fields</span> <span class="o">=</span> <span class="n">object_sideeffect_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">common_sideeffect_fields</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">old_obj</span> <span class="o">=</span> <span class="n">old_obj</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">old_val</span> <span class="ow">in</span> <span class="n">old_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_val</span> <span class="o">=</span> <span class="n">new_obj</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">stripe</span><span class="o">.</span><span class="n">api_resources</span><span class="o">.</span><span class="n">ListObject</span><span class="p">):</span>
            <span class="c1"># recursively process nested lists</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">old_val_item</span><span class="p">,</span> <span class="n">new_val_item</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">old_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">new_val</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">new_val</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserve_old_sideeffect_values</span><span class="p">(</span>
                    <span class="n">old_obj</span><span class="o">=</span><span class="n">old_val_item</span><span class="p">,</span>
                    <span class="n">new_obj</span><span class="o">=</span><span class="n">new_val_item</span><span class="p">,</span>
                    <span class="n">object_sideeffect_fields</span><span class="o">=</span><span class="n">object_sideeffect_fields</span><span class="p">,</span>
                    <span class="n">common_sideeffect_fields</span><span class="o">=</span><span class="n">common_sideeffect_fields</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">stripe</span><span class="o">.</span><span class="n">stripe_object</span><span class="o">.</span><span class="n">StripeObject</span><span class="p">):</span>
            <span class="c1"># recursively process nested objects</span>
            <span class="n">new_obj</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserve_old_sideeffect_values</span><span class="p">(</span>
                <span class="n">old_obj</span><span class="o">=</span><span class="n">old_val</span><span class="p">,</span>
                <span class="n">new_obj</span><span class="o">=</span><span class="n">new_val</span><span class="p">,</span>
                <span class="n">object_sideeffect_fields</span><span class="o">=</span><span class="n">object_sideeffect_fields</span><span class="p">,</span>
                <span class="n">common_sideeffect_fields</span><span class="o">=</span><span class="n">common_sideeffect_fields</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">f</span> <span class="ow">in</span> <span class="n">sideeffect_fields</span>
            <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">old_val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">old_val</span> <span class="o">!=</span> <span class="n">new_val</span>
        <span class="p">):</span>
            <span class="c1"># only preserve old values if the type is the same</span>
            <span class="n">new_obj</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_val</span>

    <span class="k">return</span> <span class="n">new_obj</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.save_fixture" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">save_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">type_name</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_fake_id_map</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="n">fixture_path</span> <span class="o">=</span> <span class="n">tests</span><span class="o">.</span><span class="n">FIXTURE_DIR_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">fixture_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_json_ids</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fixture_path</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.unfake_json_ids" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">unfake_json_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_str</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>Replace fake ids with actual ones in the JSON fixture</p>
<p>Do this on the serialized JSON string since it's a simple string replace
:param json_str:
:return:</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">unfake_json_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace fake ids with actual ones in the JSON fixture</span>

<span class="sd">    Do this on the serialized JSON string since it&#39;s a simple string replace</span>
<span class="sd">    :param json_str:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fake_id</span><span class="p">,</span> <span class="n">actual_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_id_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fake_id</span><span class="p">,</span> <span class="n">actual_id</span><span class="p">)</span>

        <span class="c1"># special-case: undo the replace for the djstripe_test_fake_id in metadata</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">FAKE_ID_METADATA_KEY</span><span class="si">}</span><span class="s1">&quot;: &quot;</span><span class="si">{</span><span class="n">actual_id</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">FAKE_ID_METADATA_KEY</span><span class="si">}</span><span class="s1">&quot;: &quot;</span><span class="si">{</span><span class="n">fake_id</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">json_str</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.update_fake_id_map" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">update_fake_id_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_fake_id_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">fake_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fake_id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">actual_id</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fake_id</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fake_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_id_map</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_id_map</span><span class="p">[</span><span class="n">fake_id</span><span class="p">]</span> <span class="o">==</span> <span class="n">actual_id</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Duplicate fake_id </span><span class="si">{</span><span class="n">fake_id</span><span class="si">}</span><span class="s2"> - reset your test Stripe data at &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;https://dashboard.stripe.com/account/data&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fake_id_map</span><span class="p">[</span><span class="n">fake_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_id</span>

        <span class="k">return</span> <span class="n">fake_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">actual_id</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h15 id="tests.apps.example.management.commands.regenerate_test_fixtures.Command.update_fixture_obj" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">regenerate_test_fixtures</span><span class="o">.</span><span class="n">Command</span><span class="o">.</span><span class="n">update_fixture_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_obj</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="p">,</span> <span class="n">do_preserve_sideeffect_fields</span><span class="p">,</span> <span class="n">object_sideeffect_fields</span><span class="p">,</span> <span class="n">common_sideeffect_fields</span><span class="p">)</span></code>


</h15>

    <div class="doc doc-contents ">

      <p>Given a fixture object, update it via stripe
:param model_class:
:param old_obj:
:param readonly_fields:
:return:</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/management/commands/regenerate_test_fixtures.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_fixture_obj</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">old_obj</span><span class="p">,</span>
    <span class="n">model_class</span><span class="p">,</span>
    <span class="n">readonly_fields</span><span class="p">,</span>
    <span class="n">do_preserve_sideeffect_fields</span><span class="p">,</span>
    <span class="n">object_sideeffect_fields</span><span class="p">,</span>
    <span class="n">common_sideeffect_fields</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a fixture object, update it via stripe</span>
<span class="sd">    :param model_class:</span>
<span class="sd">    :param old_obj:</span>
<span class="sd">    :param readonly_fields:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># restore real ids from Stripe</span>
    <span class="n">old_obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unfake_json_ids</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">old_obj</span><span class="p">)))</span>

    <span class="n">id_</span> <span class="o">=</span> <span class="n">old_obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ending</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># For objects that we can&#39;t directly choose the ids of</span>
    <span class="c1"># (and that will thus vary between stripe accounts)</span>
    <span class="c1"># we fetch the id from a related object</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Account</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_account</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="o">=</span><span class="n">readonly_fields</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BankAccount</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_bank_account</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="o">=</span><span class="n">readonly_fields</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Card</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_card</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="o">=</span><span class="n">readonly_fields</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Source</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_source</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">readonly_fields</span><span class="o">=</span><span class="n">readonly_fields</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Invoice</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_invoice</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Charge</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_charge</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentIntent</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_payment_intent</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">PaymentMethod</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_payment_method</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span> <span class="n">writable_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">BalanceTransaction</span><span class="p">):</span>
        <span class="n">created</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_stripe_balance_transaction</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># fetch from Stripe, using the active API version</span>
            <span class="c1"># this allows us regenerate the fixtures from Stripe</span>
            <span class="c1"># and hopefully, automatically get schema changes</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    found&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    creating&quot;</span><span class="p">)</span>

            <span class="n">create_obj</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">old_obj</span><span class="p">)</span>

            <span class="c1"># create in Stripe</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">readonly_fields</span><span class="p">:</span>
                <span class="n">create_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Subscription</span><span class="p">):</span>
                <span class="n">create_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_process_subscription</span><span class="p">(</span><span class="n">create_obj</span><span class="o">=</span><span class="n">create_obj</span><span class="p">)</span>

            <span class="n">obj</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="o">**</span><span class="n">create_obj</span><span class="p">)</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update_fake_id_map</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_preserve_sideeffect_fields</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserve_old_sideeffect_values</span><span class="p">(</span>
            <span class="n">old_obj</span><span class="o">=</span><span class="n">old_obj</span><span class="p">,</span>
            <span class="n">new_obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span>
            <span class="n">object_sideeffect_fields</span><span class="o">=</span><span class="n">object_sideeffect_fields</span><span class="p">,</span>
            <span class="n">common_sideeffect_fields</span><span class="o">=</span><span class="n">common_sideeffect_fields</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">created</span><span class="p">,</span> <span class="n">obj</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h7 id="tests.apps.example.urls" class="doc doc-heading">
        <code>tests.apps.example.urls</code>



</h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.example.urls.app_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">app_name</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.example.urls.urlpatterns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">urlpatterns</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>








  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h7 id="tests.apps.example.views" class="doc doc-heading">
        <code>tests.apps.example.views</code>



</h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.example.views.User" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">User</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.example.views.logger" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">logger</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>


<h8 id="tests.apps.example.views-classes">Classes</h8>

  <div class="doc doc-object doc-class">



<h9 id="tests.apps.example.views.PurchaseSubscriptionSuccessView" class="doc doc-heading">
        <code>
tests.apps.example.views.PurchaseSubscriptionSuccessView        </code>



</h9>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.views.PurchaseSubscriptionSuccessView.context_object_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionSuccessView</span><span class="o">.</span><span class="n">context_object_name</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.views.PurchaseSubscriptionSuccessView.queryset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionSuccessView</span><span class="o">.</span><span class="n">queryset</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.views.PurchaseSubscriptionSuccessView.slug_field" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionSuccessView</span><span class="o">.</span><span class="n">slug_field</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.views.PurchaseSubscriptionSuccessView.slug_url_kwarg" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionSuccessView</span><span class="o">.</span><span class="n">slug_url_kwarg</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.views.PurchaseSubscriptionSuccessView.template_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionSuccessView</span><span class="o">.</span><span class="n">template_name</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>








  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h9 id="tests.apps.example.views.PurchaseSubscriptionView" class="doc doc-heading">
        <code>
tests.apps.example.views.PurchaseSubscriptionView        </code>



</h9>

    <div class="doc doc-contents ">

      <p>Example view to demonstrate how to use dj-stripe to:</p>
<ul>
<li>create a Customer</li>
<li>add a card to the Customer</li>
<li>create a Subscription using that card</li>
</ul>
<p>This does a non-logged in purchase for the user of the provided email</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.example.views.PurchaseSubscriptionView.template_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionView</span><span class="o">.</span><span class="n">template_name</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h11 id="tests.apps.example.views.PurchaseSubscriptionView.form_class" class="doc doc-heading">
        <code>
tests.apps.example.views.PurchaseSubscriptionView.form_class        </code>



</h11>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h13 id="tests.apps.example.views.PurchaseSubscriptionView.form_class.media" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionView</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">media</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h13>

    <div class="doc doc-contents ">

    </div>

  </div>








  </div>

    </div>

  </div>



<h10 id="tests.apps.example.views.PurchaseSubscriptionView-methods">Methods</h10>

  <div class="doc doc-object doc-method">



<h11 id="tests.apps.example.views.PurchaseSubscriptionView.form_valid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionView</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span></code>


</h11>

    <div class="doc doc-contents ">

      <p>If the form is valid, redirect to the supplied URL.</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">stripe_source</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;stripe_source&quot;</span><span class="p">]</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span>

    <span class="c1"># Guest checkout with the provided email</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>

    <span class="c1"># Create the stripe Customer, by default subscriber Model is User,</span>
    <span class="c1"># this can be overridden with settings.DJSTRIPE_SUBSCRIBER_MODEL</span>
    <span class="n">customer</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Add the source as the customer&#39;s default card</span>
    <span class="n">customer</span><span class="o">.</span><span class="n">add_card</span><span class="p">(</span><span class="n">stripe_source</span><span class="p">)</span>

    <span class="c1"># Using the Stripe API, create a subscription for this customer,</span>
    <span class="c1"># using the customer&#39;s default payment source</span>
    <span class="n">stripe_subscription</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">Subscription</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">}],</span>
        <span class="n">collection_method</span><span class="o">=</span><span class="s2">&quot;charge_automatically&quot;</span><span class="p">,</span>
        <span class="c1"># tax_percent=15,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">djstripe</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Sync the Stripe API return data to the database,</span>
    <span class="c1"># this way we don&#39;t need to wait for a webhook-triggered sync</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span>
        <span class="n">stripe_subscription</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">subscription</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h11 id="tests.apps.example.views.PurchaseSubscriptionView.get_context_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionView</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h11>

    <div class="doc doc-contents ">

      <p>Insert the form into the context dict.</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;No Product Plans in the dj-stripe database - create some in your &quot;</span>
            <span class="s2">&quot;stripe account and then &quot;</span>
            <span class="s2">&quot;run `./manage.py djstripe_sync_plans_from_stripe` &quot;</span>
            <span class="s2">&quot;(or use the dj-stripe webhooks)&quot;</span>
        <span class="p">)</span>

    <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;STRIPE_PUBLIC_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_PUBLIC_KEY</span>

    <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h11 id="tests.apps.example.views.PurchaseSubscriptionView.get_success_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">PurchaseSubscriptionView</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h11>

    <div class="doc doc-contents ">

      <p>Return the URL to redirect to after processing a valid form.</p>

        <details class="quote">
          <summary>Source code in <code>tests/apps/example/views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
        <span class="s2">&quot;djstripe_example:purchase_subscription_success&quot;</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h9 id="tests.apps.example.views.create_payment_intent" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">create_payment_intent</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/example/views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_payment_intent</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">intent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;payment_method_id&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># Create the PaymentIntent</span>
                <span class="n">intent</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">PaymentIntent</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">payment_method</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;payment_method_id&quot;</span><span class="p">],</span>
                    <span class="n">amount</span><span class="o">=</span><span class="mi">1099</span><span class="p">,</span>
                    <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
                    <span class="n">confirmation_method</span><span class="o">=</span><span class="s2">&quot;manual&quot;</span><span class="p">,</span>
                    <span class="n">confirm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">djstripe</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;payment_intent_id&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">intent</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">PaymentIntent</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;payment_intent_id&quot;</span><span class="p">],</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">djstripe</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">stripe</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">CardError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Display error on client</span>
            <span class="n">return_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">user_message</span><span class="p">}),</span> <span class="mi">200</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
                <span class="n">return_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">return_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">intent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;requires_action&quot;</span>
            <span class="ow">and</span> <span class="n">intent</span><span class="o">.</span><span class="n">next_action</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;use_stripe_sdk&quot;</span>
        <span class="p">):</span>
            <span class="c1"># Tell the client to handle the action</span>
            <span class="n">return_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;requires_action&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;payment_intent_client_secret&quot;</span><span class="p">:</span> <span class="n">intent</span><span class="o">.</span><span class="n">client_secret</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
                <span class="mi">200</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">intent</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;succeeded&quot;</span><span class="p">:</span>
            <span class="c1"># The payment did not need any additional actions and completed!</span>
            <span class="c1"># Handle post-payment fulfillment</span>
            <span class="n">return_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Invalid status</span>
            <span class="n">return_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid PaymentIntent status&quot;</span><span class="p">}),</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
            <span class="n">return_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">return_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;STRIPE_PUBLIC_KEY&quot;</span><span class="p">:</span> <span class="n">djstripe</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_PUBLIC_KEY</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">TemplateResponse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;payment_intent.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tests.apps.testapp" class="doc doc-heading">
        <code>tests.apps.testapp</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








<h6 id="tests.apps.testapp-modules">Modules</h6>

  <div class="doc doc-object doc-module">



<h7 id="tests.apps.testapp.models" class="doc doc-heading">
        <code>tests.apps.testapp.models</code>



</h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">





<h8 id="tests.apps.testapp.models-classes">Classes</h8>

  <div class="doc doc-object doc-class">



<h9 id="tests.apps.testapp.models.NoEmailOrganization" class="doc doc-heading">
        <code>
tests.apps.testapp.models.NoEmailOrganization        </code>



</h9>

    <div class="doc doc-contents ">

      <p>Model used to test the new custom model setting.</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.testapp.models.NoEmailOrganization.name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">NoEmailOrganization</span><span class="o">.</span><span class="n">name</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h11 id="tests.apps.testapp.models.NoEmailOrganization.DoesNotExist" class="doc doc-heading">
        <code>
tests.apps.testapp.models.NoEmailOrganization.DoesNotExist        </code>



</h11>

    <div class="doc doc-contents ">




    </div>

  </div>



  <div class="doc doc-object doc-class">



<h11 id="tests.apps.testapp.models.NoEmailOrganization.MultipleObjectsReturned" class="doc doc-heading">
        <code>
tests.apps.testapp.models.NoEmailOrganization.MultipleObjectsReturned        </code>



</h11>

    <div class="doc doc-contents ">




    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h9 id="tests.apps.testapp.models.Organization" class="doc doc-heading">
        <code>
tests.apps.testapp.models.Organization        </code>



</h9>

    <div class="doc doc-contents ">

      <p>Model used to test the new custom model setting.</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.testapp.models.Organization.email" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Organization</span><span class="o">.</span><span class="n">email</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h11 id="tests.apps.testapp.models.Organization.DoesNotExist" class="doc doc-heading">
        <code>
tests.apps.testapp.models.Organization.DoesNotExist        </code>



</h11>

    <div class="doc doc-contents ">




    </div>

  </div>



  <div class="doc doc-object doc-class">



<h11 id="tests.apps.testapp.models.Organization.MultipleObjectsReturned" class="doc doc-heading">
        <code>
tests.apps.testapp.models.Organization.MultipleObjectsReturned        </code>



</h11>

    <div class="doc doc-contents ">




    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h9 id="tests.apps.testapp.models.StaticEmailOrganization" class="doc doc-heading">
        <code>
tests.apps.testapp.models.StaticEmailOrganization        </code>



</h9>

    <div class="doc doc-contents ">

      <p>Model used to test the new custom model setting.</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.testapp.models.StaticEmailOrganization.email" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">StaticEmailOrganization</span><span class="o">.</span><span class="n">email</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h11>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h11 id="tests.apps.testapp.models.StaticEmailOrganization.name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">StaticEmailOrganization</span><span class="o">.</span><span class="n">name</span></code>


</h11>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h11 id="tests.apps.testapp.models.StaticEmailOrganization.DoesNotExist" class="doc doc-heading">
        <code>
tests.apps.testapp.models.StaticEmailOrganization.DoesNotExist        </code>



</h11>

    <div class="doc doc-contents ">




    </div>

  </div>



  <div class="doc doc-object doc-class">



<h11 id="tests.apps.testapp.models.StaticEmailOrganization.MultipleObjectsReturned" class="doc doc-heading">
        <code>
tests.apps.testapp.models.StaticEmailOrganization.MultipleObjectsReturned        </code>



</h11>

    <div class="doc doc-contents ">




    </div>

  </div>







  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h7 id="tests.apps.testapp.urls" class="doc doc-heading">
        <code>tests.apps.testapp.urls</code>



</h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.testapp.urls.urlpatterns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">urlpatterns</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>





  <div class="doc doc-object doc-function">



<h9 id="tests.apps.testapp.urls.empty_view" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">empty_view</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/testapp/urls.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">empty_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tests.apps.testapp_content" class="doc doc-heading">
        <code>tests.apps.testapp_content</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








<h6 id="tests.apps.testapp_content-modules">Modules</h6>

  <div class="doc doc-object doc-module">



<h7 id="tests.apps.testapp_content.models" class="doc doc-heading">
        <code>tests.apps.testapp_content.models</code>



</h7>

    <div class="doc doc-contents ">



    </div>

  </div>



  <div class="doc doc-object doc-module">



<h7 id="tests.apps.testapp_content.urls" class="doc doc-heading">
        <code>tests.apps.testapp_content.urls</code>



</h7>

    <div class="doc doc-contents ">

      <p>Represents protected content</p>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.testapp_content.urls.urlpatterns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp_content</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">urlpatterns</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>





  <div class="doc doc-object doc-function">



<h9 id="tests.apps.testapp_content.urls.testview" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp_content</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">testview</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/testapp_content/urls.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">testview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tests.apps.testapp_namespaced" class="doc doc-heading">
        <code>tests.apps.testapp_namespaced</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h7 id="tests.apps.testapp_namespaced.models" class="doc doc-heading">
        <code>tests.apps.testapp_namespaced.models</code>



</h7>

    <div class="doc doc-contents ">



    </div>

  </div>



  <div class="doc doc-object doc-module">



<h7 id="tests.apps.testapp_namespaced.urls" class="doc doc-heading">
        <code>tests.apps.testapp_namespaced.urls</code>



</h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.testapp_namespaced.urls.app_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp_namespaced</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">app_name</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h9 id="tests.apps.testapp_namespaced.urls.urlpatterns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp_namespaced</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">urlpatterns</span></code>


</h9>

    <div class="doc doc-contents ">

    </div>

  </div>





  <div class="doc doc-object doc-function">



<h9 id="tests.apps.testapp_namespaced.urls.testview" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">testapp_namespaced</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">testview</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/apps/testapp_namespaced/urls.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">testview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.settings" class="doc doc-heading">
        <code>tests.settings</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.ALLOWED_HOSTS" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">ALLOWED_HOSTS</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.BASE_DIR" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DEBUG" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DEFAULT_AUTO_FIELD" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_AUTO_FIELD</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DJSTRIPE_FOREIGN_KEY_TO_FIELD" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DJSTRIPE_FOREIGN_KEY_TO_FIELD</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DJSTRIPE_SUBSCRIPTION_REDIRECT" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DJSTRIPE_SUBSCRIPTION_REDIRECT</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DJSTRIPE_SUBSCRIPTION_REQUIRED_EXCEPTION_URLS" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DJSTRIPE_SUBSCRIPTION_REQUIRED_EXCEPTION_URLS</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DJSTRIPE_USE_NATIVE_JSONFIELD" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DJSTRIPE_USE_NATIVE_JSONFIELD</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DJSTRIPE_WEBHOOK_SECRET" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DJSTRIPE_WEBHOOK_SECRET</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.DJSTRIPE_WEBHOOK_VALIDATION" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DJSTRIPE_WEBHOOK_VALIDATION</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.INSTALLED_APPS" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.MIDDLEWARE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIDDLEWARE</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.PROJECT_DIR" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">PROJECT_DIR</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.ROOT_URLCONF" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">ROOT_URLCONF</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.SECRET_KEY" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">SECRET_KEY</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.SITE_ID" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">SITE_ID</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.STATIC_URL" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STATIC_URL</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.STRIPE_LIVE_PUBLIC_KEY" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_LIVE_PUBLIC_KEY</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.STRIPE_LIVE_SECRET_KEY" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_LIVE_SECRET_KEY</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.STRIPE_TEST_PUBLIC_KEY" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_TEST_PUBLIC_KEY</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.STRIPE_TEST_SECRET_KEY" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_TEST_SECRET_KEY</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.TEMPLATES" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">TEMPLATES</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.TIME_ZONE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">TIME_ZONE</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.USE_TZ" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USE_TZ</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.test_db_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">test_db_name</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.test_db_pass" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">test_db_pass</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.test_db_port" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">test_db_port</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.test_db_user" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">test_db_user</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.settings.test_db_vendor" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">test_db_vendor</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>








  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_account" class="doc doc-heading">
        <code>tests.test_account</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Account Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_account-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_account.TestAccount" class="doc doc-heading">
        <code>
tests.test_account.TestAccount        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_account.TestAccount.test_get_connected_account_from_token" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">TestAccount</span><span class="o">.</span><span class="n">test_get_connected_account_from_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">)],</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_connected_account_from_token</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_ACCOUNT</span><span class="p">)</span>

    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">get_connected_account_from_token</span><span class="p">(</span><span class="s2">&quot;fake_token&quot;</span><span class="p">)</span>

    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;fake_token&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_account.TestAccount.test_get_default_account" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">TestAccount</span><span class="o">.</span><span class="n">test_get_default_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">)],</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_default_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">):</span>
    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_ACCOUNT</span><span class="p">)</span>

    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">get_default_account</span><span class="p">()</span>

    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">business_profile</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">settings</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">branding_icon</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">branding_logo</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;branding&quot;</span><span class="p">][</span><span class="s2">&quot;icon&quot;</span><span class="p">],</span> <span class="n">account</span><span class="o">.</span><span class="n">branding_icon</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;branding&quot;</span><span class="p">][</span><span class="s2">&quot;logo&quot;</span><span class="p">],</span> <span class="n">account</span><span class="o">.</span><span class="n">branding_logo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">branding_logo</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">account</span><span class="o">.</span><span class="n">branding_icon</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">business_url</span><span class="p">,</span> <span class="s2">&quot;https://example.com&quot;</span><span class="p">)</span>
    <span class="n">account</span><span class="o">.</span><span class="n">business_profile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">business_url</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_account.TestAccount.test_get_default_account_null_logo" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">TestAccount</span><span class="o">.</span><span class="n">test_get_default_account_null_logo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_default_account_null_logo</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_account</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_ACCOUNT</span><span class="p">)</span>
    <span class="n">fake_account</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span><span class="s2">&quot;branding&quot;</span><span class="p">][</span><span class="s2">&quot;icon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fake_account</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span><span class="s2">&quot;branding&quot;</span><span class="p">][</span><span class="s2">&quot;logo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_account</span>

    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">get_default_account</span><span class="p">()</span>

    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">account</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_account.TestAccountRestrictedKeys" class="doc doc-heading">
        <code>
tests.test_account.TestAccountRestrictedKeys        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_account.TestAccountRestrictedKeys-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_account.TestAccountRestrictedKeys.tearDown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">TestAccountRestrictedKeys</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for deconstructing the test fixture after testing it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_account.TestAccountRestrictedKeys.test_account_str_restricted_key" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">TestAccountRestrictedKeys</span><span class="o">.</span><span class="n">test_account_str_restricted_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Test that we do not attempt to retrieve account ID with restricted keys.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">STRIPE_TEST_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;rk_test_blah&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_TEST_PUBLIC_KEY</span><span class="o">=</span><span class="s2">&quot;pk_test_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_MODE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_account_str_restricted_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that we do not attempt to retrieve account ID with restricted keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span> <span class="o">==</span> <span class="s2">&quot;rk_test_blah&quot;</span>

    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">get_default_account</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">account</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>


<h4 id="tests.test_account-functions">Functions</h4>

  <div class="doc doc-object doc-function">



<h5 id="tests.test_account.test__str__null_settings_null_business_profile" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">test__str__null_settings_null_business_profile</span><span class="p">()</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Test that <strong>str</strong> doesn't crash when settings and business_profile are NULL.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test__str__null_settings_null_business_profile</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test that __str__ doesn&#39;t crash when settings and business_profile are NULL.&quot;&quot;&quot;</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
    <span class="n">account</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">account</span><span class="o">.</span><span class="n">business_profile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">account</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&lt;id=&gt;&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="tests.test_account.test_account__create_from_stripe_object" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">test_account__create_from_stripe_object</span><span class="p">(</span><span class="n">mock_super__create_from_stripe_object</span><span class="p">,</span> <span class="n">mock_account_id</span><span class="p">,</span> <span class="n">other_mock_account_id</span><span class="p">,</span> <span class="n">expected_stripe_account</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Ensure that we are setting the ID value correctly.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;mock_account_id, other_mock_account_id, expected_stripe_account&quot;</span><span class="p">,</span>
    <span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;acct_fakefakefakefake001&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;acct_fakefakefakefake001&quot;</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;acct_fakefakefakefake001&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acct_fakefakefakefake002&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acct_fakefakefakefake002&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="s2">&quot;djstripe.models.connect.StripeModel._create_from_stripe_object&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_account__create_from_stripe_object</span><span class="p">(</span>
    <span class="n">mock_super__create_from_stripe_object</span><span class="p">,</span>
    <span class="n">mock_account_id</span><span class="p">,</span>
    <span class="n">other_mock_account_id</span><span class="p">,</span>
    <span class="n">expected_stripe_account</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure that we are setting the ID value correctly.&quot;&quot;&quot;</span>
    <span class="n">mock_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">mock_account_id</span><span class="p">}</span>
    <span class="n">Account</span><span class="o">.</span><span class="n">_create_from_stripe_object</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">mock_data</span><span class="p">,</span> <span class="n">stripe_account</span><span class="o">=</span><span class="n">other_mock_account_id</span>
    <span class="p">)</span>

    <span class="n">mock_super__create_from_stripe_object</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">mock_data</span><span class="p">,</span>
        <span class="n">current_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pending_relations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="n">expected_stripe_account</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="tests.test_account.test_account_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_account</span><span class="o">.</span><span class="n">test_account_str</span><span class="p">(</span><span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">,</span> <span class="n">business_profile_update</span><span class="p">,</span> <span class="n">settings_dashboard_update</span><span class="p">,</span> <span class="n">expected_account_str</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="p">(</span><span class="s2">&quot;business_profile_update&quot;</span><span class="p">,</span> <span class="s2">&quot;settings_dashboard_update&quot;</span><span class="p">,</span> <span class="s2">&quot;expected_account_str&quot;</span><span class="p">),</span>
    <span class="p">(</span>
        <span class="p">({},</span> <span class="p">{},</span> <span class="s2">&quot;dj-stripe&quot;</span><span class="p">),</span>
        <span class="p">({},</span> <span class="p">{</span><span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;some display name&quot;</span><span class="p">},</span> <span class="s2">&quot;some display name&quot;</span><span class="p">),</span>
        <span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;some business name&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span> <span class="s2">&quot;some business name&quot;</span><span class="p">),</span>
        <span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span> <span class="s2">&quot;&lt;id=acct_1032D82eZvKYlo2C&gt;&quot;</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_account_str</span><span class="p">(</span>
    <span class="n">fileupload_retrieve_mock</span><span class="p">,</span>
    <span class="n">account_retrieve_mock</span><span class="p">,</span>
    <span class="n">business_profile_update</span><span class="p">,</span>
    <span class="n">settings_dashboard_update</span><span class="p">,</span>
    <span class="n">expected_account_str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">fake_account</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_ACCOUNT</span><span class="p">)</span>
    <span class="n">fake_account</span><span class="p">[</span><span class="s2">&quot;business_profile&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">business_profile_update</span><span class="p">)</span>
    <span class="n">fake_account</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span><span class="s2">&quot;dashboard&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings_dashboard_update</span><span class="p">)</span>
    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_account</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">get_default_account</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">account</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_account_str</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_admin" class="doc doc-heading">
        <code>tests.test_admin</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Admin Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_admin-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_admin.TestAdminSite" class="doc doc-heading">
        <code>
tests.test_admin.TestAdminSite        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_admin.TestAdminSite-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_admin.TestAdminSite.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_admin</span><span class="o">.</span><span class="n">TestAdminSite</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_admin.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_admin.TestAdminSite.test_search_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_admin</span><span class="o">.</span><span class="n">TestAdminSite</span><span class="o">.</span><span class="n">test_search_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Search for errors like this:
Bad search field <customer__user__username> for Customer model.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_admin.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_search_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for errors like this:</span>
<span class="sd">    Bad search field &lt;customer__user__username&gt; for Customer model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">_model</span><span class="p">,</span> <span class="n">model_admin</span> <span class="ow">in</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">search_field</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_admin</span><span class="p">,</span> <span class="s2">&quot;search_fields&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_admin</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
                <span class="n">search_field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{table_name}</span><span class="s2">__&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="p">),</span>
                <span class="s2">&quot;Bad search field &lt;</span><span class="si">{search_field}</span><span class="s2">&gt; for </span><span class="si">{model_name}</span><span class="s2"> model.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">search_field</span><span class="o">=</span><span class="n">search_field</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span>
                <span class="p">),</span>
            <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_api_keys" class="doc doc-heading">
        <code>tests.test_api_keys</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">





<h4 id="tests.test_api_keys-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_api_keys.TestCheckApiKeySettings" class="doc doc-heading">
        <code>
tests.test_api_keys.TestCheckApiKeySettings        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_api_keys.TestCheckApiKeySettings-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_api_keys.TestCheckApiKeySettings.tearDown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_api_keys</span><span class="o">.</span><span class="n">TestCheckApiKeySettings</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for deconstructing the test fixture after testing it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_api_keys.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_api_keys.TestCheckApiKeySettings.test_api_key_live_mode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_api_keys</span><span class="o">.</span><span class="n">TestCheckApiKeySettings</span><span class="o">.</span><span class="n">test_api_key_live_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_api_keys.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">STRIPE_TEST_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_test_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_live_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_TEST_PUBLIC_KEY</span><span class="o">=</span><span class="s2">&quot;pk_test_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_PUBLIC_KEY</span><span class="o">=</span><span class="s2">&quot;pk_live_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_MODE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_key_live_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_TEST_SECRET_KEY</span>
    <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_PUBLIC_KEY</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_TEST_PUBLIC_KEY</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_LIVE_MODE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_live_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_PUBLIC_KEY</span><span class="p">,</span> <span class="s2">&quot;pk_live_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">LIVE_API_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_live_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Account</span><span class="p">(</span><span class="n">livemode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">default_api_key</span><span class="p">,</span> <span class="s2">&quot;sk_live_foo&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_api_keys.TestCheckApiKeySettings.test_global_api_keys_live_mode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_api_keys</span><span class="o">.</span><span class="n">TestCheckApiKeySettings</span><span class="o">.</span><span class="n">test_global_api_keys_live_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_api_keys.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">STRIPE_LIVE_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_live_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_PUBLIC_KEY</span><span class="o">=</span><span class="s2">&quot;sk_live_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_MODE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_global_api_keys_live_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_LIVE_MODE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_live_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">LIVE_API_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_live_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Account</span><span class="p">(</span><span class="n">livemode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">default_api_key</span><span class="p">,</span> <span class="s2">&quot;sk_live_foo&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_api_keys.TestCheckApiKeySettings.test_global_api_keys_test_mode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_api_keys</span><span class="o">.</span><span class="n">TestCheckApiKeySettings</span><span class="o">.</span><span class="n">test_global_api_keys_test_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_api_keys.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">STRIPE_TEST_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_test_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_TEST_PUBLIC_KEY</span><span class="o">=</span><span class="s2">&quot;pk_test_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_MODE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_global_api_keys_test_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_LIVE_MODE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_test_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">TEST_API_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_test_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Account</span><span class="p">(</span><span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">default_api_key</span><span class="p">,</span> <span class="s2">&quot;sk_test_foo&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_api_keys.TestCheckApiKeySettings.test_secret_key_test_mode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_api_keys</span><span class="o">.</span><span class="n">TestCheckApiKeySettings</span><span class="o">.</span><span class="n">test_secret_key_test_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_api_keys.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">STRIPE_TEST_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_test_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_live_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_TEST_PUBLIC_KEY</span><span class="o">=</span><span class="s2">&quot;pk_test_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_PUBLIC_KEY</span><span class="o">=</span><span class="s2">&quot;pk_live_foo&quot;</span><span class="p">,</span>
    <span class="n">STRIPE_LIVE_MODE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_secret_key_test_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span>
    <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_PUBLIC_KEY</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_LIVE_MODE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_test_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_PUBLIC_KEY</span><span class="p">,</span> <span class="s2">&quot;pk_test_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">TEST_API_KEY</span><span class="p">,</span> <span class="s2">&quot;sk_test_foo&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Account</span><span class="p">(</span><span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">default_api_key</span><span class="p">,</span> <span class="s2">&quot;sk_test_foo&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_apikey" class="doc doc-heading">
        <code>tests.test_apikey</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe APIKey model tests</p>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tests.test_apikey.PK_LIVE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">PK_LIVE</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.test_apikey.PK_TEST" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">PK_TEST</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.test_apikey.RK_LIVE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">RK_LIVE</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.test_apikey.RK_TEST" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">RK_TEST</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.test_apikey.SK_LIVE" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">SK_LIVE</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tests.test_apikey.SK_TEST" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">SK_TEST</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>


<h4 id="tests.test_apikey-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_apikey.APIKeyTest" class="doc doc-heading">
        <code>
tests.test_apikey.APIKeyTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_apikey.APIKeyTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_apikey.APIKeyTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">APIKeyTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span> <span class="o">=</span> <span class="n">APIKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test Secret Key&quot;</span><span class="p">,</span>
        <span class="n">secret</span><span class="o">=</span><span class="n">SK_TEST</span><span class="p">,</span>
        <span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">djstripe_owner_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apikey_live</span> <span class="o">=</span> <span class="n">APIKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Live Secret Key&quot;</span><span class="p">,</span>
        <span class="n">secret</span><span class="o">=</span><span class="n">SK_LIVE</span><span class="p">,</span>
        <span class="n">livemode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">djstripe_owner_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_apikey.APIKeyTest.test_get_account_by_api_key" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">APIKeyTest</span><span class="o">.</span><span class="n">test_get_account_by_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_account_by_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">get_or_retrieve_for_api_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">secret</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_apikey.APIKeyTest.test_get_stripe_dashboard_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">APIKeyTest</span><span class="o">.</span><span class="n">test_get_stripe_dashboard_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_stripe_dashboard_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span>
        <span class="s2">&quot;https://dashboard.stripe.com/acct_TESTXXXXX/test/apikeys&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apikey_live</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span>
        <span class="s2">&quot;https://dashboard.stripe.com/acct_TESTXXXXX/apikeys&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_apikey.APIKeyTest.test_refresh_account" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">APIKeyTest</span><span class="o">.</span><span class="n">test_refresh_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_ACCOUNT</span><span class="p">),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_refresh_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">djstripe_owner_account</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">djstripe_owner_account</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">FAKE_ACCOUNT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_apikey.APIKeyTest.test_secret_not_in_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">APIKeyTest</span><span class="o">.</span><span class="n">test_secret_not_in_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_secret_not_in_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">secret</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">apikey_live</span><span class="o">.</span><span class="n">secret</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey_live</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_apikey.APIKeyTest.test_secret_redacted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">APIKeyTest</span><span class="o">.</span><span class="n">test_secret_redacted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_secret_redacted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey_test</span><span class="o">.</span><span class="n">secret_redacted</span><span class="p">,</span> <span class="s2">&quot;sk_test_...1234&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey_live</span><span class="o">.</span><span class="n">secret_redacted</span><span class="p">,</span> <span class="s2">&quot;sk_live_...5678&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="tests.test_apikey.test_apikey_detect_livemode_and_type" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">test_apikey_detect_livemode_and_type</span><span class="p">(</span><span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_ACCOUNT</span><span class="p">))</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_apikey_detect_livemode_and_type</span><span class="p">(</span>
    <span class="n">fileupload_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">keys_and_values</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PK_TEST</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">APIKeyType</span><span class="o">.</span><span class="n">publishable</span><span class="p">),</span>
        <span class="p">(</span><span class="n">RK_TEST</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">APIKeyType</span><span class="o">.</span><span class="n">restricted</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SK_TEST</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">APIKeyType</span><span class="o">.</span><span class="n">secret</span><span class="p">),</span>
        <span class="p">(</span><span class="n">PK_LIVE</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">APIKeyType</span><span class="o">.</span><span class="n">publishable</span><span class="p">),</span>
        <span class="p">(</span><span class="n">RK_LIVE</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">APIKeyType</span><span class="o">.</span><span class="n">restricted</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SK_LIVE</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">APIKeyType</span><span class="o">.</span><span class="n">secret</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">secret</span><span class="p">,</span> <span class="n">livemode</span><span class="p">,</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">keys_and_values</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">APIKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">key</span><span class="o">.</span><span class="n">livemode</span> <span class="ow">is</span> <span class="n">livemode</span>
        <span class="k">assert</span> <span class="n">key</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">type</span>
        <span class="n">key</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">key</span><span class="o">.</span><span class="n">livemode</span> <span class="ow">is</span> <span class="n">livemode</span>
        <span class="k">assert</span> <span class="n">key</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">type</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="tests.test_apikey.test_clean_public_apikey" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">test_clean_public_apikey</span><span class="p">()</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_clean_public_apikey</span><span class="p">():</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">APIKey</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">publishable</span><span class="p">,</span> <span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="n">PK_TEST</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">djstripe_owner_account</span>
    <span class="n">key</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">djstripe_owner_account</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="tests.test_apikey.test_get_api_key_details_by_prefix" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">test_get_api_key_details_by_prefix</span><span class="p">()</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_api_key_details_by_prefix</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="n">SK_TEST</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="n">SK_LIVE</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="n">RK_TEST</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">restricted</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="n">RK_LIVE</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">restricted</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="n">PK_TEST</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">publishable</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="n">PK_LIVE</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">APIKeyType</span><span class="o">.</span><span class="n">publishable</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="tests.test_apikey.test_get_api_key_details_by_prefix_bad_values" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_apikey</span><span class="o">.</span><span class="n">test_get_api_key_details_by_prefix_bad_values</span><span class="p">()</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_apikey.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_api_key_details_by_prefix_bad_values</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="s2">&quot;pk_a&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="s2">&quot;sk_a&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">get_api_key_details_by_prefix</span><span class="p">(</span><span class="s2">&quot;rk_nope_1234&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_bank_account" class="doc doc-heading">
        <code>tests.test_bank_account</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Bank Account Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_bank_account-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_bank_account.BankAccountTest" class="doc doc-heading">
        <code>
tests.test_bank_account.BankAccountTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_bank_account.BankAccountTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;djstripe@example.com&quot;</span>
    <span class="p">)</span>
    <span class="n">fake_empty_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">)</span>
    <span class="n">fake_empty_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fake_empty_customer</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">fake_empty_customer</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.test_api_call_bad_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">test_api_call_bad_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_api_call_bad_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">exception_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;BankAccounts must be manipulated through a Customer. &quot;</span>
        <span class="s2">&quot;Pass a Customer object into this call.&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">BankAccount</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="s2">&quot;fish&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">BankAccount</span><span class="o">.</span><span class="n">api_list</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="s2">&quot;fish&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.test_api_call_no_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">test_api_call_no_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_api_call_no_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">exception_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;BankAccounts must be manipulated through a Customer. &quot;</span>
        <span class="s2">&quot;Pass a Customer object into this call.&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">BankAccount</span><span class="o">.</span><span class="n">_api_create</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">BankAccount</span><span class="o">.</span><span class="n">api_list</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.test_api_create" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">test_api_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">stripe_bank_account</span> <span class="o">=</span> <span class="n">BankAccount</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">,</span> <span class="n">stripe_bank_account</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.test_api_list" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">test_api_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">bank_account_list</span> <span class="o">=</span> <span class="n">BankAccount</span><span class="o">.</span><span class="n">api_list</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bank_account_list</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.test_create_bank_account_finds_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">test_create_bank_account_finds_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_create_bank_account_finds_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">bank_account</span> <span class="o">=</span> <span class="n">BankAccount</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">bank_account</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">bank_account</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">bank_account</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.BankAccount.account&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.test_remove" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">test_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">bank_account_retrieve_mock</span><span class="p">,</span> <span class="n">bank_account_delete_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;tests.BankAccountDict.delete&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BankAccount.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">bank_account_retrieve_mock</span><span class="p">,</span>
    <span class="n">bank_account_delete_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">stripe_bank_account</span> <span class="o">=</span> <span class="n">BankAccount</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">BankAccount</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_bank_account</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">bank_account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bank_account</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">bank_account_delete_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_bank_account.BankAccountTest.test_remove_already_deleted_card" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_bank_account</span><span class="o">.</span><span class="n">BankAccountTest</span><span class="o">.</span><span class="n">test_remove_already_deleted_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_bank_account.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove_already_deleted_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">stripe_bank_account</span> <span class="o">=</span> <span class="n">BankAccount</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_BANK_ACCOUNT_SOURCE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">BankAccount</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_bank_account</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bank_account_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">BankAccount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">stripe_bank_account</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">bank_account_object</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_card" class="doc doc-heading">
        <code>tests.test_card</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Card Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_card-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_card.CardTest" class="doc doc-heading">
        <code>
tests.test_card.CardTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_card.CardTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;djstripe@example.com&quot;</span>
    <span class="p">)</span>
    <span class="n">fake_empty_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_empty_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fake_empty_customer</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">fake_empty_customer</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_api_call_bad_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_api_call_bad_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_api_call_bad_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">exception_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Cards must be manipulated through a Customer. &quot;</span>
        <span class="s2">&quot;Pass a Customer object into this call.&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="s2">&quot;fish&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">Card</span><span class="o">.</span><span class="n">api_list</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="s2">&quot;fish&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_api_call_no_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_api_call_no_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_api_call_no_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">exception_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Cards must be manipulated through a Customer. &quot;</span>
        <span class="s2">&quot;Pass a Customer object into this call.&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">StripeObjectManipulationException</span><span class="p">,</span> <span class="n">exception_message</span>
    <span class="p">):</span>
        <span class="n">Card</span><span class="o">.</span><span class="n">api_list</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_api_create" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_api_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">stripe_card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">,</span> <span class="n">stripe_card</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_api_list" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_api_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">card_list</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">api_list</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">FAKE_CARD</span><span class="p">,</span> <span class="n">FAKE_CARD_V</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">card_list</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_attach_objects_hook_without_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_attach_objects_hook_without_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_attach_objects_hook_without_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_III</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_card_create_token" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_card_create_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Token.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_card_create_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_create_mock</span><span class="p">):</span>
    <span class="n">card</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="s2">&quot;4242&quot;</span><span class="p">,</span> <span class="s2">&quot;exp_month&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;exp_year&quot;</span><span class="p">:</span> <span class="mi">2012</span><span class="p">,</span> <span class="s2">&quot;cvc&quot;</span><span class="p">:</span> <span class="mi">445</span><span class="p">}</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">create_token</span><span class="p">(</span><span class="o">**</span><span class="n">card</span><span class="p">)</span>

    <span class="n">token_create_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">card</span><span class="o">=</span><span class="n">card</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_create_card_finds_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_create_card_finds_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_create_card_finds_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">card</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">card</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.BankAccount.account&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_source&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_remove" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;tests.CardDict.delete&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Card.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span><span class="p">):</span>
    <span class="n">stripe_card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_card</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">card</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">card_delete_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_remove_already_deleted_card" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_remove_already_deleted_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove_already_deleted_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">stripe_card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_card</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">card_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">stripe_card</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">card_object</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_remove_no_such_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_remove_no_such_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Card._api_delete&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove_no_such_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span><span class="p">):</span>
    <span class="n">stripe_card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_card</span><span class="p">)</span>

    <span class="n">card_delete_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;No such customer:&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">card</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">card_delete_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_remove_no_such_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_remove_no_such_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Card._api_delete&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove_no_such_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span><span class="p">):</span>
    <span class="n">stripe_card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_card</span><span class="p">)</span>

    <span class="n">card_delete_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;No such source:&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">card</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">card_delete_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_remove_unexpected_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_remove_unexpected_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Card._api_delete&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove_unexpected_exception</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">card_delete_mock</span>
<span class="p">):</span>
    <span class="n">stripe_card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">_api_create</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_card</span><span class="p">)</span>

    <span class="n">card_delete_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;Unexpected Exception&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span><span class="n">InvalidRequestError</span><span class="p">,</span> <span class="s2">&quot;Unexpected Exception&quot;</span><span class="p">):</span>
        <span class="n">card</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_card.CardTest.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_card</span><span class="o">.</span><span class="n">CardTest</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_card.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">fake_card</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">)</span>
    <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_card</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;&lt;brand=</span><span class="si">{brand}</span><span class="s2">, last4=</span><span class="si">{last4}</span><span class="s2">, exp_month=</span><span class="si">{exp_month}</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;exp_year=</span><span class="si">{exp_year}</span><span class="s2">, id=</span><span class="si">{id}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">brand</span><span class="o">=</span><span class="n">fake_card</span><span class="p">[</span><span class="s2">&quot;brand&quot;</span><span class="p">],</span>
            <span class="n">last4</span><span class="o">=</span><span class="n">fake_card</span><span class="p">[</span><span class="s2">&quot;last4&quot;</span><span class="p">],</span>
            <span class="n">exp_month</span><span class="o">=</span><span class="n">fake_card</span><span class="p">[</span><span class="s2">&quot;exp_month&quot;</span><span class="p">],</span>
            <span class="n">exp_year</span><span class="o">=</span><span class="n">fake_card</span><span class="p">[</span><span class="s2">&quot;exp_year&quot;</span><span class="p">],</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">fake_card</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">card</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_source&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_charge" class="doc doc-heading">
        <code>tests.test_charge</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Charge Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_charge-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_charge.ChargeTest" class="doc doc-heading">
        <code>
tests.test_charge.ChargeTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_charge.ChargeTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;user@example.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.pending_setup_intent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.schedule&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test__attach_objects_hook_missing_source_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test__attach_objects_hook_missing_source_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_account</span><span class="p">,</span> <span class="n">mock_payment_method</span><span class="p">,</span> <span class="n">mock_charge_account</span><span class="p">,</span> <span class="n">mock_charge_source</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Make sure we handle the case where the source data is empty or insufficient.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Charge</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Charge</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;account&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="s2">&quot;djstripe.models.payment_methods.DjstripePaymentMethod&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;djstripe.models.account.Account&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test__attach_objects_hook_missing_source_data</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">mock_account</span><span class="p">,</span> <span class="n">mock_payment_method</span><span class="p">,</span> <span class="n">mock_charge_account</span><span class="p">,</span> <span class="n">mock_charge_source</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure we handle the case where the source data is empty or insufficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_test&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ChargeStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span>
        <span class="n">captured</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">paid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mock_cls</span> <span class="o">=</span> <span class="n">create_autospec</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Charge</span><span class="p">,</span> <span class="n">spec_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Empty data dict works for this test since we only look up the source key and</span>
    <span class="c1"># everything else is mocked.</span>
    <span class="n">mock_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">starting_source</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">source</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">_attach_objects_hook</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">mock_cls</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mock_data</span><span class="p">)</span>

    <span class="c1"># source shouldn&#39;t be touched</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">starting_source</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="n">mock_payment_method</span><span class="o">.</span><span class="n">_get_or_create_source</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="c1"># try again with a source key, but no object sub key.</span>
    <span class="n">mock_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">}}</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">_attach_objects_hook</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">mock_cls</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mock_data</span><span class="p">)</span>

    <span class="c1"># source shouldn&#39;t be touched</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">starting_source</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="n">mock_payment_method</span><span class="o">.</span><span class="n">_get_or_create_source</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_capture_charge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_capture_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_capture_charge</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_no_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_no_invoice</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_no_invoice</span>

    <span class="c1"># TODO - I think this is needed in line with above?</span>
    <span class="n">fake_payment_intent_no_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent_no_invoice</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent_no_invoice</span>

    <span class="n">charge</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span>
        <span class="n">fake_charge_no_invoice</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">created</span><span class="p">)</span>

    <span class="n">captured_charge</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">captured_charge</span><span class="o">.</span><span class="n">captured</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">captured_charge</span><span class="o">.</span><span class="n">fraudulent</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span>
            <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.invoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Plan.product&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_max_size_large_charge_on_decimal_amount" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_max_size_large_charge_on_decimal_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>By contacting stripe support, some accounts will have their limit raised to 11
digits</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span>
    <span class="ow">and</span> <span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_max_size_large_charge_on_decimal_amount</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    By contacting stripe support, some accounts will have their limit raised to 11</span>
<span class="sd">    digits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="mi">99999999999</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span> <span class="o">==</span> <span class="mi">11</span>

    <span class="n">fake_transaction</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">)</span>
    <span class="n">fake_transaction</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">})</span>

    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_transaction</span>

    <span class="n">fake_charge</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">})</span>

    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge</span><span class="p">)</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;999999999.99&quot;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="mi">99999999999</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_test&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ChargeStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span>
        <span class="n">captured</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">paid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">charge</span><span class="p">),</span> <span class="s2">&quot;$50.00 USD (Uncaptured)&quot;</span><span class="p">)</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">captured</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">charge</span><span class="p">),</span> <span class="s2">&quot;$50.00 USD (Failed)&quot;</span><span class="p">)</span>
    <span class="n">charge</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">ChargeStatus</span><span class="o">.</span><span class="n">succeeded</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">disputed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">charge</span><span class="p">),</span> <span class="s2">&quot;$50.00 USD (Disputed)&quot;</span><span class="p">)</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">disputed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">charge</span><span class="o">.</span><span class="n">refunded</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">charge</span><span class="o">.</span><span class="n">amount_refunded</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">charge</span><span class="p">),</span> <span class="s2">&quot;$50.00 USD (Refunded)&quot;</span><span class="p">)</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">refunded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">charge</span><span class="p">),</span> <span class="s2">&quot;$50.00 USD (Partially refunded)&quot;</span><span class="p">)</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">amount_refunded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">charge</span><span class="p">),</span> <span class="s2">&quot;$50.00 USD&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span>
    <span class="ow">and</span> <span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">djstripe.settings</span> <span class="kn">import</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>

    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge_copy</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20&quot;</span><span class="p">),</span> <span class="n">charge</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">paid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">refunded</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">captured</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">disputed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Subscription creation&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">amount_refunded</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">LegacySourceType</span><span class="o">.</span><span class="n">card</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">receipt_url</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">payment_method_details</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data_max_amount" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_max_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_max_amount</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="c1"># https://support.stripe.com/questions/what-is-the-maximum-amount-i-can-charge-with-stripe</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">99999999</span><span class="p">})</span>

    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge_copy</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;999999.99&quot;</span><span class="p">),</span> <span class="n">charge</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">paid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">refunded</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">captured</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">disputed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">amount_refunded</span><span class="p">)</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data_no_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_no_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_no_customer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">djstripe.settings</span> <span class="kn">import</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>

    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># remove invoice since it requires a customer</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;invoice&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent</span><span class="p">[</span><span class="s2">&quot;invoice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent</span>

    <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge_copy</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">charge</span><span class="o">.</span><span class="n">customer</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span>
            <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.invoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Plan.product&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data_refunded" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_refunded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_refunded</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">djstripe.settings</span> <span class="kn">import</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_REFUNDED</span><span class="p">)</span>

    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge_copy</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20&quot;</span><span class="p">),</span> <span class="n">charge</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">paid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">refunded</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">captured</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">disputed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Subscription creation&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">amount_refunded</span><span class="p">)</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="c1"># We expect two calls - for charge and then for charge.refunds</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
                <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
                <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">refunds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">refunds</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refunds</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">refund</span> <span class="o">=</span> <span class="n">refunds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refund</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_REFUND</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span>
        <span class="n">charge</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">refund</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">refund</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data_refunded_on_update" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_refunded_on_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_refunded_on_update</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># first sync charge (as per test_sync_from_stripe_data)</span>
    <span class="c1"># then sync refunded version, to hit the update code-path instead of insert</span>

    <span class="kn">from</span> <span class="nn">djstripe.settings</span> <span class="kn">import</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge_copy</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20&quot;</span><span class="p">),</span> <span class="n">charge</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">paid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">refunded</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">captured</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">disputed</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">refunds</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">fake_charge_refunded_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_REFUNDED</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span><span class="p">),</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">:</span>
        <span class="n">charge_refunded</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge_refunded_copy</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20&quot;</span><span class="p">),</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">paid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">refunded</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">captured</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">disputed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Subscription creation&quot;</span><span class="p">,</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge_refunded</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">charge_refunded</span><span class="o">.</span><span class="n">amount_refunded</span><span class="p">)</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">refunds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">charge_refunded</span><span class="o">.</span><span class="n">refunds</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refunds</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">refund</span> <span class="o">=</span> <span class="n">refunds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refund</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_REFUND</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span>
        <span class="n">charge_refunded</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">refund</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">charge_refunded</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">refund</span><span class="o">.</span><span class="n">balance_transaction</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge_refunded</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data_unsupported_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_unsupported_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_unsupported_source</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">djstripe.settings</span> <span class="kn">import</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_id&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="s2">&quot;unsupported&quot;</span><span class="p">}})</span>

    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_charge_copy</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;test_id&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;unsupported&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">DjstripePaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;test_id&quot;</span><span class="p">))</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data_with_destination" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_with_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.File.retrieve&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">)],</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_with_destination</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">file_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">account_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">djstripe.settings</span> <span class="kn">import</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">account_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">FAKE_ACCOUNT</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;destination&quot;</span><span class="p">:</span> <span class="n">FAKE_ACCOUNT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>

    <span class="n">charge</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span>
        <span class="n">fake_charge_copy</span><span class="p">,</span> <span class="n">current_ids</span><span class="o">=</span><span class="p">{</span><span class="n">fake_charge_copy</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">created</span><span class="p">)</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_charge.ChargeTest.test_sync_from_stripe_data_with_transfer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_charge</span><span class="o">.</span><span class="n">ChargeTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_with_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_charge.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_with_transfer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">transfer_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">djstripe.settings</span> <span class="kn">import</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_transfer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">)</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">fake_transfer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>

    <span class="n">transfer_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_transfer</span>
    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>

    <span class="n">charge</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span>
        <span class="n">fake_charge_copy</span><span class="p">,</span> <span class="n">current_ids</span><span class="o">=</span><span class="p">{</span><span class="n">fake_charge_copy</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">created</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">.</span><span class="n">transfer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_transfer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">charge</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
            <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_context_managers" class="doc doc-heading">
        <code>tests.test_context_managers</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Context Manager Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_context_managers.TestTemporaryVersion" class="doc doc-heading">
        <code>
tests.test_context_managers.TestTemporaryVersion        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_context_managers.TestTemporaryVersion.test_basic_with_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_context_managers</span><span class="o">.</span><span class="n">TestTemporaryVersion</span><span class="o">.</span><span class="n">test_basic_with_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_context_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_basic_with_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">stripe_temporary_api_version</span><span class="p">(</span><span class="s2">&quot;2016-03-07&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span><span class="p">,</span> <span class="s2">&quot;2016-03-07&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Something happened&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_context_managers.TestTemporaryVersion.test_basic_without_validation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_context_managers</span><span class="o">.</span><span class="n">TestTemporaryVersion</span><span class="o">.</span><span class="n">test_basic_without_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_context_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_basic_without_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span>

    <span class="k">with</span> <span class="n">stripe_temporary_api_version</span><span class="p">(</span><span class="s2">&quot;newversion&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span><span class="p">,</span> <span class="s2">&quot;newversion&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_contrib" class="doc doc-heading">
        <code>tests.test_contrib</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








<h4 id="tests.test_contrib-modules">Modules</h4>

  <div class="doc doc-object doc-module">



<h5 id="tests.test_contrib.test_rest_framework_permissions" class="doc doc-heading">
        <code>tests.test_contrib.test_rest_framework_permissions</code>



</h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">





<h6 id="tests.test_contrib.test_rest_framework_permissions-classes">Classes</h6>

  <div class="doc doc-object doc-class">



<h7 id="tests.test_contrib.test_rest_framework_permissions.TestUserHasActiveSubscription" class="doc doc-heading">
        <code>
tests.test_contrib.test_rest_framework_permissions.TestUserHasActiveSubscription        </code>



</h7>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h8 id="tests.test_contrib.test_rest_framework_permissions.TestUserHasActiveSubscription-methods">Methods</h8>

  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_rest_framework_permissions.TestUserHasActiveSubscription.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_rest_framework_permissions</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_rest_framework_permissions.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_rest_framework_permissions.TestUserHasActiveSubscription.test_no_user_in_request" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_rest_framework_permissions</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_no_user_in_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_rest_framework_permissions.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_no_user_in_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">RequestFactory</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;djstripe/&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">DJStripeSubscriptionPermission</span><span class="p">()</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_rest_framework_permissions.TestUserHasActiveSubscription.test_user" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_rest_framework_permissions</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_rest_framework_permissions.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">RequestFactory</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;djstripe/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">DJStripeSubscriptionPermission</span><span class="p">()</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tests.test_contrib.test_serializers" class="doc doc-heading">
        <code>tests.test_contrib.test_serializers</code>



</h5>

    <div class="doc doc-contents ">

      <p>.. module:: dj-stripe.tests.test_contrib.test_serializers
    :synopsis: dj-stripe Serializer Tests.</p>



  <div class="doc doc-children">





<h6 id="tests.test_contrib.test_serializers-classes">Classes</h6>

  <div class="doc doc-object doc-class">



<h7 id="tests.test_contrib.test_serializers.CreateSubscriptionSerializerTest" class="doc doc-heading">
        <code>
tests.test_contrib.test_serializers.CreateSubscriptionSerializerTest        </code>



</h7>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h8 id="tests.test_contrib.test_serializers.CreateSubscriptionSerializerTest-methods">Methods</h8>

  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_serializers.CreateSubscriptionSerializerTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_serializers</span><span class="o">.</span><span class="n">CreateSubscriptionSerializerTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_serializers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_serializers.CreateSubscriptionSerializerTest.test_invalid_serializer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_serializers</span><span class="o">.</span><span class="n">CreateSubscriptionSerializerTest</span><span class="o">.</span><span class="n">test_invalid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_serializers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_invalid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">CreateSubscriptionSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">,</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;stripe_token&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;This field is required.&quot;</span><span class="p">]}</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_serializers.CreateSubscriptionSerializerTest.test_valid_serializer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_serializers</span><span class="o">.</span><span class="n">CreateSubscriptionSerializerTest</span><span class="o">.</span><span class="n">test_valid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_token_mock</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_serializers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Token.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;token_test&quot;</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_valid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_token_mock</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">stripe_token_mock</span><span class="p">(</span><span class="n">card</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">CreateSubscriptionSerializer</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;stripe_token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;stripe_token&quot;</span><span class="p">,</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_serializers.CreateSubscriptionSerializerTest.test_valid_serializer_non_required_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_serializers</span><span class="o">.</span><span class="n">CreateSubscriptionSerializerTest</span><span class="o">.</span><span class="n">test_valid_serializer_non_required_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_token_mock</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test the CreateSubscriptionSerializer is_valid method.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_serializers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Token.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;token_test&quot;</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_valid_serializer_non_required_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_token_mock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the CreateSubscriptionSerializer is_valid method.&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">stripe_token_mock</span><span class="p">(</span><span class="n">card</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">CreateSubscriptionSerializer</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;stripe_token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;charge_immediately&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;tax_percent&quot;</span><span class="p">:</span> <span class="mf">13.00</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h7 id="tests.test_contrib.test_serializers.SubscriptionSerializerTest" class="doc doc-heading">
        <code>
tests.test_contrib.test_serializers.SubscriptionSerializerTest        </code>



</h7>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h8 id="tests.test_contrib.test_serializers.SubscriptionSerializerTest-methods">Methods</h8>

  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_serializers.SubscriptionSerializerTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_serializers</span><span class="o">.</span><span class="n">SubscriptionSerializerTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_serializers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_serializers.SubscriptionSerializerTest.test_invalid_serializer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_serializers</span><span class="o">.</span><span class="n">SubscriptionSerializerTest</span><span class="o">.</span><span class="n">test_invalid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_serializers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invalid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">SubscriptionSerializer</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;sub_6lsC8pt7IcFpjA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;customer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="s2">&quot;start_date&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">active</span><span class="p">,</span>
            <span class="s2">&quot;current_period_end&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;current_period_start&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">,</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;collection_method&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;This field is required.&quot;</span><span class="p">]}</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_serializers.SubscriptionSerializerTest.test_valid_serializer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_serializers</span><span class="o">.</span><span class="n">SubscriptionSerializerTest</span><span class="o">.</span><span class="n">test_valid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_serializers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_valid_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">SubscriptionSerializer</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;sub_6lsC8pt7IcFpjA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;collection_method&quot;</span><span class="p">:</span> <span class="s2">&quot;charge_automatically&quot;</span><span class="p">,</span>
            <span class="s2">&quot;customer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;start_date&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">active</span><span class="p">,</span>
            <span class="s2">&quot;current_period_end&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;current_period_start&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;sub_6lsC8pt7IcFpjA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;collection_method&quot;</span><span class="p">:</span> <span class="s2">&quot;charge_automatically&quot;</span><span class="p">,</span>
            <span class="s2">&quot;customer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">,</span>
            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;start_date&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">active</span><span class="p">,</span>
            <span class="s2">&quot;current_period_end&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;current_period_start&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tests.test_contrib.test_views" class="doc doc-heading">
        <code>tests.test_contrib.test_views</code>



</h5>

    <div class="doc doc-contents ">

      <p>.. module:: dj-stripe.tests.test_contrib.test_views
    :synopsis: dj-stripe Rest views for Subscription Tests.</p>



  <div class="doc doc-children">





<h6 id="tests.test_contrib.test_views-classes">Classes</h6>

  <div class="doc doc-object doc-class">



<h7 id="tests.test_contrib.test_views.RestSubscriptionNotLoggedInTest" class="doc doc-heading">
        <code>
tests.test_contrib.test_views.RestSubscriptionNotLoggedInTest        </code>



</h7>

    <div class="doc doc-contents ">

      <p>Test the exceptions thrown by the subscription rest views.</p>




  <div class="doc doc-children">







<h8 id="tests.test_contrib.test_views.RestSubscriptionNotLoggedInTest-methods">Methods</h8>

  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionNotLoggedInTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionNotLoggedInTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;rest_djstripe:subscription&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionNotLoggedInTest.test_create_subscription_not_logged_in" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionNotLoggedInTest</span><span class="o">.</span><span class="n">test_create_subscription_not_logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_create_subscription_not_logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="s2">&quot;test0&quot;</span><span class="p">,</span> <span class="s2">&quot;stripe_token&quot;</span><span class="p">:</span> <span class="s2">&quot;cake&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h7 id="tests.test_contrib.test_views.RestSubscriptionTest" class="doc doc-heading">
        <code>
tests.test_contrib.test_views.RestSubscriptionTest        </code>



</h7>

    <div class="doc doc-contents ">

      <p>Test the REST api for subscriptions.</p>




  <div class="doc doc-children">







<h8 id="tests.test_contrib.test_views.RestSubscriptionTest-methods">Methods</h8>

  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;rest_djstripe:subscription&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.test_cancel_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cancel_subscription_mock</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test a DELETE to the SubscriptionRestView.</p>
<p>Should cancel a Customer objects subscription.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Subscription.cancel&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cancel_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cancel_subscription_mock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test a DELETE to the SubscriptionRestView.</span>

<span class="sd">    Should cancel a Customer objects subscription.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_cancel_sub</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">canceled_at</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">ended_at</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">subscription</span>

    <span class="n">fake_canceled_subscription</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_canceled_subscription</span><span class="p">)</span>

    <span class="n">cancel_subscription_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">_cancel_sub</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>

    <span class="c1"># Cancelled means flagged as canceled, so it should still be there</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span>
    <span class="p">)</span>

    <span class="n">cancel_subscription_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
        <span class="n">at_period_end</span><span class="o">=</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">CANCELLATION_AT_PERIOD_END</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.test_cancel_subscription_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_subscription_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test a DELETE to the SubscriptionRestView.</p>
<p>Should return a 400 when an exception is raised.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_cancel_subscription_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test a DELETE to the SubscriptionRestView.</span>

<span class="sd">    Should return a 400 when an exception is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.test_create_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">test_create_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_card_mock</span><span class="p">,</span> <span class="n">subscribe_mock</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test a POST to the SubscriptionRestView.</p>
<div class="admonition should">
<p class="admonition-title">Should</p>
<ul>
<li>Create a Customer object</li>
<li>Add a card to the Customer object</li>
<li>Subcribe the Customer to a plan</li>
</ul>
</div>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.subscribe&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.add_card&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_card_mock</span><span class="p">,</span> <span class="n">subscribe_mock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test a POST to the SubscriptionRestView.</span>

<span class="sd">    Should:</span>
<span class="sd">        - Create a Customer object</span>
<span class="sd">        - Add a card to the Customer object</span>
<span class="sd">        - Subcribe the Customer to a plan</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="s2">&quot;test0&quot;</span><span class="p">,</span> <span class="s2">&quot;stripe_token&quot;</span><span class="p">:</span> <span class="s2">&quot;cake&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">add_card_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="s2">&quot;cake&quot;</span><span class="p">)</span>
    <span class="n">subscribe_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="s2">&quot;test0&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;charge_immediately&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.test_create_subscription_charge_immediately" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">test_create_subscription_charge_immediately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_card_mock</span><span class="p">,</span> <span class="n">subscribe_mock</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test a POST to the SubscriptionRestView.</p>
<p>Should be able to accept an charge_immediately.
This will not send an invoice to the customer on subscribe.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.subscribe&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.add_card&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_subscription_charge_immediately</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">add_card_mock</span><span class="p">,</span> <span class="n">subscribe_mock</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test a POST to the SubscriptionRestView.</span>

<span class="sd">    Should be able to accept an charge_immediately.</span>
<span class="sd">    This will not send an invoice to the customer on subscribe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="s2">&quot;test0&quot;</span><span class="p">,</span> <span class="s2">&quot;stripe_token&quot;</span><span class="p">:</span> <span class="s2">&quot;cake&quot;</span><span class="p">,</span> <span class="s2">&quot;charge_immediately&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">subscribe_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="s2">&quot;test0&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.test_create_subscription_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">test_create_subscription_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_card_mock</span><span class="p">,</span> <span class="n">subscribe_mock</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test a POST to the SubscriptionRestView.</p>
<p>Should return a 400 when an Exception is raised.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.subscribe&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.add_card&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_subscription_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_card_mock</span><span class="p">,</span> <span class="n">subscribe_mock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test a POST to the SubscriptionRestView.</span>

<span class="sd">    Should return a 400 when an Exception is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subscribe_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="s2">&quot;test0&quot;</span><span class="p">,</span> <span class="s2">&quot;stripe_token&quot;</span><span class="p">:</span> <span class="s2">&quot;cake&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.test_create_subscription_incorrect_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">test_create_subscription_incorrect_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test a POST to the SubscriptionRestView.</p>
<p>Should return a 400 when a the serializer is invalid.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_create_subscription_incorrect_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test a POST to the SubscriptionRestView.</span>

<span class="sd">    Should return a 400 when a the serializer is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h9 id="tests.test_contrib.test_views.RestSubscriptionTest.test_get_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_contrib</span><span class="o">.</span><span class="n">test_views</span><span class="o">.</span><span class="n">RestSubscriptionTest</span><span class="o">.</span><span class="n">test_get_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h9>

    <div class="doc doc-contents ">

      <p>Test a GET to the SubscriptionRestView.</p>
<p>Should return the correct data.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_contrib/test_views.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test a GET to the SubscriptionRestView.</span>

<span class="sd">    Should return the correct data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">],</span> <span class="n">plan</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="n">subscription</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cancel_at_period_end&quot;</span><span class="p">],</span> <span class="n">subscription</span><span class="o">.</span><span class="n">cancel_at_period_end</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_coupon" class="doc doc-heading">
        <code>tests.test_coupon</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_coupon.HumanReadableCouponTest" class="doc doc-heading">
        <code>
tests.test_coupon.HumanReadableCouponTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_human_readable_eur_off_forever" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_human_readable_eur_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_eur_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-amount-off-forever&quot;</span><span class="p">,</span>
        <span class="n">amount_off</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;eur&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;forever&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">,</span> <span class="s2">&quot;€10.00 EUR off forever&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_human_readable_integer_percent_off_forever" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_human_readable_integer_percent_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_integer_percent_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-percent-off-forever&quot;</span><span class="p">,</span>
        <span class="n">percent_off</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;forever&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">,</span> <span class="s2">&quot;10</span><span class="si">% o</span><span class="s2">ff forever&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_human_readable_percent_off_forever" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_human_readable_percent_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_percent_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-percent-off-forever&quot;</span><span class="p">,</span>
        <span class="n">percent_off</span><span class="o">=</span><span class="mf">10.25</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;forever&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">,</span> <span class="s2">&quot;10.25</span><span class="si">% o</span><span class="s2">ff forever&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_human_readable_percent_off_once" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_human_readable_percent_off_once</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_percent_off_once</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-percent-off-once&quot;</span><span class="p">,</span>
        <span class="n">percent_off</span><span class="o">=</span><span class="mf">10.25</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;once&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">,</span> <span class="s2">&quot;10.25</span><span class="si">% o</span><span class="s2">ff once&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_human_readable_percent_off_one_month" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_human_readable_percent_off_one_month</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_percent_off_one_month</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-percent-off-1month&quot;</span><span class="p">,</span>
        <span class="n">percent_off</span><span class="o">=</span><span class="mf">10.25</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;repeating&quot;</span><span class="p">,</span>
        <span class="n">duration_in_months</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">,</span> <span class="s2">&quot;10.25</span><span class="si">% o</span><span class="s2">ff for 1 month&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_human_readable_percent_off_three_months" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_human_readable_percent_off_three_months</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_percent_off_three_months</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-percent-off-3month&quot;</span><span class="p">,</span>
        <span class="n">percent_off</span><span class="o">=</span><span class="mf">10.25</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;repeating&quot;</span><span class="p">,</span>
        <span class="n">duration_in_months</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">,</span> <span class="s2">&quot;10.25</span><span class="si">% o</span><span class="s2">ff for 3 months&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_human_readable_usd_off_forever" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_human_readable_usd_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_usd_off_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-amount-off-forever&quot;</span><span class="p">,</span>
        <span class="n">amount_off</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;forever&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">,</span> <span class="s2">&quot;$10.00 USD off forever&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="n">coupon</span><span class="o">.</span><span class="n">human_readable</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.HumanReadableCouponTest.test_str_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">HumanReadableCouponTest</span><span class="o">.</span><span class="n">test_str_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;coupon-test-amount-off-forever&quot;</span><span class="p">,</span>
        <span class="n">amount_off</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;forever&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test coupon&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">),</span> <span class="s2">&quot;Test coupon&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_coupon.TransferTest" class="doc doc-heading">
        <code>
tests.test_coupon.TransferTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_coupon.TransferTest.test_retrieve_coupon" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">TransferTest</span><span class="o">.</span><span class="n">test_retrieve_coupon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_retrieve_coupon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">coupon_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">)</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">coupon_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">coupon</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_COUPON</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="tests.test_coupon.test_blank_coupon_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_coupon</span><span class="o">.</span><span class="n">test_blank_coupon_str</span><span class="p">()</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_coupon.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_blank_coupon_str</span><span class="p">():</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">coupon</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;(invalid amount) off&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_customer" class="doc doc-heading">
        <code>tests.test_customer</code>



</h3>

    <div class="doc doc-contents ">

      <p>Customer Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_customer-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_customer.TestCustomer" class="doc doc-heading">
        <code>
tests.test_customer.TestCustomer        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_customer.TestCustomer-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">payment_method</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">DjstripePaymentMethod</span><span class="o">.</span><span class="n">_get_or_create_source</span><span class="p">(</span>
        <span class="n">FAKE_CARD</span><span class="p">,</span> <span class="s2">&quot;card&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_method</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_card_set_default_false" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_card_set_default_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_card_set_default_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_card</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">set_default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_card</span><span class="p">(</span><span class="n">FAKE_CARD_V</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">set_default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Card</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_card_set_default_false_with_single_card_still_becomes_default" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_card_set_default_false_with_single_card_still_becomes_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_card_set_default_false_with_single_card_still_becomes_default</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_card</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">set_default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Card</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_card_set_default_true" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_card_set_default_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_card_set_default_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_card</span><span class="p">(</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_card</span><span class="p">(</span><span class="n">FAKE_CARD_V</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Card</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_CARD_V</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_coupon_by_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_coupon_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Coupon.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_coupon_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_coupon</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_coupon_by_object" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_coupon_by_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Coupon.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_coupon_by_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">)</span>
    <span class="n">fake_discount</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_DISCOUNT_CUSTOMER</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fake_customer_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># fake the api coupon update behaviour</span>
        <span class="n">coupon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;coupon&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coupon</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;discount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_discount</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;discount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;tests.CustomerDict.save&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">fake_customer_save</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_coupon</span><span class="p">(</span><span class="n">coupon</span><span class="p">)</span>

    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_invoice_item" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_invoice_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoiceitem_create_mock</span><span class="p">,</span> <span class="n">invoiceitem_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.InvoiceItem.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;pancakes&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.InvoiceItem.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_invoice_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoiceitem_create_mock</span><span class="p">,</span> <span class="n">invoiceitem_sync_mock</span><span class="p">):</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_invoice_item</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">),</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;eur&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">invoice</span><span class="o">=</span><span class="mi">77</span><span class="p">,</span>
        <span class="n">subscription</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;pancakes&quot;</span><span class="p">,</span> <span class="n">invoiceitem</span><span class="p">)</span>

    <span class="n">invoiceitem_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;eur&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">discountable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">invoice</span><span class="o">=</span><span class="mi">77</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subscription</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_invoice_item_bad_decimal" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_invoice_item_bad_decimal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_add_invoice_item_bad_decimal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;You must supply a decimal value representing dollars.&quot;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_invoice_item</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_invoice_item_djstripe_objects" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_invoice_item_djstripe_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoiceitem_create_mock</span><span class="p">,</span> <span class="n">invoiceitem_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.InvoiceItem.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;pancakes&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.InvoiceItem.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_invoice_item_djstripe_objects</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">invoiceitem_create_mock</span><span class="p">,</span> <span class="n">invoiceitem_sync_mock</span>
<span class="p">):</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_invoice_item</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">),</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;eur&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">invoice</span><span class="o">=</span><span class="n">Invoice</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">77</span><span class="p">),</span>
        <span class="n">subscription</span><span class="o">=</span><span class="n">Subscription</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">25</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;pancakes&quot;</span><span class="p">,</span> <span class="n">invoiceitem</span><span class="p">)</span>

    <span class="n">invoiceitem_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;eur&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">discountable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">invoice</span><span class="o">=</span><span class="mi">77</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subscription</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_payment_method_obj" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_payment_method_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.attach&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_add_payment_method_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">)</span>
    <span class="n">payment_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_payment_method</span><span class="p">(</span><span class="n">payment_method</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_payment_method</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_payment_method</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">invoice_settings</span><span class="p">[</span><span class="s2">&quot;default_payment_method&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_payment_method_set_default_false" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_payment_method_set_default_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.attach&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_add_payment_method_set_default_false</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="c1"># clear default source so we can check can_charge()</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_customer</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_payment_method</span><span class="p">(</span>
        <span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">set_default</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">can_charge</span><span class="p">(),</span>
        <span class="s2">&quot;Expect not to be able to charge since we&#39;ve not set a &quot;</span>
        <span class="s2">&quot;default_payment_method&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_source&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_add_payment_method_set_default_true" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_add_payment_method_set_default_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.attach&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_add_payment_method_set_default_true</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="c1"># clear default source so we can check can_charge()</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_customer</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">add_payment_method</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_payment_method</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_payment_method</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">invoice_settings</span><span class="p">[</span><span class="s2">&quot;default_payment_method&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">can_charge</span><span class="p">(),</span>
        <span class="s2">&quot;Expect to be able to charge since we&#39;ve set a default_payment_method&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_source&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_balance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">credits</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">credits</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">pending_charges</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">credits</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">pending_charges</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_calculate_refund_above_max_refund" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_calculate_refund_above_max_refund</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_calculate_refund_above_max_refund</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_111111&quot;</span><span class="p">,</span> <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">charge</span><span class="o">.</span><span class="n">_calculate_refund_amount</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;600.00&quot;</span><span class="p">)),</span> <span class="mi">50000</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_calculate_refund_amount_partial_refund" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_calculate_refund_amount_partial_refund</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_calculate_refund_amount_partial_refund</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_111111&quot;</span><span class="p">,</span> <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">charge</span><span class="o">.</span><span class="n">_calculate_refund_amount</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;300.00&quot;</span><span class="p">)),</span> <span class="mi">30000</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_can_charge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_can_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_can_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">can_charge</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_cannot_charge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_cannot_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_fake</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cannot_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_fake</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">can_charge</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_charge_accepts_only_decimals" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_charge_accepts_only_decimals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_charge_accepts_only_decimals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_charge_card_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_charge_card_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_create_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_charge_card_source</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_create_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">charge_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>
    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>

    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">card</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_charge_converts_dollars_into_cents" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_charge_converts_dollars_into_cents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_create_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_charge_converts_dollars_into_cents</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_create_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})</span>

    <span class="n">charge_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>
    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>

    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">))</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">charge_create_mock</span><span class="o">.</span><span class="n">call_args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">],</span> <span class="mi">1000</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_charge_doesnt_require_invoice" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_charge_doesnt_require_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_create_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_charge_doesnt_require_invoice</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_create_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="n">FAKE_INVOICE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">FAKE_INVOICE</span><span class="p">[</span><span class="s2">&quot;amount_due&quot;</span><span class="p">]}</span>
    <span class="p">)</span>
    <span class="n">fake_invoice_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>

    <span class="n">charge_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>
    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>
    <span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_invoice_copy</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20.00&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Stripe Charge shouldn&#39;t throw Invoice DoesNotExist.&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_charge_passes_extra_arguments" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_charge_passes_extra_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_create_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_charge_passes_extra_arguments</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_create_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">charge_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>
    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>

    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span>
        <span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">destination</span><span class="o">=</span><span class="n">FAKE_ACCOUNT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">charge_create_mock</span><span class="o">.</span><span class="n">call_args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;capture&quot;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">],</span> <span class="n">FAKE_ACCOUNT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_charge_string_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_charge_string_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_create_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_charge_string_source</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_create_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_copy</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">charge_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>
    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_copy</span>

    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">card</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_create_metadata_disabled" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_create_metadata_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_create_metadata_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;test_user_create_metadata_disabled&quot;</span>
    <span class="p">)</span>

    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cus_test_create_metadata_disabled&quot;</span>
    <span class="n">customer_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_customer</span>

    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">SUBSCRIBER_CUSTOMER_KEY</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">SUBSCRIBER_CUSTOMER_KEY</span> <span class="o">=</span> <span class="s2">&quot;djstripe_subscriber&quot;</span>

    <span class="n">customer_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">idempotency_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_source&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_dashboard_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_dashboard_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_dashboard_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected_url</span> <span class="o">=</span> <span class="s2">&quot;https://dashboard.stripe.com/test/customers/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span> <span class="n">expected_url</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">livemode</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">expected_url</span> <span class="o">=</span> <span class="s2">&quot;https://dashboard.stripe.com/customers/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span> <span class="n">expected_url</span><span class="p">)</span>

    <span class="n">unsaved_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">unsaved_customer</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_delete_raises_unexpected_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_delete_raises_unexpected_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_delete_raises_unexpected_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;Unexpected Exception&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span><span class="n">InvalidRequestError</span><span class="p">,</span> <span class="s2">&quot;Unexpected Exception&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>

    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_delete_same_as_purge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_delete_same_as_purge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_fake</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_delete_same_as_purge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_fake</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_purge_deletes_idempotency_key" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_purge_deletes_idempotency_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_api_create_fake</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_purge_deletes_idempotency_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_api_create_fake</span><span class="p">):</span>
    <span class="c1"># We need to call Customer.get_or_create (which setUp doesn&#39;t)</span>
    <span class="c1"># to get an idempotency key</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;blah&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">idempotency_key_action</span> <span class="o">=</span> <span class="s2">&quot;customer:create:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">idempotency_key_action</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">customer</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">idempotency_key_action</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">idempotency_key_action</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_purge_detaches_sources" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_purge_detaches_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_api_create_fake</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_purge_detaches_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_api_create_fake</span><span class="p">):</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_III</span><span class="p">)</span>
    <span class="n">customer_api_create_fake</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_customer</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;blah&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">FAKE_CUSTOMER_III</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">Customer</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_III</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Source.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SOURCE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_purge_leaves_customer_record" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_purge_leaves_customer_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_fake</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_purge_leaves_customer_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_fake</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_purge_raises_customer_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_purge_raises_customer_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_purge_raises_customer_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;No such customer:&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>

    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_add_tax_id_to_existing_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_add_tax_id_to_existing_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_WITH_TAX_ID</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_customer_sync_add_tax_id_to_existing_customer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_BEFORE_TAX_ID</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_WITH_TAX_ID</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;DE123456789&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;eu_vat&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_bank_account_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_bank_account_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bank_account_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BankAccount.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">],</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_sync_bank_account_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bank_account_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_IV</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;test_user_sync_bank_account_source&quot;</span>
    <span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">fake_customer</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_create_customer_and_tax_ids" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_create_customer_and_tax_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_WITH_TAX_ID</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_customer_sync_create_customer_and_tax_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;DE123456789&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;eu_vat&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_default_payment_method_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_default_payment_method_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_sync_default_payment_method_string</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">customer_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">customer_fake</span><span class="p">[</span><span class="s2">&quot;invoice_settings&quot;</span><span class="p">][</span>
        <span class="s2">&quot;default_payment_method&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">customer_fake</span>

    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">customer_fake</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">default_payment_method</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">customer_fake</span><span class="p">[</span><span class="s2">&quot;invoice_settings&quot;</span><span class="p">][</span><span class="s2">&quot;default_payment_method&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_default_source_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_default_source_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_sync_default_source_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">Card</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">customer_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">customer_fake</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer_fake</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span>
        <span class="s2">&quot;id&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;card_sync_source_string&quot;</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">customer_fake</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">customer_fake</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_payment_methods</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_has_bad_subscriber_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_has_bad_subscriber_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_sync_has_bad_subscriber_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cus_sync_has_bad_subscriber_metadata&quot;</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;djstripe_subscriber&quot;</span><span class="p">:</span> <span class="s2">&quot;does_not_exist&quot;</span><span class="p">}</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;djstripe_subscriber&quot;</span><span class="p">:</span> <span class="s2">&quot;does_not_exist&quot;</span><span class="p">})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_has_subscriber_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_has_subscriber_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_sync_has_subscriber_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;test_metadata&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cus_sync_has_subscriber_metadata&quot;</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;djstripe_subscriber&quot;</span><span class="p">:</span> <span class="s2">&quot;12345&quot;</span><span class="p">}</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;djstripe_subscriber&quot;</span><span class="p">:</span> <span class="s2">&quot;12345&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_has_subscriber_metadata_disabled" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_has_subscriber_metadata_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_sync_has_subscriber_metadata_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;test_metadata_disabled&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">98765</span>
    <span class="p">)</span>

    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cus_test_metadata_disabled&quot;</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;djstripe_subscriber&quot;</span><span class="p">:</span> <span class="s2">&quot;98765&quot;</span><span class="p">}</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;djstripe.settings.SUBSCRIBER_CUSTOMER_KEY&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber_id</span><span class="p">,</span> <span class="mi">98765</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_no_sources" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_no_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_sync_no_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">):</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cus_test_sync_no_sources&quot;</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">customer_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_customer</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;test_user_sync_non_local_card&quot;</span>
    <span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">customer_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">),</span>
        <span class="p">{</span><span class="s2">&quot;djstripe_subscriber&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">customer</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_source&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_non_local_card" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_non_local_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Card.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">],</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_sync_non_local_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span>
        <span class="s2">&quot;customer&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cus_test_sync_non_local_card&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;test_user_sync_non_local_card&quot;</span>
    <span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">fake_customer</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_customer_sync_unsupported_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_customer_sync_unsupported_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_sync_unsupported_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span>
        <span class="s2">&quot;object&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fish&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;test_user_sync_unsupported_source&quot;</span>
    <span class="p">)</span>
    <span class="n">synced_customer</span> <span class="o">=</span> <span class="n">fake_customer</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">synced_customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">synced_customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">synced_customer</span><span class="o">.</span><span class="n">default_source</span><span class="p">,</span>
        <span class="n">DjstripePaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;default_source&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_delete_subscriber_without_customer_is_noop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_delete_subscriber_without_customer_is_noop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_delete_subscriber_without_customer_is_noop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">customer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">djstripe_customers</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">date_purged</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_has_active_subscription_with_unspecified_price_with_multiple_subscriptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_has_active_subscription_with_unspecified_price_with_multiple_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_has_active_subscription_with_unspecified_price_with_multiple_subscriptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">subscription_fake_duplicate</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake_duplicate</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">subscription_fake_duplicate</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sub_6lsC8pt7IcF8jd&quot;</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">subscription_fake</span><span class="p">,</span>
        <span class="n">subscription_fake_duplicate</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_is_subscribed_to_with_product" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_is_subscribed_to_with_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_subscribed_to_with_product</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">))</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">subscription_fake</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_is_subscribed_to_with_product_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_is_subscribed_to_with_product_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_subscribed_to_with_product_string</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">))</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">subscription_fake</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_refund_charge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_refund_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_refund_charge</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_no_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_no_invoice</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_no_invoice</span>

    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent</span>

    <span class="n">charge</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span>
        <span class="n">fake_charge_no_invoice</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">created</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.invoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">charge</span><span class="o">.</span><span class="n">refund</span><span class="p">()</span>

    <span class="n">refunded_charge</span><span class="p">,</span> <span class="n">created2</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span>
        <span class="n">fake_charge_no_invoice</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">created2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refunded_charge</span><span class="o">.</span><span class="n">refunded</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refunded_charge</span><span class="o">.</span><span class="n">amount_refunded</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20.00&quot;</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">refunded_charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.invoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_refund_charge_object_returned" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_refund_charge_object_returned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_refund_charge_object_returned</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_charge_no_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)</span>
    <span class="n">fake_charge_no_invoice</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_charge_no_invoice</span>

    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>
    <span class="n">fake_payment_intent</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

    <span class="n">payment_intent_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_payment_intent</span>

    <span class="n">charge</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span>
        <span class="n">fake_charge_no_invoice</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">created</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.invoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">refunded_charge</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">refund</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refunded_charge</span><span class="o">.</span><span class="n">refunded</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refunded_charge</span><span class="o">.</span><span class="n">amount_refunded</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20.00&quot;</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">refunded_charge</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.invoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_retry_unpaid_invoices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_retry_unpaid_invoices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retry_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.list&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_III</span><span class="p">)]</span>
    <span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Invoice.retry&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_retry_unpaid_invoices</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retry_mock</span><span class="p">,</span>
    <span class="n">invoice_list_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">retry_unpaid_invoices</span><span class="p">()</span>

    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_INVOICE_III</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">invoice_retry_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_retry_unpaid_invoices_expected_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_retry_unpaid_invoices_expected_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retry_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.list&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_III</span><span class="p">)]),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Invoice.retry&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_retry_unpaid_invoices_expected_exception</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retry_mock</span><span class="p">,</span>
    <span class="n">invoice_list_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">invoice_retry_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;Invoice is already paid&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">retry_unpaid_invoices</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Exception was unexpectedly raised.&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_retry_unpaid_invoices_none_unpaid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_retry_unpaid_invoices_none_unpaid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retry_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.list&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)]),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Invoice.retry&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_retry_unpaid_invoices_none_unpaid</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retry_mock</span><span class="p">,</span>
    <span class="n">invoice_list_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">retry_unpaid_invoices</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">invoice_retry_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_retry_unpaid_invoices_unexpected_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_retry_unpaid_invoices_unexpected_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retry_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.list&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_III</span><span class="p">)]),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Invoice.retry&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_retry_unpaid_invoices_unexpected_exception</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retry_mock</span><span class="p">,</span>
    <span class="n">invoice_list_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">invoice_retry_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;This should fail!&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span><span class="n">InvalidRequestError</span><span class="p">,</span> <span class="s2">&quot;This should fail!&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">retry_unpaid_invoices</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_send_invoice_failure" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_send_invoice_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_send_invoice_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_create_mock</span><span class="p">):</span>
    <span class="n">invoice_create_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;Invoice creation failed.&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="n">return_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">send_invoice</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">return_status</span><span class="p">)</span>

    <span class="n">invoice_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_send_invoice_success" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_send_invoice_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_send_invoice_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_create_mock</span><span class="p">):</span>
    <span class="n">return_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">send_invoice</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">return_status</span><span class="p">)</span>

    <span class="n">invoice_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_subscribe_charge_immediately" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_subscribe_charge_immediately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">,</span> <span class="n">send_invoice_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.send_invoice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscribe_charge_immediately</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_create_mock</span><span class="p">,</span>
    <span class="n">send_invoice_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">send_invoice_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_subscribe_not_charge_immediately" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_subscribe_not_charge_immediately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">,</span> <span class="n">send_invoice_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.send_invoice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscribe_not_charge_immediately</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_create_mock</span><span class="p">,</span>
    <span class="n">send_invoice_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">send_invoice_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_subscribe_price_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_subscribe_price_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">,</span> <span class="n">send_invoice_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.send_invoice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscribe_price_string</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_create_mock</span><span class="p">,</span>
    <span class="n">send_invoice_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">send_invoice_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_subscription_shortcut_with_invalid_subscriptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_subscription_shortcut_with_invalid_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_shortcut_with_invalid_subscriptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">fake_subscriptions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># update the status of all but one to be invalid,</span>
    <span class="c1"># we need to also change the id for sync to work</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;canceled&quot;</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;foo1&quot;</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;incomplete_expired&quot;</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;foo2&quot;</span>

    <span class="k">for</span> <span class="n">fake_subscription</span> <span class="ow">in</span> <span class="n">fake_subscriptions</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
            <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
            <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="n">fake_subscription</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">valid_subscriptions</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">valid_subscriptions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscription</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_subscription_shortcut_with_multiple_subscriptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_subscription_shortcut_with_multiple_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_shortcut_with_multiple_subscriptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">subscription_fake_duplicate</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake_duplicate</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sub_6lsC8pt7IcF8jd&quot;</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
        <span class="n">subscription_fake_duplicate</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">valid_subscriptions</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">MultipleSubscriptionException</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscription</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_charges" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">charge_list_mock</span><span class="p">,</span> <span class="n">charge_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Charge.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.list&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">)]),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_charges</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">charge_list_mock</span><span class="p">,</span> <span class="n">charge_sync_mock</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">_sync_charges</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">charge_sync_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_charges_none" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_charges_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">charge_list_mock</span><span class="p">,</span> <span class="n">charge_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Charge.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.list&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[]),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_charges_none</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">charge_list_mock</span><span class="p">,</span> <span class="n">charge_sync_mock</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">_sync_charges</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge_sync_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_customer_delete_discount" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_customer_delete_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sync_customer_delete_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">test_coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span> <span class="o">=</span> <span class="n">test_coupon</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_COUPON</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_customer_discount_already_present" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_customer_discount_already_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Coupon.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_customer_discount_already_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;discount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_DISCOUNT_CUSTOMER</span><span class="p">)</span>

    <span class="c1"># Set the customer&#39;s coupon to be what we&#39;ll sync</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">customer</span><span class="o">.</span><span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">)</span>
    <span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_COUPON</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_customer_with_discount" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_customer_with_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Coupon.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_customer_with_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="p">)</span>
    <span class="n">fake_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="n">fake_customer</span><span class="p">[</span><span class="s2">&quot;discount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_DISCOUNT_CUSTOMER</span><span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_COUPON</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon_start</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon_end</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_invoices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_invoices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">invoice_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Invoice.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.list&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_III</span><span class="p">)]</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_invoices</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">invoice_sync_mock</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">_sync_invoices</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">invoice_sync_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_invoices_none" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_invoices_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">invoice_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Invoice.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.list&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[]),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_invoices_none</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_list_mock</span><span class="p">,</span> <span class="n">invoice_sync_mock</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">_sync_invoices</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">invoice_sync_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_subscriptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_list_mock</span><span class="p">,</span> <span class="n">subscription_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Subscription.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.list&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_II</span><span class="p">)]</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_subscriptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_list_mock</span><span class="p">,</span> <span class="n">subscription_sync_mock</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">_sync_subscriptions</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">subscription_sync_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_sync_subscriptions_none" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_sync_subscriptions_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_list_mock</span><span class="p">,</span> <span class="n">subscription_sync_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Subscription.sync_from_stripe_data&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.list&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">StripeList</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[]),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_subscriptions_none</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_list_mock</span><span class="p">,</span> <span class="n">subscription_sync_mock</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">_sync_subscriptions</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">subscription_sync_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomer.test_upcoming_invoice_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomer</span><span class="o">.</span><span class="n">test_upcoming_invoice_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.upcoming&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_UPCOMING_INVOICE</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_upcoming_invoice_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_upcoming_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">upcoming_invoice</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">save</span><span class="p">())</span>

    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">invoice</span><span class="o">.</span><span class="n">_invoiceitems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_customer.TestCustomerLegacy" class="doc doc-heading">
        <code>
tests.test_customer.TestCustomerLegacy        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_customer.TestCustomerLegacy-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">payment_method</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">DjstripePaymentMethod</span><span class="o">.</span><span class="n">_get_or_create_source</span><span class="p">(</span>
        <span class="n">FAKE_CARD</span><span class="p">,</span> <span class="s2">&quot;card&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_method</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_has_active_subscription_with_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_has_active_subscription_with_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_has_active_subscription_with_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">subscription_fake</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_has_active_subscription_with_plan_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_has_active_subscription_with_plan_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_has_active_subscription_with_plan_string</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">subscription_fake</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_has_active_subscription_with_unspecified_plan_with_multiple_subscriptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_has_active_subscription_with_unspecified_plan_with_multiple_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_has_active_subscription_with_unspecified_plan_with_multiple_subscriptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">subscription_fake_duplicate</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake_duplicate</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">subscription_fake_duplicate</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sub_6lsC8pt7IcF8jd&quot;</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">subscription_fake</span><span class="p">,</span>
        <span class="n">subscription_fake_duplicate</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_subscribe_charge_immediately" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_subscribe_charge_immediately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">,</span> <span class="n">send_invoice_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.send_invoice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscribe_charge_immediately</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_create_mock</span><span class="p">,</span>
    <span class="n">send_invoice_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">send_invoice_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_subscribe_not_charge_immediately" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_subscribe_not_charge_immediately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">,</span> <span class="n">send_invoice_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.send_invoice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscribe_not_charge_immediately</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_create_mock</span><span class="p">,</span>
    <span class="n">send_invoice_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">send_invoice_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_subscribe_plan_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_subscribe_plan_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">,</span> <span class="n">send_invoice_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer.send_invoice&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscribe_plan_string</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_create_mock</span><span class="p">,</span>
    <span class="n">send_invoice_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">send_invoice_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_subscription_shortcut_with_invalid_subscriptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_subscription_shortcut_with_invalid_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_shortcut_with_invalid_subscriptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">fake_subscriptions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># update the status of all but one to be invalid,</span>
    <span class="c1"># we need to also change the id for sync to work</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;canceled&quot;</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;foo1&quot;</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;incomplete_expired&quot;</span>
    <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;foo2&quot;</span>

    <span class="k">for</span> <span class="n">fake_subscription</span> <span class="ow">in</span> <span class="n">fake_subscriptions</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
            <span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span>
            <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="n">fake_subscription</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">valid_subscriptions</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">valid_subscriptions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscription</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_subscriptions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_subscription_shortcut_with_multiple_subscriptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_subscription_shortcut_with_multiple_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.create&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_shortcut_with_multiple_subscriptions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_create_mock</span>
<span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">subscription_fake_duplicate</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake_duplicate</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sub_6lsC8pt7IcF8jd&quot;</span>

    <span class="n">subscription_create_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
        <span class="n">subscription_fake_duplicate</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span> <span class="n">charge_immediately</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">valid_subscriptions</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">MultipleSubscriptionException</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscription</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_customer.TestCustomerLegacy.test_upcoming_invoice" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_customer</span><span class="o">.</span><span class="n">TestCustomerLegacy</span><span class="o">.</span><span class="n">test_upcoming_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_customer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.upcoming&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_UPCOMING_INVOICE</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_upcoming_invoice</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_upcoming_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">upcoming_invoice</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">save</span><span class="p">())</span>

    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">invoice</span><span class="o">.</span><span class="n">_invoiceitems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_decorators" class="doc doc-heading">
        <code>tests.test_decorators</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Decorator Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_decorators-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_decorators.TestSubscriptionPaymentRequired" class="doc doc-heading">
        <code>
tests.test_decorators.TestSubscriptionPaymentRequired        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_decorators.TestSubscriptionPaymentRequired-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_decorators.TestSubscriptionPaymentRequired.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_decorators</span><span class="o">.</span><span class="n">TestSubscriptionPaymentRequired</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_decorators.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ROOT_URLCONF</span><span class="o">=</span><span class="s2">&quot;tests.urls&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">RequestFactory</span><span class="p">()</span>

    <span class="nd">@subscription_payment_required</span>
    <span class="k">def</span> <span class="nf">test_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>

    <span class="nd">@subscription_payment_required</span><span class="p">(</span><span class="n">pay_page</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_view_bad</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">test_view</span> <span class="o">=</span> <span class="n">test_view</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">test_view_bad</span> <span class="o">=</span> <span class="n">test_view_bad</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_decorators.TestSubscriptionPaymentRequired.test_anonymous" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_decorators</span><span class="o">.</span><span class="n">TestSubscriptionPaymentRequired</span><span class="o">.</span><span class="n">test_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_decorators.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/account/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">AnonymousUser</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ImproperlyConfigured</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_view</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_decorators.TestSubscriptionPaymentRequired.test_direct" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_decorators</span><span class="o">.</span><span class="n">TestSubscriptionPaymentRequired</span><span class="o">.</span><span class="n">test_direct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_decorators.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_direct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">subscription_payment_required</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_decorators.TestSubscriptionPaymentRequired.test_user_active_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_decorators</span><span class="o">.</span><span class="n">TestSubscriptionPaymentRequired</span><span class="o">.</span><span class="n">test_user_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_decorators.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_user_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">))</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">FUTURE_DATE</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/account/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_view</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_decorators.TestSubscriptionPaymentRequired.test_user_unpaid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_decorators</span><span class="o">.</span><span class="n">TestSubscriptionPaymentRequired</span><span class="o">.</span><span class="n">test_user_unpaid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_decorators.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_user_unpaid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/account/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_view</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ImproperlyConfigured</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_view_bad</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_django" class="doc doc-heading">
        <code>tests.test_django</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_django.TestRunManagePyCheck" class="doc doc-heading">
        <code>
tests.test_django.TestRunManagePyCheck        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_django.TestRunManagePyCheck.test_manage_py_check" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_django</span><span class="o">.</span><span class="n">TestRunManagePyCheck</span><span class="o">.</span><span class="n">test_manage_py_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_django.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_manage_py_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">call_command</span><span class="p">(</span><span class="s2">&quot;check&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_enums" class="doc doc-heading">
        <code>tests.test_enums</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_enums.TestEnumMetaClass" class="doc doc-heading">
        <code>
tests.test_enums.TestEnumMetaClass        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_enums.TestEnumMetaClass.test_python2_prepare" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_enums</span><span class="o">.</span><span class="n">TestEnumMetaClass</span><span class="o">.</span><span class="n">test_python2_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_enums.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_python2_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Python 2 hack to ensure __prepare__ is called...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">EnumMetaClass</span><span class="o">.</span><span class="fm">__prepare__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">OrderedDict</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_event" class="doc doc-heading">
        <code>tests.test_event</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Event Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_event-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_event.EventRaceConditionTest" class="doc doc-heading">
        <code>
tests.test_event.EventRaceConditionTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventRaceConditionTest.test_process_event_race_condition" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventRaceConditionTest</span><span class="o">.</span><span class="n">test_process_event_race_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_process_event_race_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">):</span>
    <span class="n">transfer</span> <span class="o">=</span> <span class="n">Transfer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">))</span>
    <span class="n">transfer_retrieve_mock</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
    <span class="n">event_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>

    <span class="c1"># emulate the race condition in _get_or_create_from_stripe_object where</span>
    <span class="c1"># an object is created by a different request during the call</span>
    <span class="c1">#</span>
    <span class="c1"># Sequence of events:</span>
    <span class="c1"># 1) first Transfer.stripe_objects.get fails with DoesNotExist</span>
    <span class="c1">#    (due to it not existing in reality, but due to our side_effect in the test)</span>
    <span class="c1"># 2) object is really created by a different request in reality</span>
    <span class="c1"># 3) Transfer._create_from_stripe_object fails with IntegrityError due to</span>
    <span class="c1">#    duplicate id</span>
    <span class="c1"># 4) second Transfer.stripe_objects.get succeeds</span>
    <span class="c1">#    (due to being created by step 2 in reality, due to side effect in the test)</span>
    <span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">Transfer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(),</span> <span class="n">transfer</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;djstripe.models.Transfer.stripe_objects.get&quot;</span><span class="p">,</span>
        <span class="n">side_effect</span><span class="o">=</span><span class="n">side_effect</span><span class="p">,</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">transfer_objects_get_mock</span><span class="p">:</span>
        <span class="n">Event</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transfer_objects_get_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transfer_retrieve_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event.EventTest" class="doc doc-heading">
        <code>
tests.test_event.EventTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_event.EventTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">webhooks</span><span class="p">,</span> <span class="s2">&quot;call_handlers&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">call_handlers</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.test_invoke_webhook_handlers_event_when_invalid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">test_invoke_webhook_handlers_event_when_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_invoke_webhook_handlers_event_when_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.test_invoke_webhook_handlers_event_with_log_stripe_error" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">test_invoke_webhook_handlers_event_with_log_stripe_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_invoke_webhook_handlers_event_with_log_stripe_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">call_handlers</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">StripeError</span><span class="p">(</span><span class="s2">&quot;Boom!&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">StripeError</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.test_invoke_webhook_handlers_event_with_raise_stripe_error" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">test_invoke_webhook_handlers_event_with_raise_stripe_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_invoke_webhook_handlers_event_with_raise_stripe_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">call_handlers</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">StripeError</span><span class="p">(</span><span class="s2">&quot;Boom!&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">StripeError</span><span class="p">):</span>
        <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.test_process_event" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">test_process_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_objects</span><span class="p">,</span> <span class="n">mock__create_from_stripe_object</span><span class="p">,</span> <span class="n">mock_atomic</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Test that process event creates a new event and invokes webhooks
when the event doesn't already exist.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;djstripe.models.core.transaction.atomic&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;_create_from_stripe_object&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;objects&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_process_event</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">mock_objects</span><span class="p">,</span> <span class="n">mock__create_from_stripe_object</span><span class="p">,</span> <span class="n">mock_atomic</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that process event creates a new event and invokes webhooks</span>
<span class="sd">    when the event doesn&#39;t already exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up mocks</span>
    <span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">exists</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mock_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;foo_id&quot;</span><span class="p">,</span> <span class="s2">&quot;other_stuff&quot;</span><span class="p">:</span> <span class="s2">&quot;more_things&quot;</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mock_data</span><span class="p">)</span>

    <span class="c1"># Check that all the expected work was performed</span>
    <span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">mock_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">exists</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
    <span class="n">mock_atomic</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
    <span class="n">mock__create_from_stripe_object</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock_data</span><span class="p">)</span>
    <span class="p">(</span>
        <span class="n">mock__create_from_stripe_object</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span>
    <span class="p">)</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
    <span class="c1"># Make sure the event was returned.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mock__create_from_stripe_object</span><span class="o">.</span><span class="n">return_value</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.test_process_event_exists" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">test_process_event_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_objects</span><span class="p">,</span> <span class="n">mock__create_from_stripe_object</span><span class="p">,</span> <span class="n">mock_atomic</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Test that process event returns the existing event and skips webhook processing
when the event already exists.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;djstripe.models.core.transaction.atomic&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;_create_from_stripe_object&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;objects&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_process_event_exists</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">mock_objects</span><span class="p">,</span> <span class="n">mock__create_from_stripe_object</span><span class="p">,</span> <span class="n">mock_atomic</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that process event returns the existing event and skips webhook processing</span>
<span class="sd">    when the event already exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up mocks</span>
    <span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">exists</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;foo_id&quot;</span><span class="p">,</span> <span class="s2">&quot;other_stuff&quot;</span><span class="p">:</span> <span class="s2">&quot;more_things&quot;</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mock_data</span><span class="p">)</span>

    <span class="c1"># Make sure that the db was queried and the existing results used.</span>
    <span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">mock_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">exists</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
    <span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
    <span class="c1"># Make sure the webhook actions and event object creation were not performed.</span>
    <span class="n">mock_atomic</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">mock__create_from_stripe_object</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="p">(</span>
        <span class="n">mock__create_from_stripe_object</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span>
    <span class="p">)</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="c1"># Make sure the existing event was returned.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mock_objects</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.test_process_event_failure_rolls_back" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">test_process_event_failure_rolls_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_webhook_handlers_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Test that process event rolls back event creation on error</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Event.invoke_webhook_handlers&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_process_event_failure_rolls_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_webhook_handlers_mock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that process event rolls back event creation on error&quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">HandlerException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">invoke_webhook_handlers_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">HandlerException</span>
    <span class="n">real_create_from_stripe_object</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">_create_from_stripe_object</span>

    <span class="k">def</span> <span class="nf">side_effect</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">real_create_from_stripe_object</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">event_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">HandlerException</span><span class="p">),</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;djstripe.models.Event._create_from_stripe_object&quot;</span><span class="p">,</span>
        <span class="n">side_effect</span><span class="o">=</span><span class="n">side_effect</span><span class="p">,</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">create_from_stripe_object_mock</span><span class="p">:</span>
        <span class="n">Event</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">event_data</span><span class="p">)</span>

    <span class="n">create_from_stripe_object_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event.EventTest.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event</span><span class="o">.</span><span class="n">EventTest</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;&lt;type=</span><span class="si">{type}</span><span class="s2">, id=</span><span class="si">{id}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_event_handlers" class="doc doc-heading">
        <code>tests.test_event_handlers</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Event Handler tests</p>



  <div class="doc doc-children">





<h4 id="tests.test_event_handlers-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.EventTestCase" class="doc doc-heading">
        <code>
tests.test_event_handlers.EventTestCase        </code>



</h5>

    <div class="doc doc-contents ">




    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestAccountEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestAccountEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestAccountEvents.test_account_deauthorized_event" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestAccountEvents</span><span class="o">.</span><span class="n">test_account_deauthorized_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_account_deauthorized_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_ACCOUNT_APPLICATION_DEAUTHORIZED</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestChargeEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestChargeEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_event_handlers.TestChargeEvents-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestChargeEvents.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestChargeEvents</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestChargeEvents.test_charge_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestChargeEvents</span><span class="o">.</span><span class="n">test_charge_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_charge_created</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">event_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CHARGE_SUCCEEDED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">charge_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>
    <span class="n">account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">charge</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
        <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestCustomerEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestCustomerEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_event_handlers.TestCustomerEvents-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_bogus_event_type" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_bogus_event_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_bogus_event_type</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_CREATED</span><span class="p">)</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;customer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
        <span class="s2">&quot;object&quot;</span>
    <span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;customer.praised&quot;</span>

    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">customer_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_card_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_card_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_card_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">brand</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;brand&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">last4</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;last4&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_default_source_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_default_source_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_default_source_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span> <span class="o">=</span> <span class="n">DjstripePaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_CARD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_valid_source</span><span class="p">())</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">has_valid_source</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">date_purged</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_discount_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_discount_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Coupon.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_COUPON</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_EVENT_CUSTOMER_DISCOUNT_CREATED</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_discount_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_DISCOUNT_CREATED</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_discount_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_discount_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Coupon.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_COUPON</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_EVENT_CUSTOMER_DISCOUNT_DELETED</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_discount_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">coupon_retrieve_mock</span><span class="p">):</span>
    <span class="n">coupon</span> <span class="o">=</span> <span class="n">Coupon</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_COUPON</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span> <span class="o">=</span> <span class="n">coupon</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_DISCOUNT_DELETED</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">coupon</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_source_double_delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_source_double_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_source_double_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_DELETED_DUPE</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_subscription_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_subscription_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_subscription_created</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">event_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SUBSCRIPTION_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">subscription</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_subscription_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_subscription_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_subscription_deleted</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SUBSCRIPTION_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">sub</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_CANCELED</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SUBSCRIPTION_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">sub</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="c1"># Check that Subscription is canceled and not deleted</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">canceled_at</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestCustomerEvents.test_customer_unknown_source_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestCustomerEvents</span><span class="o">.</span><span class="n">test_customer_unknown_source_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_customer_unknown_source_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CUSTOMER_SOURCE_CREATED</span><span class="p">)</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span>
        <span class="s2">&quot;id&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;card_xxx_test_customer_unk_source_created&quot;</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>

    <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">Card</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestDisputeEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestDisputeEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestDisputeEvents.test_dispute_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestDisputeEvents</span><span class="o">.</span><span class="n">test_dispute_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">dispute_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Dispute.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_DISPUTE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_DISPUTE_CREATED</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_dispute_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">dispute_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_DISPUTE_CREATED</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
    <span class="n">dispute</span> <span class="o">=</span> <span class="n">Dispute</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dispute</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_DISPUTE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestInvoiceEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestInvoiceEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestInvoiceEvents.test_invoice_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestInvoiceEvents</span><span class="o">.</span><span class="n">test_invoice_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_created</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">event_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICE_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>

    <span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">amount_due</span><span class="p">,</span>
        <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;amount_due&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">paid</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;paid&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestInvoiceEvents.test_invoice_created_no_existing_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestInvoiceEvents</span><span class="o">.</span><span class="n">test_invoice_created_no_existing_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_created_no_existing_customer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">event_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICE_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>

    <span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestInvoiceEvents.test_invoice_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestInvoiceEvents</span><span class="o">.</span><span class="n">test_invoice_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_deleted</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICE_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_INVOICE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICE_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Invoice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_INVOICE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestInvoiceEvents.test_invoice_upcoming" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestInvoiceEvents</span><span class="o">.</span><span class="n">test_invoice_upcoming</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_invoice_upcoming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Ensure that invoice upcoming events are processed - No actual</span>
    <span class="c1"># process occurs so the operation is an effective no-op.</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICE_UPCOMING</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestInvoiceItemEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestInvoiceItemEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestInvoiceItemEvents.test_invoiceitem_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestInvoiceItemEvents</span><span class="o">.</span><span class="n">test_invoiceitem_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">invoiceitem_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.InvoiceItem.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoiceitem_created</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">event_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoiceitem_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="n">FAKE_CUSTOMER_II</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICEITEM_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>

    <span class="n">invoiceitem_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoiceitem</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
        <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestInvoiceItemEvents.test_invoiceitem_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestInvoiceItemEvents</span><span class="o">.</span><span class="n">test_invoiceitem_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">invoiceitem_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.InvoiceItem.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoiceitem_deleted</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoiceitem_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="n">FAKE_CUSTOMER_II</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICEITEM_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_INVOICEITEM</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_INVOICEITEM_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InvoiceItem</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_INVOICEITEM</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestPaymentIntentEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestPaymentIntentEvents        </code>



</h5>

    <div class="doc doc-contents ">

      <p>Test case for payment intent event handling.</p>




  <div class="doc doc-children">







<h6 id="tests.test_event_handlers.TestPaymentIntentEvents-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPaymentIntentEvents.test_payment_intent_succeeded_with_destination_charge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPaymentIntentEvents</span><span class="o">.</span><span class="n">test_payment_intent_succeeded_with_destination_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">account_retrieve_mock</span><span class="p">,</span> <span class="n">file_upload_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Test that the payment intent succeeded event can create all related objects.</p>
<p>This should exercise the machinery to set <code>stripe_account</code> when recursing into
objects related to a connect <code>Account</code>.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_ACCOUNT</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">)),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_DESTINATION_CHARGE</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_payment_intent_succeeded_with_destination_charge</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">account_retrieve_mock</span><span class="p">,</span>
    <span class="n">file_upload_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_method_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that the payment intent succeeded event can create all related objects.</span>

<span class="sd">    This should exercise the machinery to set `stripe_account` when recursing into</span>
<span class="sd">    objects related to a connect `Account`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span>
        <span class="n">FAKE_EVENT_PAYMENT_INTENT_SUCCEEDED_DESTINATION_CHARGE</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="c1"># Make sure the file uploads were retrieved using the account ID.</span>
    <span class="n">file_upload_retrieve_mock</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
                <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
                <span class="n">stripe_account</span><span class="o">=</span><span class="n">FAKE_ACCOUNT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
                <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span>
                <span class="n">stripe_account</span><span class="o">=</span><span class="n">FAKE_ACCOUNT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestPaymentMethodEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestPaymentMethodEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_event_handlers.TestPaymentMethodEvents-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPaymentMethodEvents.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPaymentMethodEvents</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;fake_customer_1&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPaymentMethodEvents.test_card_payment_method_attached" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPaymentMethodEvents</span><span class="o">.</span><span class="n">test_card_payment_method_attached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_card_payment_method_attached</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span>
<span class="p">):</span>
    <span class="c1"># Attach of a legacy id=&quot;card_xxx&quot; payment method should behave exactly</span>
    <span class="c1"># as per a normal &quot;native&quot; id=&quot;pm_yyy&quot; payment_method.</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CARD_PAYMENT_METHOD_ATTACHED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">payment_method_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPaymentMethodEvents.test_card_payment_method_detached" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPaymentMethodEvents</span><span class="o">.</span><span class="n">test_card_payment_method_detached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No such payment_method: card_xxxx&quot;</span><span class="p">,</span>
        <span class="n">param</span><span class="o">=</span><span class="s2">&quot;payment_method&quot;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="s2">&quot;resource_missing&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_card_payment_method_detached</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span>
<span class="p">):</span>
    <span class="c1"># Detach of a legacy id=&quot;card_xxx&quot; payment method is handled specially,</span>
    <span class="c1"># since the card is deleted by Stripe and therefore PaymetMethod.retrieve fails</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_CARD_PAYMENT_METHOD_DETACHED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">payment_method_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;Detach of a &#39;card_&#39; payment_method should delete it&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPaymentMethodEvents.test_payment_method_attached" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPaymentMethodEvents</span><span class="o">.</span><span class="n">test_payment_method_attached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_payment_method_attached</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_PAYMENT_METHOD_ATTACHED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">payment_method_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPaymentMethodEvents.test_payment_method_detached" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPaymentMethodEvents</span><span class="o">.</span><span class="n">test_payment_method_detached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_payment_method_detached</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">payment_method_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_PAYMENT_METHOD_DETACHED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">payment_method_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span>
        <span class="s2">&quot;Detach of a payment_method should set customer to null&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.PaymentMethod.customer&quot;</span><span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestPlanEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestPlanEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPlanEvents.test_plan_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPlanEvents</span><span class="o">.</span><span class="n">test_plan_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_plan_created</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_PLAN_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">nickname</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;nickname&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPlanEvents.test_plan_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPlanEvents</span><span class="o">.</span><span class="n">test_plan_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_PLAN</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_plan_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">):</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_PLAN_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_PLAN_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Plan</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPlanEvents.test_plan_updated_request_object" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPlanEvents</span><span class="o">.</span><span class="n">test_plan_updated_request_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_PLAN</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_EVENT_PLAN_REQUEST_IS_OBJECT</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_plan_updated_request_object</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">FAKE_EVENT_PLAN_REQUEST_IS_OBJECT</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
        <span class="s2">&quot;object&quot;</span>
    <span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_EVENT_PLAN_REQUEST_IS_OBJECT</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_PLAN_REQUEST_IS_OBJECT</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">plan</span><span class="o">.</span><span class="n">nickname</span><span class="p">,</span>
        <span class="n">FAKE_EVENT_PLAN_REQUEST_IS_OBJECT</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;nickname&quot;</span><span class="p">],</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestPriceEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestPriceEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPriceEvents.test_price_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPriceEvents</span><span class="o">.</span><span class="n">test_price_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_price_created</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_PRICE_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">price_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">price</span><span class="o">.</span><span class="n">nickname</span><span class="p">,</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;nickname&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPriceEvents.test_price_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPriceEvents</span><span class="o">.</span><span class="n">test_price_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_PRICE</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_price_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">):</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_PRICE_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PRICE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_PRICE_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Price</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PRICE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestPriceEvents.test_price_updated" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestPriceEvents</span><span class="o">.</span><span class="n">test_price_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_PRICE</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_EVENT_PRICE_UPDATED</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_price_updated</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">price_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">FAKE_EVENT_PRICE_UPDATED</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_EVENT_PRICE_UPDATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_PRICE_UPDATED</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">price</span><span class="o">.</span><span class="n">unit_amount</span><span class="p">,</span>
        <span class="n">FAKE_EVENT_PRICE_UPDATED</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;unit_amount&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">price</span><span class="o">.</span><span class="n">unit_amount_decimal</span><span class="p">,</span>
        <span class="n">Decimal</span><span class="p">(</span><span class="n">FAKE_EVENT_PRICE_UPDATED</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;unit_amount_decimal&quot;</span><span class="p">]),</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestSubscriptionScheduleEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestSubscriptionScheduleEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestSubscriptionScheduleEvents.test_subscription_schedule_canceled" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestSubscriptionScheduleEvents</span><span class="o">.</span><span class="n">test_subscription_schedule_canceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.SubscriptionSchedule.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_schedule_canceled</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span>
<span class="p">):</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_UPDATED</span><span class="p">)</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1605058030</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;canceled&quot;</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;previous_attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;canceled_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not_started&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">schedule_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">schedule</span> <span class="o">=</span> <span class="n">SubscriptionSchedule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;canceled&quot;</span>
    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">canceled_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">schedule_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CANCELED</span><span class="p">[</span>
        <span class="s2">&quot;data&quot;</span>
    <span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CANCELED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">schedule</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;canceled&quot;</span>
    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">canceled_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestSubscriptionScheduleEvents.test_subscription_schedule_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestSubscriptionScheduleEvents</span><span class="o">.</span><span class="n">test_subscription_schedule_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.SubscriptionSchedule.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION_SCHEDULE</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_schedule_created</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span>
<span class="p">):</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">schedule</span> <span class="o">=</span> <span class="n">SubscriptionSchedule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">schedule</span><span class="o">.</span><span class="n">id</span>
        <span class="o">==</span> <span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_started&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestSubscriptionScheduleEvents.test_subscription_schedule_released" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestSubscriptionScheduleEvents</span><span class="o">.</span><span class="n">test_subscription_schedule_released</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.SubscriptionSchedule.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_schedule_released</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span>
<span class="p">):</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_UPDATED</span><span class="p">)</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;released_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1605058030</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;released&quot;</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;previous_attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;released_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not_started&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">schedule_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">schedule</span> <span class="o">=</span> <span class="n">SubscriptionSchedule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;released&quot;</span>
    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">released_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">schedule_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_RELEASED</span><span class="p">[</span>
        <span class="s2">&quot;data&quot;</span>
    <span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_RELEASED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">schedule</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;released&quot;</span>
    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">released_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestSubscriptionScheduleEvents.test_subscription_schedule_updated" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestSubscriptionScheduleEvents</span><span class="o">.</span><span class="n">test_subscription_schedule_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.SubscriptionSchedule.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_subscription_schedule_updated</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">schedule_retrieve_mock</span>
<span class="p">):</span>

    <span class="n">schedule_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED</span><span class="p">[</span>
        <span class="s2">&quot;data&quot;</span>
    <span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">schedule</span> <span class="o">=</span> <span class="n">SubscriptionSchedule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_CREATED</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_started&quot;</span>
    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">released_at</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_SUBSCRIPTION_SCHEDULE_UPDATED</span><span class="p">)</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;released_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1605058030</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;released&quot;</span>
    <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;previous_attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;released_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not_started&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">schedule_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">schedule</span> <span class="o">=</span> <span class="n">SubscriptionSchedule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;released&quot;</span>
    <span class="k">assert</span> <span class="n">schedule</span><span class="o">.</span><span class="n">released_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_event_handlers.TestTransferEvents" class="doc doc-heading">
        <code>
tests.test_event_handlers.TestTransferEvents        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestTransferEvents.test_transfer_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestTransferEvents</span><span class="o">.</span><span class="n">test_transfer_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_transfer_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_stripe_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span>
    <span class="n">transfer_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_stripe_event</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">transfer</span> <span class="o">=</span> <span class="n">Transfer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">transfer</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
        <span class="n">fake_stripe_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_event_handlers.TestTransferEvents.test_transfer_deleted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_event_handlers</span><span class="o">.</span><span class="n">TestTransferEvents</span><span class="o">.</span><span class="n">test_transfer_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_event_handlers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_TRANSFER</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_transfer_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="n">Transfer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_TRANSFER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Transfer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="n">Transfer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_TRANSFER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_DELETED</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">invoke_webhook_handlers</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_fields" class="doc doc-heading">
        <code>tests.test_fields</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Custom Field Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_fields.TestStripeCurrencyField" class="doc doc-heading">
        <code>
tests.test_fields.TestStripeCurrencyField        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h7 id="tests.test_fields.TestStripeCurrencyField.noval" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_fields</span><span class="o">.</span><span class="n">TestStripeCurrencyField</span><span class="o">.</span><span class="n">noval</span></code>


</h7>

    <div class="doc doc-contents ">

    </div>

  </div>






  <div class="doc doc-object doc-method">



<h7 id="tests.test_fields.TestStripeCurrencyField.test_stripe_to_db_none_val" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_fields</span><span class="o">.</span><span class="n">TestStripeCurrencyField</span><span class="o">.</span><span class="n">test_stripe_to_db_none_val</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_stripe_to_db_none_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noval</span><span class="o">.</span><span class="n">stripe_to_db</span><span class="p">({</span><span class="s2">&quot;noval&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_file_upload" class="doc doc-heading">
        <code>tests.test_file_upload</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






<h4 id="tests.test_file_upload-functions">Functions</h4>

  <div class="doc doc-object doc-function">



<h5 id="tests.test_file_upload.test_file_upload_api_retrieve" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_file_upload</span><span class="o">.</span><span class="n">test_file_upload_api_retrieve</span><span class="p">(</span><span class="n">mock_file_upload_retrieve</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Expect file_upload to use the ID of the account referring
to it to retrieve itself.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_file_upload.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="s2">&quot;stripe.FileUpload.retrieve&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_file_upload_api_retrieve</span><span class="p">(</span><span class="n">mock_file_upload_retrieve</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expect file_upload to use the ID of the account referring</span>
<span class="sd">    to it to retrieve itself.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create files</span>
    <span class="n">icon_file</span> <span class="o">=</span> <span class="n">FileUpload</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">FAKE_FILEUPLOAD_ICON</span><span class="p">)[</span>
        <span class="mi">0</span>
    <span class="p">]</span>
    <span class="n">logo_file</span> <span class="o">=</span> <span class="n">FileUpload</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">FAKE_FILEUPLOAD_LOGO</span><span class="p">)[</span>
        <span class="mi">0</span>
    <span class="p">]</span>
    <span class="c1"># Create account to associate the files to it</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">_get_or_create_from_stripe_object</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">FAKE_ACCOUNT</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Call the API retrieve methods.</span>
    <span class="n">icon_file</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">logo_file</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>

    <span class="c1"># Ensure the correct Account ID was used in retrieval</span>
    <span class="n">mock_file_upload_retrieve</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">call</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">icon_file</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">stripe_account</span><span class="o">=</span><span class="n">account</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="n">call</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">logo_file</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">stripe_account</span><span class="o">=</span><span class="n">account</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_idempotency_keys" class="doc doc-heading">
        <code>tests.test_idempotency_keys</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_idempotency_keys.IdempotencyKeyTest" class="doc doc-heading">
        <code>
tests.test_idempotency_keys.IdempotencyKeyTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_idempotency_keys.IdempotencyKeyTest.test_clear_expired_idempotency_keys" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_idempotency_keys</span><span class="o">.</span><span class="n">IdempotencyKeyTest</span><span class="o">.</span><span class="n">test_clear_expired_idempotency_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_idempotency_keys.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_clear_expired_idempotency_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expired_key</span> <span class="o">=</span> <span class="n">get_idempotency_key</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;create:1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">expired_key_obj</span> <span class="o">=</span> <span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">expired_key</span><span class="p">)</span>
    <span class="n">expired_key_obj</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">expired_key_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">valid_key</span> <span class="o">=</span> <span class="n">get_idempotency_key</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;create:2&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">clear_expired_idempotency_keys</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="n">valid_key</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_idempotency_keys.IdempotencyKeyTest.test_generate_idempotency_key" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_idempotency_keys</span><span class="o">.</span><span class="n">IdempotencyKeyTest</span><span class="o">.</span><span class="n">test_generate_idempotency_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_idempotency_keys.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_generate_idempotency_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">key1</span> <span class="o">=</span> <span class="n">get_idempotency_key</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;create:1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">key2</span> <span class="o">=</span> <span class="n">get_idempotency_key</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;create:1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">key1</span> <span class="o">==</span> <span class="n">key2</span><span class="p">)</span>

    <span class="n">key3</span> <span class="o">=</span> <span class="n">get_idempotency_key</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;create:2&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">key1</span> <span class="o">!=</span> <span class="n">key3</span><span class="p">)</span>

    <span class="n">key4</span> <span class="o">=</span> <span class="n">get_idempotency_key</span><span class="p">(</span><span class="s2">&quot;charge&quot;</span><span class="p">,</span> <span class="s2">&quot;create:1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">key1</span> <span class="o">!=</span> <span class="n">key4</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">key1_obj</span> <span class="o">=</span> <span class="n">IdempotencyKey</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;customer:create:1&quot;</span><span class="p">,</span> <span class="n">livemode</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">key1_obj</span><span class="o">.</span><span class="n">is_expired</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key1_obj</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">key1_obj</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_integrations" class="doc doc-heading">
        <code>tests.test_integrations</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">



    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_invoice" class="doc doc-heading">
        <code>tests.test_invoice</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Invoice Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_invoice-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_invoice.InvoiceTest" class="doc doc-heading">
        <code>
tests.test_invoice.InvoiceTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_invoice.InvoiceTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.pending_setup_intent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.schedule&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_billing_reason_enum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_billing_reason_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_billing_reason_enum</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">fake_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">billing_reason</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;subscription_cycle&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subscription_create&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subscription_update&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subscription&quot;</span><span class="p">,</span>
        <span class="s2">&quot;manual&quot;</span><span class="p">,</span>
        <span class="s2">&quot;upcoming&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subscription_threshold&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fake_invoice</span><span class="p">[</span><span class="s2">&quot;billing_reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">billing_reason</span>

        <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_invoice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">billing_reason</span><span class="p">,</span> <span class="n">billing_reason</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_invoice_plan_from_invoice_items" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_invoice_plan_from_invoice_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_plan_from_invoice_items</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>  <span class="c1"># retrieved from invoice item</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_invoice_plan_from_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_invoice_plan_from_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_plan_from_subscription</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>  <span class="c1"># retrieved from subscription</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_invoice_status_enum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_invoice_status_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_status_enum</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">fake_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;draft&quot;</span><span class="p">,</span>
        <span class="s2">&quot;open&quot;</span><span class="p">,</span>
        <span class="s2">&quot;paid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;uncollectible&quot;</span><span class="p">,</span>
        <span class="s2">&quot;void&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fake_invoice</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>

        <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_invoice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_invoice_with_no_invoice_items" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_invoice_with_no_invoice_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_with_no_invoice_items</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>  <span class="c1"># retrieved from invoice item</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_invoice_with_non_subscription_invoice_items" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_invoice_with_non_subscription_invoice_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_with_non_subscription_invoice_items</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM_II</span><span class="p">))</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">][</span><span class="s2">&quot;total_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_invoice_with_subscription_invoice_items" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_invoice_with_subscription_invoice_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_with_subscription_invoice_items</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="c1"># Previously the test asserted item_id=&quot;{invoice_id}-{subscription_id}&quot;,</span>
    <span class="c1"># but this doesn&#39;t match what I&#39;m seeing from Stripe</span>
    <span class="c1"># I&#39;m not sure if it&#39;s possible to predict the whole item id now,</span>
    <span class="c1"># sli seems to not reference anything</span>
    <span class="n">item_id_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{invoice_id}</span><span class="s2">-il_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">invoice_id</span><span class="o">=</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">item_id_prefix</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_invoice_without_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_invoice_without_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invoice_without_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">invoice</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Invoice.subscription&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_no_upcoming_invoices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_no_upcoming_invoices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.upcoming&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;Nothing to invoice for customer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_no_upcoming_invoices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">upcoming</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_retry_false" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_retry_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_retry_false</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_invoice</span>

    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_invoice</span><span class="p">)</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">retry</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_retry_true" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_retry_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_retry_true</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">fake_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">fake_invoice</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;paid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;open&quot;</span><span class="p">})</span>
    <span class="n">fake_invoice</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;auto_advance&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_invoice</span>

    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_invoice</span><span class="p">)</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">retry</span><span class="p">()</span>

    <span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="p">[],</span> <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_status_draft" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_status_draft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_draft</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;paid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;draft&quot;</span><span class="p">})</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">InvoiceStatus</span><span class="o">.</span><span class="n">draft</span><span class="p">,</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_status_open" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_status_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_open</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;paid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;open&quot;</span><span class="p">})</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">InvoiceStatus</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_status_paid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_status_paid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_paid</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">InvoiceStatus</span><span class="o">.</span><span class="n">paid</span><span class="p">,</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_status_uncollectible" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_status_uncollectible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_uncollectible</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;paid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;uncollectible&quot;</span><span class="p">})</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">InvoiceStatus</span><span class="o">.</span><span class="n">uncollectible</span><span class="p">,</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_status_void" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_status_void</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_void</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;paid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;void&quot;</span><span class="p">})</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">InvoiceStatus</span><span class="o">.</span><span class="n">void</span><span class="p">,</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">invoice</span><span class="p">),</span> <span class="s2">&quot;Invoice #</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">status_transitions</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">account_country</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">account_name</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">collection_method</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">first_tax_amount</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">first_tax_amount</span><span class="o">.</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">first_tax_amount</span><span class="o">.</span><span class="n">inclusive</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;inclusive&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_tax_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="mi">261</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_sync_from_stripe_data_default_payment_method" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_default_payment_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_default_payment_method</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">fake_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">fake_invoice</span><span class="p">[</span><span class="s2">&quot;default_payment_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">)</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_invoice</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">default_payment_method</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">invoice</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;djstripe.Invoice.default_payment_method&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_sync_from_stripe_data_update_total_tax_amounts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_update_total_tax_amounts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data_update_total_tax_amounts</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">))</span>

    <span class="c1"># as per basic sync test</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">first_tax_amount</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">first_tax_amount</span><span class="o">.</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">first_tax_amount</span><span class="o">.</span><span class="n">inclusive</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;inclusive&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_tax_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="mi">261</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoice</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>

    <span class="c1"># Now update with a different tax rate</span>
    <span class="c1"># TODO - should update tax rate in invoice items etc as well,</span>
    <span class="c1">#  but here we&#39;re mainly testing that invoice.total_tax_rates is</span>
    <span class="c1">#  correctly updated</span>
    <span class="n">fake_updated_invoice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">fake_tax_rate_2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TAX_RATE_EXAMPLE_2_SALES</span><span class="p">)</span>

    <span class="n">new_tax_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">fake_updated_invoice</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fake_tax_rate_2</span><span class="p">[</span><span class="s2">&quot;percentage&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="p">)</span>

    <span class="n">fake_updated_invoice</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;default_tax_rates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fake_tax_rate_2</span><span class="p">],</span>
            <span class="s2">&quot;tax&quot;</span><span class="p">:</span> <span class="n">new_tax_amount</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">fake_updated_invoice</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_tax_amount</span><span class="p">,</span>
            <span class="s2">&quot;total_tax_amounts&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">new_tax_amount</span><span class="p">,</span>
                    <span class="s2">&quot;inclusive&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;tax_rate&quot;</span><span class="p">:</span> <span class="n">fake_tax_rate_2</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">invoice_updated</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_updated_invoice</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice_updated</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoice_updated</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">fake_tax_rate_2</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice_updated</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">first_tax_amount</span> <span class="o">=</span> <span class="n">invoice_updated</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_tax_amount</span><span class="o">.</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">fake_tax_rate_2</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_tax_amount</span><span class="o">.</span><span class="n">inclusive</span><span class="p">,</span> <span class="n">fake_tax_rate_2</span><span class="p">[</span><span class="s2">&quot;inclusive&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_tax_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">new_tax_amount</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">invoice_updated</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_sync_no_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_sync_no_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_no_subscription</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoice_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">)</span>
    <span class="n">invoice_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;subscription&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
    <span class="n">invoice_data</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;subscription&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoice_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">invoice</span><span class="o">.</span><span class="n">subscription</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># charge_retrieve_mock.assert_not_called()</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">invoice</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Invoice.subscription&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_upcoming_invoice" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_upcoming_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.upcoming&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_UPCOMING_INVOICE</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_upcoming_invoice</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_upcoming_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">UpcomingInvoice</span><span class="o">.</span><span class="n">upcoming</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">save</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">invoice</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># delete/update should do nothing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">update</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">delete</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">invoice</span><span class="o">.</span><span class="n">_invoiceitems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">invoiceitems</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoice</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">first_tax_amount</span> <span class="o">=</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total_tax_amounts</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">first_tax_amount</span><span class="o">.</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">first_tax_amount</span><span class="o">.</span><span class="n">inclusive</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;inclusive&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_tax_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="mi">261</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_upcoming_invoice_error" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_upcoming_invoice_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.upcoming&quot;</span><span class="p">,</span>
    <span class="n">side_effect</span><span class="o">=</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;Some other error&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_upcoming_invoice_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InvalidRequestError</span><span class="p">):</span>
        <span class="n">Invoice</span><span class="o">.</span><span class="n">upcoming</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_upcoming_invoice_with_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_upcoming_invoice_with_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.upcoming&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_UPCOMING_INVOICE</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_upcoming_invoice_with_subscription</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_upcoming_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">upcoming</span><span class="p">(</span>
        <span class="n">subscription</span><span class="o">=</span><span class="n">Subscription</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">save</span><span class="p">())</span>

    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoice.InvoiceTest.test_upcoming_invoice_with_subscription_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoice</span><span class="o">.</span><span class="n">InvoiceTest</span><span class="o">.</span><span class="n">test_upcoming_invoice_with_subscription_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">invoice_upcoming_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoice.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.upcoming&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_UPCOMING_INVOICE</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_upcoming_invoice_with_subscription_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">invoice_upcoming_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">invoice</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">upcoming</span><span class="p">(</span><span class="n">subscription_plan</span><span class="o">=</span><span class="n">Plan</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">save</span><span class="p">())</span>

    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">ANY</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoice</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_invoiceitem" class="doc doc-heading">
        <code>tests.test_invoiceitem</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe InvoiceItem Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_invoiceitem-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_invoiceitem.InvoiceItemTest" class="doc doc-heading">
        <code>
tests.test_invoiceitem.InvoiceItemTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_invoiceitem.InvoiceItemTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoiceitem.InvoiceItemTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoiceitem</span><span class="o">.</span><span class="n">InvoiceItemTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_invoiceitem.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.payment_intent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.pending_setup_intent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.schedule&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoiceitem.InvoiceItemTest.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoiceitem</span><span class="o">.</span><span class="n">InvoiceItemTest</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoiceitem.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoiceitem_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">)</span>
    <span class="n">invoiceitem_data</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAKE_PLAN_II</span>
    <span class="n">invoiceitem_data</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAKE_PRICE_II</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoiceitem</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span>
        <span class="n">invoiceitem</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">get_stripe_dashboard_url</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">invoiceitem</span><span class="p">)</span> <span class="o">==</span> <span class="n">invoiceitem</span><span class="o">.</span><span class="n">description</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoiceitem.InvoiceItemTest.test_sync_expanded_invoice_with_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoiceitem</span><span class="o">.</span><span class="n">InvoiceItemTest</span><span class="o">.</span><span class="n">test_sync_expanded_invoice_with_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoiceitem.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_expanded_invoice_with_subscription</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoiceitem_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">)</span>
    <span class="c1"># Expand the Invoice data</span>
    <span class="n">invoiceitem_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;subscription&quot;</span><span class="p">:</span> <span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">FAKE_INVOICE_II</span><span class="p">)),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>

    <span class="n">expected_blank_fks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">|</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.InvoiceItem.plan&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.InvoiceItem.price&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoiceitem</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="n">expected_blank_fks</span><span class="p">)</span>

    <span class="c1"># Coverage of sync of existing data</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoiceitem</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="n">expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoiceitem.InvoiceItemTest.test_sync_null_invoice" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoiceitem</span><span class="o">.</span><span class="n">InvoiceItemTest</span><span class="o">.</span><span class="n">test_sync_null_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoiceitem.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_null_invoice</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
    <span class="n">price_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoiceitem_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">)</span>
    <span class="n">invoiceitem_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;proration&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">FAKE_PLAN_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FAKE_PRICE_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;invoice&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoiceitem</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PRICE_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoiceitem</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">invoiceitem</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.InvoiceItem.invoice&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.InvoiceItem.subscription&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoiceitem.InvoiceItemTest.test_sync_proration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoiceitem</span><span class="o">.</span><span class="n">InvoiceItemTest</span><span class="o">.</span><span class="n">test_sync_proration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoiceitem.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_proration</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
    <span class="n">price_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoiceitem_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">)</span>
    <span class="n">invoiceitem_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;proration&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">FAKE_PLAN_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FAKE_PRICE_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoiceitem</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PRICE_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">invoiceitem</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">invoiceitem</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.InvoiceItem.subscription&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoiceitem.InvoiceItemTest.test_sync_with_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoiceitem</span><span class="o">.</span><span class="n">InvoiceItemTest</span><span class="o">.</span><span class="n">test_sync_with_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoiceitem.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_with_subscription</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoiceitem_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM</span><span class="p">)</span>
    <span class="n">invoiceitem_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;subscription&quot;</span><span class="p">:</span> <span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]})</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>

    <span class="n">expected_blank_fks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">|</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.InvoiceItem.plan&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.InvoiceItem.price&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoiceitem</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="n">expected_blank_fks</span><span class="p">)</span>

    <span class="c1"># Coverage of sync of existing data</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">invoiceitem</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="n">expected_blank_fks</span><span class="p">)</span>

    <span class="n">invoice_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_INVOICE_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_invoiceitem.InvoiceItemTest.test_sync_with_taxes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_invoiceitem</span><span class="o">.</span><span class="n">InvoiceItemTest</span><span class="o">.</span><span class="n">test_sync_with_taxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_retrieve_mock</span><span class="p">,</span> <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_invoiceitem.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_III</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Invoice.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_with_taxes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">invoice_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentintent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>

    <span class="n">invoiceitem_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICEITEM_III</span><span class="p">)</span>
    <span class="n">invoiceitem_data</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAKE_PLAN_II</span>
    <span class="n">invoiceitem_data</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAKE_PRICE_II</span>
    <span class="n">invoiceitem</span> <span class="o">=</span> <span class="n">InvoiceItem</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">invoiceitem_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">invoiceitem</span><span class="o">.</span><span class="n">tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">invoiceitem</span><span class="o">.</span><span class="n">tax_rates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_managers" class="doc doc-heading">
        <code>tests.test_managers</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Model Manager Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_managers-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_managers.ChargeManagerTest" class="doc doc-heading">
        <code>
tests.test_managers.ChargeManagerTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_managers.ChargeManagerTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.ChargeManagerTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">ChargeManagerTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;cus_XXXXXXX&quot;</span><span class="p">,</span> <span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">delinquent</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">march_charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXXMAR1&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">april_charge_1</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXXAPR1&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;20.15&quot;</span><span class="p">),</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;succeeded&quot;</span><span class="p">,</span>
        <span class="n">paid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">april_charge_2</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXXAPR2&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.35&quot;</span><span class="p">),</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.35&quot;</span><span class="p">),</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;succeeded&quot;</span><span class="p">,</span>
        <span class="n">paid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">april_charge_3</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXXAPR3&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;80.00&quot;</span><span class="p">),</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
        <span class="n">paid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">may_charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXXMAY1&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">november_charge</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXXNOV1&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">charge_2014</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXX20141&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">charge_2016</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;ch_XXXX20161&quot;</span><span class="p">,</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">amount_refunded</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.ChargeManagerTest.test_get_paid_totals_for_april_2015" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">ChargeManagerTest</span><span class="o">.</span><span class="n">test_get_paid_totals_for_april_2015</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_paid_totals_for_april_2015</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">paid_totals</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">paid_totals_for</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2015</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;30.50&quot;</span><span class="p">),</span>
        <span class="n">paid_totals</span><span class="p">[</span><span class="s2">&quot;total_amount&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Total amount is not correct.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.35&quot;</span><span class="p">),</span>
        <span class="n">paid_totals</span><span class="p">[</span><span class="s2">&quot;total_refunded&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Total amount refunded is not correct.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.ChargeManagerTest.test_is_during_april_2015" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">ChargeManagerTest</span><span class="o">.</span><span class="n">test_is_during_april_2015</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_is_during_april_2015</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">raw_charges</span> <span class="o">=</span> <span class="n">Charge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">during</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2015</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">charges</span> <span class="o">=</span> <span class="p">[</span><span class="n">charge</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">charge</span> <span class="ow">in</span> <span class="n">raw_charges</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">april_charge_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;April charge 1 not in charges.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">april_charge_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;April charge 2 not in charges.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">april_charge_3</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;April charge 3 not in charges.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">march_charge</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;March charge unexpectedly in charges.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">may_charge</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;May charge unexpectedly in charges.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">november_charge</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;November charge unexpectedly in charges.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_2014</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;2014 charge unexpectedly in charges.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_2016</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="s2">&quot;2016 charge unexpectedly in charges.&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_managers.SubscriptionManagerTest" class="doc doc-heading">
        <code>
tests.test_managers.SubscriptionManagerTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_managers.SubscriptionManagerTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># create customers and current subscription records</span>
    <span class="n">period_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">period_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
        <span class="mi">2013</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
    <span class="p">)</span>  <span class="c1"># more realistic start</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan2</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;patrick</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;patrick</span><span class="si">{0}</span><span class="s2">@example.com&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;cus_xxxxxxxxxxxxxx</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
            <span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">delinquent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;sub_xxxxxxxxxxxxxx</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
            <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
            <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">,</span>
            <span class="n">current_period_start</span><span class="o">=</span><span class="n">period_start</span><span class="p">,</span>
            <span class="n">current_period_end</span><span class="o">=</span><span class="n">period_end</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;active&quot;</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;patrick</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;patrick</span><span class="si">{0}</span><span class="s2">@example.com&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;cus_xxxxxxxxxxxxxx</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
        <span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">delinquent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;sub_xxxxxxxxxxxxxx</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">,</span>
        <span class="n">current_period_start</span><span class="o">=</span><span class="n">period_start</span><span class="p">,</span>
        <span class="n">current_period_end</span><span class="o">=</span><span class="n">period_end</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;canceled&quot;</span><span class="p">,</span>
        <span class="n">canceled_at</span><span class="o">=</span><span class="n">period_end</span><span class="p">,</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;patrick</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;patrick</span><span class="si">{0}</span><span class="s2">@example.com&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;cus_xxxxxxxxxxxxxx</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">livemode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">delinquent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;sub_xxxxxxxxxxxxxx</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span>
        <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plan2</span><span class="p">,</span>
        <span class="n">current_period_start</span><span class="o">=</span><span class="n">period_start</span><span class="p">,</span>
        <span class="n">current_period_end</span><span class="o">=</span><span class="n">period_end</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;active&quot;</span><span class="p">,</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_active_all" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_active_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_active_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">active</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">11</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_active_plan_summary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_active_plan_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_active_plan_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">active_plan_summary</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_canceled_all" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_canceled_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_canceled_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">canceled</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_canceled_during" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_canceled_during</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_canceled_during</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">canceled_during</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_canceled_plan_summary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_canceled_plan_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_canceled_plan_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">canceled_plan_summary_for</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_churn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_churn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_churn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">churn</span><span class="p">(),</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;11&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_started_during_has_records" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_started_during_has_records</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_started_during_has_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">started_during</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">12</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_started_during_no_records" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_started_during_no_records</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_started_during_no_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">started_during</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.SubscriptionManagerTest.test_started_plan_summary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">SubscriptionManagerTest</span><span class="o">.</span><span class="n">test_started_plan_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_started_plan_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">started_plan_summary_for</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">11</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_managers.TransferManagerTest" class="doc doc-heading">
        <code>
tests.test_managers.TransferManagerTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_managers.TransferManagerTest.test_transfer_summary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_managers</span><span class="o">.</span><span class="n">TransferManagerTest</span><span class="o">.</span><span class="n">test_transfer_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_managers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_transfer_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">Transfer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">))</span>
    <span class="n">Transfer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER_II</span><span class="p">))</span>
    <span class="n">Transfer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER_III</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Transfer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">during</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">totals</span> <span class="o">=</span> <span class="n">Transfer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">paid_totals_for</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">totals</span><span class="p">[</span><span class="s2">&quot;total_amount&quot;</span><span class="p">],</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;190.10&quot;</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_middleware" class="doc doc-heading">
        <code>tests.test_middleware</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Middleware Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_middleware-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_middleware.MiddlewareLogicTest" class="doc doc-heading">
        <code>
tests.test_middleware.MiddlewareLogicTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h7 id="tests.test_middleware.MiddlewareLogicTest.urlconf" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareLogicTest</span><span class="o">.</span><span class="n">urlconf</span></code>


</h7>

    <div class="doc doc-contents ">

    </div>

  </div>




<h6 id="tests.test_middleware.MiddlewareLogicTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareLogicTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareLogicTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ROOT_URLCONF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">RequestFactory</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span> <span class="o">=</span> <span class="n">SubscriptionPaymentMiddleware</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareLogicTest.test_anonymous" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareLogicTest</span><span class="o">.</span><span class="n">test_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/djstripe/webhook/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">AnonymousUser</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareLogicTest.test_customer_has_active_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareLogicTest</span><span class="o">.</span><span class="n">test_customer_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">FUTURE_DATE</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/testapp_content/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareLogicTest.test_customer_has_inactive_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareLogicTest</span><span class="o">.</span><span class="n">test_customer_has_inactive_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_customer_has_inactive_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span>
            <span class="n">FAKE_SUBSCRIPTION_NOT_PERIOD_CURRENT</span>
        <span class="p">)</span>

    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/testapp_content/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareLogicTest.test_is_staff" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareLogicTest</span><span class="o">.</span><span class="n">test_is_staff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_is_staff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/djstripe/webhook/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareLogicTest.test_is_superuser" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareLogicTest</span><span class="o">.</span><span class="n">test_is_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_is_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/djstripe/webhook/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_middleware.MiddlewareURLTest" class="doc doc-heading">
        <code>
tests.test_middleware.MiddlewareURLTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h7 id="tests.test_middleware.MiddlewareURLTest.urlconf" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">urlconf</span></code>


</h7>

    <div class="doc doc-contents ">

    </div>

  </div>




<h6 id="tests.test_middleware.MiddlewareURLTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ROOT_URLCONF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">RequestFactory</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span> <span class="o">=</span> <span class="n">SubscriptionPaymentMiddleware</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.test_appname" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">test_appname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_appname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.test_djdt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">test_djdt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_djdt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/__debug__/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.test_fnmatch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">test_fnmatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_fnmatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/test_fnmatch/extra_text/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.test_middleware_loads" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">test_middleware_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Check that the middleware can be loaded by django's
middleware handlers. This is to check for compatibility across
the change to django's middleware class structure. See
https://docs.djangoproject.com/en/1.10/topics/http/middleware/#upgrading-pre-django-1-10-style-middleware</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@modify_settings</span><span class="p">(</span>
    <span class="n">MIDDLEWARE</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;append&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;djstripe.middleware.SubscriptionPaymentMiddleware&quot;</span><span class="p">]}</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_middleware_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that the middleware can be loaded by django&#39;s</span>
<span class="sd">    middleware handlers. This is to check for compatibility across</span>
<span class="sd">    the change to django&#39;s middleware class structure. See</span>
<span class="sd">    https://docs.djangoproject.com/en/1.10/topics/http/middleware/#upgrading-pre-django-1-10-style-middleware</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/__debug__&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.test_namespace" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">test_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/djstripe/webhook/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.test_namespace_and_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">test_namespace_and_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_namespace_and_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/testapp_namespaced/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_middleware.MiddlewareURLTest.test_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_middleware</span><span class="o">.</span><span class="n">MiddlewareURLTest</span><span class="o">.</span><span class="n">test_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_middleware.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/testapp/&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlconf</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_mixins" class="doc doc-heading">
        <code>tests.test_mixins</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Mixin Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_mixins-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_mixins.TestPaymentsContextMixin" class="doc doc-heading">
        <code>
tests.test_mixins.TestPaymentsContextMixin        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_mixins.TestPaymentsContextMixin.test_get_context_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_mixins</span><span class="o">.</span><span class="n">TestPaymentsContextMixin</span><span class="o">.</span><span class="n">test_get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_mixins.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">TestSuperView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">class</span> <span class="nc">TestView</span><span class="p">(</span><span class="n">PaymentsContextMixin</span><span class="p">,</span> <span class="n">TestSuperView</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">TestView</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span>
        <span class="s2">&quot;STRIPE_PUBLIC_KEY&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="s2">&quot;STRIPE_PUBLIC_KEY missing from context.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;STRIPE_PUBLIC_KEY&quot;</span><span class="p">],</span>
        <span class="n">STRIPE_PUBLIC_KEY</span><span class="p">,</span>
        <span class="s2">&quot;Incorrect STRIPE_PUBLIC_KEY.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="s2">&quot;pans missing from context.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;plans&quot;</span><span class="p">]),</span> <span class="s2">&quot;Incorrect plans.&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_mixins.TestSubscriptionMixin" class="doc doc-heading">
        <code>
tests.test_mixins.TestSubscriptionMixin        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_mixins.TestSubscriptionMixin-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_mixins.TestSubscriptionMixin.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_mixins</span><span class="o">.</span><span class="n">TestSubscriptionMixin</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_mixins.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">))</span>
        <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_mixins.TestSubscriptionMixin.test_get_context_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_mixins</span><span class="o">.</span><span class="n">TestSubscriptionMixin</span><span class="o">.</span><span class="n">test_get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_create_customer_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_mixins.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_create_customer_mock</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">TestSuperView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">class</span> <span class="nc">TestView</span><span class="p">(</span><span class="n">SubscriptionMixin</span><span class="p">,</span> <span class="n">TestSuperView</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">test_view</span> <span class="o">=</span> <span class="n">TestView</span><span class="p">()</span>

    <span class="n">test_view</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RequestFactory</span><span class="p">()</span>
    <span class="n">test_view</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;user@test.com&quot;</span>
    <span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">test_view</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span>
        <span class="s2">&quot;is_plans_plural&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="s2">&quot;is_plans_plural missing from context.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;is_plans_plural&quot;</span><span class="p">],</span> <span class="s2">&quot;Incorrect is_plans_plural.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="s2">&quot;customer missing from context.&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_payment_intent" class="doc doc-heading">
        <code>tests.test_payment_intent</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe PaymentIntent Model Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_payment_intent.PaymentIntentTest" class="doc doc-heading">
        <code>
tests.test_payment_intent.PaymentIntentTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_intent.PaymentIntentTest.test_canceled_intent" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_intent</span><span class="o">.</span><span class="n">PaymentIntentTest</span><span class="o">.</span><span class="n">test_canceled_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_intent.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_canceled_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>

    <span class="n">fake_payment_intent</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;canceled&quot;</span>
    <span class="n">fake_payment_intent</span><span class="p">[</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1567524169</span>

    <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;duplicate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fraudulent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requested_by_customer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;abandoned&quot;</span><span class="p">,</span>
        <span class="s2">&quot;failed_invoice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;void_invoice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;automatic&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fake_payment_intent</span><span class="p">[</span><span class="s2">&quot;cancellation_reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="n">payment_intent</span> <span class="o">=</span> <span class="n">PaymentIntent</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_payment_intent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># enums nulls are coerced to &quot;&quot; by StripeModel._stripe_object_to_record</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payment_intent</span><span class="o">.</span><span class="n">cancellation_reason</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payment_intent</span><span class="o">.</span><span class="n">cancellation_reason</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">payment_intent</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_intent.PaymentIntentTest.test_status_enum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_intent</span><span class="o">.</span><span class="n">PaymentIntentTest</span><span class="o">.</span><span class="n">test_status_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_intent.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;requires_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requires_confirmation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requires_action&quot;</span><span class="p">,</span>
        <span class="s2">&quot;processing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requires_capture&quot;</span><span class="p">,</span>
        <span class="s2">&quot;canceled&quot;</span><span class="p">,</span>
        <span class="s2">&quot;succeeded&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fake_payment_intent</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="n">payment_intent</span> <span class="o">=</span> <span class="n">PaymentIntent</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_payment_intent</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">payment_intent</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_intent.PaymentIntentTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_intent</span><span class="o">.</span><span class="n">PaymentIntentTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_intent.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">)</span>

    <span class="n">payment_intent</span> <span class="o">=</span> <span class="n">PaymentIntent</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_payment_intent</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_intent</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># TODO - PaymentIntent should probably sync invoice (reverse OneToOneField)</span>
    <span class="c1"># self.assertIsNotNone(payment_intent.invoice)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_payment_method" class="doc doc-heading">
        <code>tests.test_payment_method</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe PaymenthMethod Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_payment_method-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_payment_method.PaymentMethodTest" class="doc doc-heading">
        <code>
tests.test_payment_method.PaymentMethodTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_payment_method.PaymentMethodTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_method.PaymentMethodTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_method</span><span class="o">.</span><span class="n">PaymentMethodTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_payment_method.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;djstripe@example.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_method.PaymentMethodTest.test_attach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_method</span><span class="o">.</span><span class="n">PaymentMethodTest</span><span class="o">.</span><span class="n">test_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_method.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.attach&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">):</span>
    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span>
        <span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">customer</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_method.PaymentMethodTest.test_attach_obj" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_method</span><span class="o">.</span><span class="n">PaymentMethodTest</span><span class="o">.</span><span class="n">test_attach_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_method.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.attach&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_attach_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">):</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">)</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pm</span><span class="p">,</span> <span class="n">customer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_method.PaymentMethodTest.test_attach_synced" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_method</span><span class="o">.</span><span class="n">PaymentMethodTest</span><span class="o">.</span><span class="n">test_attach_synced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_method.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.PaymentMethod.attach&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_attach_synced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attach_mock</span><span class="p">):</span>
    <span class="n">fake_payment_method</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">)</span>
    <span class="n">fake_payment_method</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_payment_method</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.PaymentMethod.customer&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">customer</span><span class="o">=</span><span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_method.PaymentMethodTest.test_detach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_method</span><span class="o">.</span><span class="n">PaymentMethodTest</span><span class="o">.</span><span class="n">test_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_method.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">original_detach</span> <span class="o">=</span> <span class="n">PaymentMethodDict</span><span class="o">.</span><span class="n">detach</span>

    <span class="k">def</span> <span class="nf">mocked_detach</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">original_detach</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;tests.PaymentMethodDict.detach&quot;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">mocked_detach</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">mock_detach</span><span class="p">,</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_payment_method</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="c1"># this mock isn&#39;t working on py34, py35, but it&#39;s not strictly necessary</span>
        <span class="c1"># for the test</span>
        <span class="n">mock_detach</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.PaymentMethod.customer&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;tests.PaymentMethodDict.detach&quot;</span><span class="p">,</span>
        <span class="n">side_effect</span><span class="o">=</span><span class="n">InvalidRequestError</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;A source must be attached to a customer to be used &quot;</span>
            <span class="s2">&quot;as a `payment_method`&quot;</span><span class="p">,</span>
            <span class="n">param</span><span class="o">=</span><span class="s2">&quot;payment_method&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">mock_detach</span><span class="p">,</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">payment_method_retrieve_mock</span><span class="p">:</span>
        <span class="n">payment_method_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
            <span class="n">payment_method</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="s2">&quot;Second call to detach should return false&quot;</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_method.PaymentMethodTest.test_detach_card" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_method</span><span class="o">.</span><span class="n">PaymentMethodTest</span><span class="o">.</span><span class="n">test_detach_card</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_method.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_detach_card</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">original_detach</span> <span class="o">=</span> <span class="n">PaymentMethodDict</span><span class="o">.</span><span class="n">detach</span>

    <span class="c1"># &quot;card_&quot; payment methods are deleted after detach</span>
    <span class="n">deleted_card_exception</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No such payment_method: card_xxxx&quot;</span><span class="p">,</span>
        <span class="n">param</span><span class="o">=</span><span class="s2">&quot;payment_method&quot;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="s2">&quot;resource_missing&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">mocked_detach</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">original_detach</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;card_&quot;</span><span class="p">),</span> <span class="s2">&quot;We expect this to be a &#39;card_&#39;&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;tests.PaymentMethodDict.detach&quot;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">mocked_detach</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">mock_detach</span><span class="p">,</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">payment_methods</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_payment_method</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">payment_method</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;We expect PaymentMethod id = card_* to be deleted&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="c1"># this mock isn&#39;t working on py34, py35, but it&#39;s not strictly necessary</span>
        <span class="c1"># for the test</span>
        <span class="n">mock_detach</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;tests.PaymentMethodDict.detach&quot;</span><span class="p">,</span>
        <span class="n">side_effect</span><span class="o">=</span><span class="n">InvalidRequestError</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;A source must be attached to a customer to be used &quot;</span>
            <span class="s2">&quot;as a `payment_method`&quot;</span><span class="p">,</span>
            <span class="n">param</span><span class="o">=</span><span class="s2">&quot;payment_method&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">mock_detach</span><span class="p">,</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
        <span class="n">side_effect</span><span class="o">=</span><span class="n">deleted_card_exception</span><span class="p">,</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">payment_method_retrieve_mock</span><span class="p">:</span>
        <span class="n">payment_method_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
            <span class="n">payment_method</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="s2">&quot;Second call to detach should return false&quot;</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_payment_method.PaymentMethodTest.test_sync_null_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_payment_method</span><span class="o">.</span><span class="n">PaymentMethodTest</span><span class="o">.</span><span class="n">test_sync_null_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_payment_method.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sync_null_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>

    <span class="c1"># simulate remote detach</span>
    <span class="n">fake_payment_method_no_customer</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_METHOD_I</span><span class="p">)</span>
    <span class="n">fake_payment_method_no_customer</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span>
        <span class="n">fake_payment_method_no_customer</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">payment_method</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">payment_method</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.PaymentMethod.customer&quot;</span><span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_plan" class="doc doc-heading">
        <code>tests.test_plan</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Plan Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_plan-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_plan.HumanReadablePlanTest" class="doc doc-heading">
        <code>
tests.test_plan.HumanReadablePlanTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.HumanReadablePlanTest.test_human_readable_10_usd_2weeks" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">HumanReadablePlanTest</span><span class="o">.</span><span class="n">test_human_readable_10_usd_2weeks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_10_usd_2weeks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;plan-test-10-usd-2w&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;week&quot;</span><span class="p">,</span>
        <span class="n">interval_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">human_readable_price</span><span class="p">,</span> <span class="s2">&quot;$10.00 USD every 2 weeks&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.HumanReadablePlanTest.test_human_readable_10_usd_weekly" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">HumanReadablePlanTest</span><span class="o">.</span><span class="n">test_human_readable_10_usd_weekly</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_10_usd_weekly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;plan-test-10-usd-weekly&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;week&quot;</span><span class="p">,</span>
        <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">human_readable_price</span><span class="p">,</span> <span class="s2">&quot;$10.00 USD/week&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.HumanReadablePlanTest.test_human_readable_10_usd_yearly" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">HumanReadablePlanTest</span><span class="o">.</span><span class="n">test_human_readable_10_usd_yearly</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_10_usd_yearly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;plan-test-10-usd-yearly&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
        <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">human_readable_price</span><span class="p">,</span> <span class="s2">&quot;$10.00 USD/year&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.HumanReadablePlanTest.test_human_readable_25_usd_6months" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">HumanReadablePlanTest</span><span class="o">.</span><span class="n">test_human_readable_25_usd_6months</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_25_usd_6months</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;plan-test-25-usd-6m&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
        <span class="n">interval_count</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">human_readable_price</span><span class="p">,</span> <span class="s2">&quot;$25.00 USD every 6 months&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.HumanReadablePlanTest.test_human_readable_499_usd_monthly" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">HumanReadablePlanTest</span><span class="o">.</span><span class="n">test_human_readable_499_usd_monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_499_usd_monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;plan-test-499-usd-monthly&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;4.99&quot;</span><span class="p">),</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
        <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">human_readable_price</span><span class="p">,</span> <span class="s2">&quot;$4.99 USD/month&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.HumanReadablePlanTest.test_human_readable_free_usd_daily" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">HumanReadablePlanTest</span><span class="o">.</span><span class="n">test_human_readable_free_usd_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_free_usd_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;plan-test-free-usd-daily&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;day&quot;</span><span class="p">,</span>
        <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">human_readable_price</span><span class="p">,</span> <span class="s2">&quot;$0.00 USD/day&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_plan.PlanCreateTest" class="doc doc-heading">
        <code>
tests.test_plan.PlanCreateTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_plan.PlanCreateTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanCreateTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanCreateTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanCreateTest.test_create_from_djstripe_product" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanCreateTest</span><span class="o">.</span><span class="n">test_create_from_djstripe_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_from_djstripe_product</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_plan</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">)</span>
    <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="n">Product</span><span class="p">)</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_plan</span><span class="p">)</span>

    <span class="n">plan_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="o">**</span><span class="n">FAKE_PLAN</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanCreateTest.test_create_from_product_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanCreateTest</span><span class="o">.</span><span class="n">test_create_from_product_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_from_product_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_plan</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_plan</span><span class="p">)</span>

    <span class="n">expected_create_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="n">expected_create_kwargs</span><span class="p">[</span><span class="s2">&quot;api_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">plan_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="o">**</span><span class="n">expected_create_kwargs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanCreateTest.test_create_from_stripe_product" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanCreateTest</span><span class="o">.</span><span class="n">test_create_from_stripe_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_from_stripe_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_plan</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span>
    <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_plan</span><span class="p">)</span>

    <span class="n">expected_create_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="n">expected_create_kwargs</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span>

    <span class="n">plan_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="o">**</span><span class="n">expected_create_kwargs</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanCreateTest.test_create_with_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanCreateTest</span><span class="o">.</span><span class="n">test_create_with_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_with_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;other_data&quot;</span><span class="p">:</span> <span class="s2">&quot;more_data&quot;</span><span class="p">}</span>
    <span class="n">fake_plan</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">fake_plan</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_plan</span><span class="p">)</span>

    <span class="n">expected_create_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="n">expected_create_kwargs</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="n">plan_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="o">**</span><span class="n">expected_create_kwargs</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_plan.PlanTest" class="doc doc-heading">
        <code>
tests.test_plan.PlanTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_plan.PlanTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plan_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanTest.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanTest</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_data</span><span class="p">[</span><span class="s2">&quot;nickname&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanTest.test_stripe_metered_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanTest</span><span class="o">.</span><span class="n">test_stripe_metered_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_metered_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">):</span>
    <span class="n">plan_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN_METERED</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">plan_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">plan_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">usage_type</span><span class="p">,</span> <span class="n">PriceUsageType</span><span class="o">.</span><span class="n">metered</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanTest.test_stripe_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanTest</span><span class="o">.</span><span class="n">test_stripe_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_PLAN</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">):</span>
    <span class="n">stripe_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">plan_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_plan</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">plan</span><span class="o">.</span><span class="n">amount_in_cents</span> <span class="o">==</span> <span class="n">plan</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">amount_in_cents</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanTest.test_stripe_plan_null_product" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanTest</span><span class="o">.</span><span class="n">test_stripe_plan_null_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>assert that plan.Product can be null for backwards compatibility
though note that it is a Stripe required field</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_plan_null_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    assert that plan.Product can be null for backwards compatibility</span>
<span class="sd">    though note that it is a Stripe required field</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plan_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">plan_data</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">plan_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">plan</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Plan.product&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_plan.PlanTest.test_stripe_tier_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_plan</span><span class="o">.</span><span class="n">PlanTest</span><span class="o">.</span><span class="n">test_stripe_tier_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_plan.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_tier_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">):</span>
    <span class="n">tier_plan_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TIER_PLAN</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">tier_plan_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tier_plan_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">tiers</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_price" class="doc doc-heading">
        <code>tests.test_price</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Price model tests</p>



  <div class="doc doc-children">





<h4 id="tests.test_price-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_price.HumanReadablePriceTest" class="doc doc-heading">
        <code>
tests.test_price.HumanReadablePriceTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_price.HumanReadablePriceTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">product_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">product_data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.test_human_readable_10_usd_2weeks" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">test_human_readable_10_usd_2weeks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_10_usd_2weeks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price-test-10-usd-2w&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_amount</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">,</span>
        <span class="n">recurring</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;week&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interval_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$10.00 USD every 2 weeks&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.test_human_readable_10_usd_weekly" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">test_human_readable_10_usd_weekly</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_10_usd_weekly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price-test-10-usd-weekly&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_amount</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">,</span>
        <span class="n">recurring</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;week&quot;</span><span class="p">,</span>
            <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$10.00 USD/week&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.test_human_readable_10_usd_yearly" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">test_human_readable_10_usd_yearly</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_10_usd_yearly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price-test-10-usd-yearly&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_amount</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">,</span>
        <span class="n">recurring</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
            <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$10.00 USD/year&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.test_human_readable_25_usd_6months" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">test_human_readable_25_usd_6months</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_25_usd_6months</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price-test-25-usd-6m&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_amount</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">,</span>
        <span class="n">recurring</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
            <span class="n">interval_count</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$25.00 USD every 6 months&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.test_human_readable_499_usd_monthly" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">test_human_readable_499_usd_monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_499_usd_monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price-test-499-usd-monthly&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_amount</span><span class="o">=</span><span class="mi">499</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">,</span>
        <span class="n">recurring</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
            <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$4.99 USD/month&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.test_human_readable_free_usd_daily" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">test_human_readable_free_usd_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_free_usd_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price-test-free-usd-daily&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">,</span>
        <span class="n">recurring</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;day&quot;</span><span class="p">,</span>
            <span class="n">interval_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$0.00 USD/day&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.HumanReadablePriceTest.test_human_readable_one_time" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">HumanReadablePriceTest</span><span class="o">.</span><span class="n">test_human_readable_one_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_human_readable_one_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price-test-one-time&quot;</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_amount</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$20.00 USD (one time)&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_price.PriceCreateTest" class="doc doc-heading">
        <code>
tests.test_price.PriceCreateTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_price.PriceCreateTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceCreateTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceCreateTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceCreateTest.test_create_from_djstripe_product" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceCreateTest</span><span class="o">.</span><span class="n">test_create_from_djstripe_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_from_djstripe_product</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_price</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span><span class="p">)</span>
    <span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;unit_amount&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">100</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="n">Product</span><span class="p">)</span>

    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_price</span><span class="p">)</span>

    <span class="n">price_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="o">**</span><span class="n">FAKE_PRICE</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceCreateTest.test_create_from_product_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceCreateTest</span><span class="o">.</span><span class="n">test_create_from_product_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_from_product_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_price</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;unit_amount&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">100</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>

    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_price</span><span class="p">)</span>

    <span class="n">expected_create_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="n">expected_create_kwargs</span><span class="p">[</span><span class="s2">&quot;api_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STRIPE_SECRET_KEY</span>

    <span class="n">price_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="o">**</span><span class="n">expected_create_kwargs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceCreateTest.test_create_from_stripe_product" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceCreateTest</span><span class="o">.</span><span class="n">test_create_from_stripe_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_from_stripe_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_price</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span>
    <span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;unit_amount&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">100</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>

    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_price</span><span class="p">)</span>

    <span class="n">expected_create_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="n">expected_create_kwargs</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripe_product</span>

    <span class="n">price_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="o">**</span><span class="n">expected_create_kwargs</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceCreateTest.test_create_with_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceCreateTest</span><span class="o">.</span><span class="n">test_create_with_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_with_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_create_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;other_data&quot;</span><span class="p">:</span> <span class="s2">&quot;more_data&quot;</span><span class="p">}</span>
    <span class="n">fake_price</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;unit_amount&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">100</span>
    <span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fake_price</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>

    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">fake_price</span><span class="p">)</span>

    <span class="n">expected_create_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="n">expected_create_kwargs</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="n">price_create_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span> <span class="o">**</span><span class="n">expected_create_kwargs</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_price.PriceTest" class="doc doc-heading">
        <code>
tests.test_price.PriceTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_price.PriceTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span>
        <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span>
        <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceTest.test_price_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceTest</span><span class="o">.</span><span class="n">test_price_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_price_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;price_xxxx&quot;</span><span class="p">,</span> <span class="n">nickname</span><span class="o">=</span><span class="s2">&quot;Price Test&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Price Test&quot;</span>
    <span class="n">price</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;price_xxxx&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceTest.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceTest</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s2">&quot;nickname&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceTest.test_stripe_metered_price" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceTest</span><span class="o">.</span><span class="n">test_stripe_metered_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_metered_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">):</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE_METERED</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">price_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">price_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">recurring</span><span class="p">[</span><span class="s2">&quot;usage_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">PriceUsageType</span><span class="o">.</span><span class="n">metered</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">unit_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceTest.test_stripe_onetime_price" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceTest</span><span class="o">.</span><span class="n">test_stripe_onetime_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_onetime_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">):</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE_ONETIME</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">price_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">price_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">unit_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">price</span><span class="o">.</span><span class="n">recurring</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PriceType</span><span class="o">.</span><span class="n">one_time</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceTest.test_stripe_price" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceTest</span><span class="o">.</span><span class="n">test_stripe_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">FAKE_PRICE</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">):</span>
    <span class="n">stripe_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()</span>
    <span class="n">price_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tiers&quot;</span><span class="p">],</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">stripe_price</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>

    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">human_readable_price</span> <span class="o">==</span> <span class="s2">&quot;$20.00 USD/month&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_price.PriceTest.test_stripe_tier_price" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_price</span><span class="o">.</span><span class="n">PriceTest</span><span class="o">.</span><span class="n">test_stripe_tier_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_price.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Price.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_stripe_tier_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_retrieve_mock</span><span class="p">):</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRICE_TIER</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Price</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">price_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">price_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">unit_amount</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">price</span><span class="o">.</span><span class="n">tiers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_refund" class="doc doc-heading">
        <code>tests.test_refund</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Charge Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_refund-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_refund.RefundTest" class="doc doc-heading">
        <code>
tests.test_refund.RefundTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_refund.RefundTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_refund.RefundTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_refund</span><span class="o">.</span><span class="n">RefundTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_refund.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.Account.branding_logo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Account.branding_icon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.application_fee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.dispute&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.latest_upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.refund&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.source_transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Charge.transfer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Invoice.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.pending_setup_intent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.schedule&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Refund.failure_balance_transaction&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_refund.RefundTest.test_reason_enum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_refund</span><span class="o">.</span><span class="n">RefundTest</span><span class="o">.</span><span class="n">test_reason_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_refund.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_reason_enum</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="c1"># TODO - remove invoice sync</span>
    <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">))</span>

    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span>
        <span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span>
    <span class="p">)</span>

    <span class="n">fake_refund</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_REFUND</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;duplicate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fraudulent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requested_by_customer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expired_uncaptured_charge&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fake_refund</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>

        <span class="n">refund</span> <span class="o">=</span> <span class="n">Refund</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_refund</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refund</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">refund</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">refund</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_refund.RefundTest.test_status_enum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_refund</span><span class="o">.</span><span class="n">RefundTest</span><span class="o">.</span><span class="n">test_status_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_refund.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_enum</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="c1"># TODO - remove invoice sync</span>
    <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">))</span>

    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span>
        <span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span>
    <span class="p">)</span>

    <span class="n">fake_refund</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_REFUND</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;pending&quot;</span><span class="p">,</span>
        <span class="s2">&quot;succeeded&quot;</span><span class="p">,</span>
        <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;canceled&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fake_refund</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>

        <span class="n">refund</span> <span class="o">=</span> <span class="n">Refund</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_refund</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refund</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">refund</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">refund</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_refund.RefundTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_refund</span><span class="o">.</span><span class="n">RefundTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span> <span class="n">charge_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span> <span class="n">default_account_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_refund.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Account.get_default_account&quot;</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.BalanceTransaction.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_BALANCE_TRANSACTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Charge.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CHARGE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentMethod.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CARD_AS_PAYMENT_METHOD</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span>
    <span class="n">paymentmethod_card_retrieve_mock</span><span class="p">,</span>
    <span class="n">charge_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">balance_transaction_retrieve_mock</span><span class="p">,</span>
    <span class="n">default_account_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">default_account_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
    <span class="c1"># TODO - remove invoice sync</span>
    <span class="n">Invoice</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_INVOICE</span><span class="p">))</span>

    <span class="n">fake_refund</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_REFUND</span><span class="p">)</span>

    <span class="n">balance_transaction_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span>
        <span class="n">FAKE_BALANCE_TRANSACTION_REFUND</span>
    <span class="p">)</span>

    <span class="n">refund</span> <span class="o">=</span> <span class="n">Refund</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_refund</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">refund</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_session" class="doc doc-heading">
        <code>tests.test_session</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Session Model Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_session.SessionTest" class="doc doc-heading">
        <code>
tests.test_session.SessionTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_session.SessionTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_session</span><span class="o">.</span><span class="n">SessionTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_session.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.PaymentIntent.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PAYMENT_INTENT_I</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">payment_intent_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SESSION_I</span><span class="p">)</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_payment_intent</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">session</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.invoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.payment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.PaymentIntent.upcominginvoice (related name)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Session.subscription&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_settings" class="doc doc-heading">
        <code>tests.test_settings</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Settings Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_settings.TestGetStripeApiVersion" class="doc doc-heading">
        <code>
tests.test_settings.TestGetStripeApiVersion        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestGetStripeApiVersion.test_with_default" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestGetStripeApiVersion</span><span class="o">.</span><span class="n">test_with_default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_with_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">DEFAULT_STRIPE_API_VERSION</span><span class="p">,</span> <span class="n">get_stripe_api_version</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestGetStripeApiVersion.test_with_override" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestGetStripeApiVersion</span><span class="o">.</span><span class="n">test_with_override</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">STRIPE_API_VERSION</span><span class="o">=</span><span class="s2">&quot;2016-03-07&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_with_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;2016-03-07&quot;</span><span class="p">,</span> <span class="n">get_stripe_api_version</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_settings.TestSetStripeApiVersion" class="doc doc-heading">
        <code>
tests.test_settings.TestSetStripeApiVersion        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSetStripeApiVersion.test_with_default" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSetStripeApiVersion</span><span class="o">.</span><span class="n">test_with_default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_with_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">set_stripe_api_version</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">DEFAULT_STRIPE_API_VERSION</span><span class="p">,</span> <span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSetStripeApiVersion.test_with_invalid_date" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSetStripeApiVersion</span><span class="o">.</span><span class="n">test_with_invalid_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_with_invalid_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">set_stripe_api_version</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSetStripeApiVersion.test_with_invalid_date_and_no_validation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSetStripeApiVersion</span><span class="o">.</span><span class="n">test_with_invalid_date_and_no_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_with_invalid_date_and_no_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">set_stripe_api_version</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSetStripeApiVersion.test_with_valid_date" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSetStripeApiVersion</span><span class="o">.</span><span class="n">test_with_valid_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_with_valid_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">set_stripe_api_version</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;2016-03-07&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;2016-03-07&quot;</span><span class="p">,</span> <span class="n">stripe</span><span class="o">.</span><span class="n">api_version</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_settings.TestSubscriberModelRetrievalMethod" class="doc doc-heading">
        <code>
tests.test_settings.TestSubscriberModelRetrievalMethod        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_bad_callback" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_bad_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL</span><span class="o">=</span><span class="s2">&quot;testapp.Organization&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_bad_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">ImproperlyConfigured</span><span class="p">,</span>
        <span class="s2">&quot;DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK must be callable.&quot;</span><span class="p">,</span>
        <span class="n">get_subscriber_model</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_bad_model_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_bad_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL</span><span class="o">=</span><span class="s2">&quot;testappStaticEmailOrganization&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">org</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_bad_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">ImproperlyConfigured</span><span class="p">,</span>
        <span class="s2">&quot;DJSTRIPE_SUBSCRIBER_MODEL must be of the form &#39;app_label.model_name&#39;.&quot;</span><span class="p">,</span>
        <span class="n">get_subscriber_model</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_get_callback_function_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_get_callback_function_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_TEST_CALLBACK</span><span class="o">=</span><span class="s2">&quot;foo.non_existant_callback&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_callback_function_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ImportError</span><span class="p">):</span>
        <span class="n">get_callback_function</span><span class="p">(</span><span class="s2">&quot;DJSTRIPE_TEST_CALLBACK&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_get_callback_function_import_error" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_get_callback_function_import_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_TEST_CALLBACK</span><span class="o">=</span><span class="s2">&quot;foo.non_existant_callback&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_callback_function_import_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ImportError</span><span class="p">):</span>
        <span class="n">get_callback_function</span><span class="p">(</span><span class="s2">&quot;DJSTRIPE_TEST_CALLBACK&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_get_callback_function_with_non_callable_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_get_callback_function_with_non_callable_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_string_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_TEST_CALLBACK</span><span class="o">=</span><span class="s2">&quot;foo.invalid_callback&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">,</span> <span class="s2">&quot;import_string&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;not_callable&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_callback_function_with_non_callable_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_string_mock</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ImproperlyConfigured</span><span class="p">):</span>
        <span class="n">get_callback_function</span><span class="p">(</span><span class="s2">&quot;DJSTRIPE_TEST_CALLBACK&quot;</span><span class="p">)</span>
    <span class="n">import_string_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;foo.invalid_callback&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_get_callback_function_with_valid_func_callable" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_get_callback_function_with_valid_func_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_TEST_CALLBACK</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_get_callback_function_with_valid_func_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">get_callback_function</span><span class="p">(</span><span class="s2">&quot;DJSTRIPE_TEST_CALLBACK&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_get_callback_function_with_valid_string_callable" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_get_callback_function_with_valid_string_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_string_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_TEST_CALLBACK</span><span class="o">=</span><span class="s2">&quot;foo.valid_callback&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">,</span> <span class="s2">&quot;import_string&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_get_callback_function_with_valid_string_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_string_mock</span><span class="p">):</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">get_callback_function</span><span class="p">(</span><span class="s2">&quot;DJSTRIPE_TEST_CALLBACK&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">())</span>
    <span class="n">import_string_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;foo.valid_callback&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_no_callback" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_no_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_SUBSCRIBER_MODEL</span><span class="o">=</span><span class="s2">&quot;testapp.Organization&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_no_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">ImproperlyConfigured</span><span class="p">,</span>
        <span class="s2">&quot;DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK must be implemented &quot;</span>
        <span class="s2">&quot;if a DJSTRIPE_SUBSCRIBER_MODEL is defined.&quot;</span><span class="p">,</span>
        <span class="n">get_subscriber_model</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_no_email_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_no_email_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL</span><span class="o">=</span><span class="s2">&quot;testapp.NoEmailOrganization&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">org</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_no_email_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">ImproperlyConfigured</span><span class="p">,</span>
        <span class="s2">&quot;DJSTRIPE_SUBSCRIBER_MODEL must have an email attribute.&quot;</span><span class="p">,</span>
        <span class="n">get_subscriber_model</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_unknown_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_unknown_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL</span><span class="o">=</span><span class="s2">&quot;testapp.UnknownModel&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">org</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_unknown_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
        <span class="n">ImproperlyConfigured</span><span class="p">,</span>
        <span class="s2">&quot;DJSTRIPE_SUBSCRIBER_MODEL refers to model &#39;testapp.UnknownModel&#39; &quot;</span>
        <span class="s2">&quot;that has not been installed.&quot;</span><span class="p">,</span>
        <span class="n">get_subscriber_model</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_with_org" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_with_org</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL</span><span class="o">=</span><span class="s2">&quot;testapp.Organization&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">org</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_with_org</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">org_model</span> <span class="o">=</span> <span class="n">get_subscriber_model</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">org_model</span><span class="p">,</span> <span class="n">ModelBase</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_with_org_static" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_with_org_static</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL</span><span class="o">=</span><span class="s2">&quot;testapp.StaticEmailOrganization&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_SUBSCRIBER_MODEL_REQUEST_CALLBACK</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">org</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_with_org_static</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">org_model</span> <span class="o">=</span> <span class="n">get_subscriber_model</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">org_model</span><span class="p">,</span> <span class="n">ModelBase</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_settings.TestSubscriberModelRetrievalMethod.test_with_user" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_settings</span><span class="o">.</span><span class="n">TestSubscriberModelRetrievalMethod</span><span class="o">.</span><span class="n">test_with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_settings.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user_model</span> <span class="o">=</span> <span class="n">get_subscriber_model</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user_model</span><span class="p">,</span> <span class="n">ModelBase</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_setup_intent" class="doc doc-heading">
        <code>tests.test_setup_intent</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe SetupIntent Model Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_setup_intent.SetupIntentTest" class="doc doc-heading">
        <code>
tests.test_setup_intent.SetupIntentTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_setup_intent.SetupIntentTest.test_canceled_intent" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_setup_intent</span><span class="o">.</span><span class="n">SetupIntentTest</span><span class="o">.</span><span class="n">test_canceled_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_setup_intent.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_canceled_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_setup_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SETUP_INTENT_I</span><span class="p">)</span>

    <span class="n">fake_setup_intent</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;canceled&quot;</span>
    <span class="n">fake_setup_intent</span><span class="p">[</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1567524169</span>

    <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;abandoned&quot;</span><span class="p">,</span> <span class="s2">&quot;requested_by_customer&quot;</span><span class="p">,</span> <span class="s2">&quot;duplicate&quot;</span><span class="p">):</span>
        <span class="n">fake_setup_intent</span><span class="p">[</span><span class="s2">&quot;cancellation_reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="n">setup_intent</span> <span class="o">=</span> <span class="n">SetupIntent</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_setup_intent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># enums nulls are coerced to &quot;&quot; by StripeModel._stripe_object_to_record</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">setup_intent</span><span class="o">.</span><span class="n">cancellation_reason</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">setup_intent</span><span class="o">.</span><span class="n">cancellation_reason</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">setup_intent</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_setup_intent.SetupIntentTest.test_status_enum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_setup_intent</span><span class="o">.</span><span class="n">SetupIntentTest</span><span class="o">.</span><span class="n">test_status_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_setup_intent.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_status_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_setup_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SETUP_INTENT_I</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;requires_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requires_confirmation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requires_action&quot;</span><span class="p">,</span>
        <span class="s2">&quot;processing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;canceled&quot;</span><span class="p">,</span>
        <span class="s2">&quot;succeeded&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">fake_setup_intent</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>

        <span class="n">setup_intent</span> <span class="o">=</span> <span class="n">SetupIntent</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_setup_intent</span><span class="p">)</span>

        <span class="c1"># trigger model field validation (including enum value choices check)</span>
        <span class="n">setup_intent</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_setup_intent.SetupIntentTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_setup_intent</span><span class="o">.</span><span class="n">SetupIntentTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_setup_intent.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">fake_payment_intent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SETUP_INTENT_I</span><span class="p">)</span>

    <span class="n">setup_intent</span> <span class="o">=</span> <span class="n">SetupIntent</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_payment_intent</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">setup_intent</span><span class="o">.</span><span class="n">payment_method_types</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;card&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">setup_intent</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.SetupIntent.customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.SetupIntent.on_behalf_of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.SetupIntent.payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_source" class="doc doc-heading">
        <code>tests.test_source</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Card Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_source-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_source.SourceTest" class="doc doc-heading">
        <code>
tests.test_source.SourceTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_source.SourceTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_source.SourceTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_source</span><span class="o">.</span><span class="n">SourceTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_source.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">default_account</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;djstripe@example.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER_III</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_source.SourceTest.test_attach_objects_hook_without_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_source</span><span class="o">.</span><span class="n">SourceTest</span><span class="o">.</span><span class="n">test_attach_objects_hook_without_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_source.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_attach_objects_hook_without_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SOURCE_II</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">source</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Source.customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_source.SourceTest.test_detach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_source</span><span class="o">.</span><span class="n">SourceTest</span><span class="o">.</span><span class="n">test_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_source.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Source.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SOURCE</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_retrieve_mock</span><span class="p">):</span>
    <span class="n">original_detach</span> <span class="o">=</span> <span class="n">SourceDict</span><span class="o">.</span><span class="n">detach</span>

    <span class="k">def</span> <span class="nf">mocked_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">original_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">Source</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SOURCE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">legacy_cards</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
        <span class="s2">&quot;tests.SourceDict.detach&quot;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">mocked_detach</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">mock_detach</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="c1"># need to refresh_from_db since default_source was cleared with a query</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">default_source</span><span class="p">)</span>

    <span class="c1"># need to refresh_from_db due to the implementation of Source.detach() -</span>
    <span class="c1"># see TODO in method</span>
    <span class="n">source</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;consumed&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="c1"># this mock isn&#39;t working on py34, py35, but it&#39;s not strictly necessary</span>
        <span class="c1"># for the test</span>
        <span class="n">mock_detach</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">source</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Source.customer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_source.SourceTest.test_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_source</span><span class="o">.</span><span class="n">SourceTest</span><span class="o">.</span><span class="n">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_source.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">fake_source</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SOURCE</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">fake_source</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;&lt;id=</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fake_source</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">source</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_source.SourceTest.test_sync_source_finds_customer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_source</span><span class="o">.</span><span class="n">SourceTest</span><span class="o">.</span><span class="n">test_sync_source_finds_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_source.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sync_source_finds_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SOURCE</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">source</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_stripe_model" class="doc doc-heading">
        <code>tests.test_stripe_model</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe StripeModel Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_stripe_model-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_stripe_model.StripeModelExceptionsTest" class="doc doc-heading">
        <code>
tests.test_stripe_model.StripeModelExceptionsTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_stripe_model.StripeModelExceptionsTest.test_bad_object_value" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">StripeModelExceptionsTest</span><span class="o">.</span><span class="n">test_bad_object_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_bad_object_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="c1"># Errors because the object is not correct</span>
        <span class="n">Customer</span><span class="o">.</span><span class="n">_stripe_object_to_record</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_XXXXXXXX&quot;</span><span class="p">,</span> <span class="s2">&quot;livemode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="s2">&quot;not_a_customer&quot;</span><span class="p">}</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_stripe_model.StripeModelExceptionsTest.test_no_object_value" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">StripeModelExceptionsTest</span><span class="o">.</span><span class="n">test_no_object_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_no_object_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Instantiate a stripeobject model class</span>
    <span class="k">class</span> <span class="nc">BasicModel</span><span class="p">(</span><span class="n">StripeModel</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="c1"># Errors because there&#39;s no object value</span>
        <span class="n">BasicModel</span><span class="o">.</span><span class="n">_stripe_object_to_record</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_XXXXXXXX&quot;</span><span class="p">,</span> <span class="s2">&quot;livemode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_stripe_model.TestStripeModel" class="doc doc-heading">
        <code>
tests.test_stripe_model.TestStripeModel        </code>



</h5>

    <div class="doc doc-contents ">

      <p>TestStripeModel(djstripe_id, id, djstripe_owner_account, livemode, created, metadata, description, djstripe_created, djstripe_updated)</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h7 id="tests.test_stripe_model.TestStripeModel.djstripe_owner_account" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">TestStripeModel</span><span class="o">.</span><span class="n">djstripe_owner_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">djstripe</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">StripeForeignKey</span><span class="p">]</span></code>


</h7>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h7 id="tests.test_stripe_model.TestStripeModel.DoesNotExist" class="doc doc-heading">
        <code>
tests.test_stripe_model.TestStripeModel.DoesNotExist        </code>



</h7>

    <div class="doc doc-contents ">




    </div>

  </div>



  <div class="doc doc-object doc-class">



<h7 id="tests.test_stripe_model.TestStripeModel.MultipleObjectsReturned" class="doc doc-heading">
        <code>
tests.test_stripe_model.TestStripeModel.MultipleObjectsReturned        </code>



</h7>

    <div class="doc doc-contents ">




    </div>

  </div>





  <div class="doc doc-object doc-method">



<h7 id="tests.test_stripe_model.TestStripeModel.get_next_by_djstripe_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">TestStripeModel</span><span class="o">.</span><span class="n">get_next_by_djstripe_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">field</span><span class="o">=&lt;</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">:</span> <span class="n">djstripe_created</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">is_next</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_method</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_stripe_model.TestStripeModel.get_next_by_djstripe_updated" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">TestStripeModel</span><span class="o">.</span><span class="n">get_next_by_djstripe_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">field</span><span class="o">=&lt;</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">:</span> <span class="n">djstripe_updated</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">is_next</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_method</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_stripe_model.TestStripeModel.get_previous_by_djstripe_created" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">TestStripeModel</span><span class="o">.</span><span class="n">get_previous_by_djstripe_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">field</span><span class="o">=&lt;</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">:</span> <span class="n">djstripe_created</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">is_next</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_method</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_stripe_model.TestStripeModel.get_previous_by_djstripe_updated" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">TestStripeModel</span><span class="o">.</span><span class="n">get_previous_by_djstripe_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">field</span><span class="o">=&lt;</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">:</span> <span class="n">djstripe_updated</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">is_next</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_method</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>


<h4 id="tests.test_stripe_model-functions">Functions</h4>

  <div class="doc doc-object doc-function">



<h5 id="tests.test_stripe_model.test__api_delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">test__api_delete</span><span class="p">(</span><span class="n">mock_api_retrieve</span><span class="p">,</span> <span class="n">stripe_account</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">expected_api_key</span><span class="p">,</span> <span class="n">extra_kwargs</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Test that API delete properly uses the passed in parameters.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;stripe_account&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;acct_fakefakefakefake001&quot;</span><span class="p">))</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;api_key, expected_api_key&quot;</span><span class="p">,</span>
    <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">STRIPE_SECRET_KEY</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;sk_fakefakefake01&quot;</span><span class="p">,</span> <span class="s2">&quot;sk_fakefakefake01&quot;</span><span class="p">)),</span>
<span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;extra_kwargs&quot;</span><span class="p">,</span> <span class="p">({},</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">}))</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">StripeModel</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;api_retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test__api_delete</span><span class="p">(</span>
    <span class="n">mock_api_retrieve</span><span class="p">,</span> <span class="n">stripe_account</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">expected_api_key</span><span class="p">,</span> <span class="n">extra_kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that API delete properly uses the passed in parameters.&quot;&quot;&quot;</span>
    <span class="n">test_model</span> <span class="o">=</span> <span class="n">TestStripeModel</span><span class="p">()</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">_api_delete</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">stripe_account</span><span class="o">=</span><span class="n">stripe_account</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Assert the chained calls happened as expected, since it should</span>
    <span class="c1"># call api_retrieve() followed by delete()</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">mock_api_retrieve</span><span class="o">.</span><span class="n">mock_calls</span>
        <span class="o">==</span> <span class="n">call</span><span class="p">(</span><span class="n">test_model</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">expected_api_key</span><span class="p">,</span> <span class="n">stripe_account</span><span class="o">=</span><span class="n">stripe_account</span><span class="p">)</span>
        <span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">**</span><span class="n">extra_kwargs</span><span class="p">)</span>
        <span class="o">.</span><span class="n">call_list</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="tests.test_stripe_model.test_api_retrieve" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">test_api_retrieve</span><span class="p">(</span><span class="n">mock_stripe_class</span><span class="p">,</span> <span class="n">stripe_account</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">expected_api_key</span><span class="p">,</span> <span class="n">expand_fields</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Test that API delete properly uses the passed in parameters.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;stripe_account&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;acct_fakefakefakefake001&quot;</span><span class="p">))</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;api_key, expected_api_key&quot;</span><span class="p">,</span>
    <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">STRIPE_SECRET_KEY</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;sk_fakefakefake01&quot;</span><span class="p">,</span> <span class="s2">&quot;sk_fakefakefake01&quot;</span><span class="p">)),</span>
<span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;expand_fields&quot;</span><span class="p">,</span> <span class="p">([],</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">]))</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">StripeModel</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;stripe_class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_retrieve</span><span class="p">(</span>
    <span class="n">mock_stripe_class</span><span class="p">,</span> <span class="n">stripe_account</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">expected_api_key</span><span class="p">,</span> <span class="n">expand_fields</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that API delete properly uses the passed in parameters.&quot;&quot;&quot;</span>
    <span class="n">test_model</span> <span class="o">=</span> <span class="n">TestStripeModel</span><span class="p">()</span>
    <span class="n">mock_id</span> <span class="o">=</span> <span class="s2">&quot;id_fakefakefakefake01&quot;</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">mock_id</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">expand_fields</span> <span class="o">=</span> <span class="n">expand_fields</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">stripe_account</span><span class="o">=</span><span class="n">stripe_account</span><span class="p">)</span>

    <span class="n">mock_stripe_class</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">mock_id</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">expected_api_key</span><span class="p">,</span>
        <span class="n">stripe_account</span><span class="o">=</span><span class="n">stripe_account</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="n">expand_fields</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="tests.test_stripe_model.test_api_retrieve_reverse_foreign_key_lookup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_stripe_model</span><span class="o">.</span><span class="n">test_api_retrieve_reverse_foreign_key_lookup</span><span class="p">(</span><span class="n">mock_stripe_class</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Test that the reverse foreign key lookup finds the correct fields.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_stripe_model.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">StripeModel</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;stripe_class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_retrieve_reverse_foreign_key_lookup</span><span class="p">(</span><span class="n">mock_stripe_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that the reverse foreign key lookup finds the correct fields.&quot;&quot;&quot;</span>
    <span class="c1"># Set up some mock fields that shouldn&#39;t be used for reverse lookups</span>
    <span class="n">mock_field_1</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_field_1</span><span class="o">.</span><span class="n">is_relation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mock_field_2</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_field_2</span><span class="o">.</span><span class="n">is_relation</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_field_2</span><span class="o">.</span><span class="n">one_to_many</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Set up a mock reverse foreign key field</span>
    <span class="n">mock_reverse_foreign_key</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_reverse_foreign_key</span><span class="o">.</span><span class="n">is_relation</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_reverse_foreign_key</span><span class="o">.</span><span class="n">one_to_many</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_reverse_foreign_key</span><span class="o">.</span><span class="n">related_model</span> <span class="o">=</span> <span class="n">Account</span>
    <span class="n">mock_reverse_foreign_key</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;foo_account_reverse_attr&quot;</span>

    <span class="c1"># Set up a mock account for the reverse foreign key query to return.</span>
    <span class="n">mock_account</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_account_reverse_manager</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="c1"># Make first return the mock account.</span>
    <span class="n">mock_account_reverse_manager</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_account</span>

    <span class="n">test_model</span> <span class="o">=</span> <span class="n">TestStripeModel</span><span class="p">()</span>
    <span class="n">mock_id</span> <span class="o">=</span> <span class="s2">&quot;id_fakefakefakefake01&quot;</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">mock_id</span>
    <span class="c1"># Set mock reverse manager on the model.</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">foo_account_reverse_attr</span> <span class="o">=</span> <span class="n">mock_account_reverse_manager</span>

    <span class="c1"># Set the mocked _meta.get_fields to return some mock fields, including the mock</span>
    <span class="c1"># reverse foreign key above.</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mock_field_1</span><span class="p">,</span>
        <span class="n">mock_field_2</span><span class="p">,</span>
        <span class="n">mock_reverse_foreign_key</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Call the function with API key set because we mocked _meta</span>
    <span class="n">mock_api_key</span> <span class="o">=</span> <span class="s2">&quot;sk_fakefakefakefake01&quot;</span>
    <span class="n">test_model</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">mock_api_key</span><span class="p">)</span>

    <span class="c1"># Expect the retrieve to be done with the reverse look up of the Account ID.</span>
    <span class="n">mock_stripe_class</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">mock_id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">mock_api_key</span><span class="p">,</span> <span class="n">stripe_account</span><span class="o">=</span><span class="n">mock_account</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">mock_reverse_foreign_key</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
    <span class="n">mock_account_reverse_manager</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_subscription" class="doc doc-heading">
        <code>tests.test_subscription</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Subscription Model Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_subscription-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_subscription.SubscriptionTest" class="doc doc-heading">
        <code>
tests.test_subscription.SubscriptionTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_subscription.SubscriptionTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.default_source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.pending_setup_intent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Subscription.schedule&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_cancel_already_canceled" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_already_canceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_delete_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Subscription._api_delete&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_CANCELED</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cancel_already_canceled</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_delete_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_delete_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;No such subscription: sub_xxxx&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;canceled&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">at_period_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;canceled&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_cancel_and_reactivate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_and_reactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cancel_and_reactivate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">current_period_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">current_period_end</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">canceled_subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">current_period_end</span>
    <span class="p">)</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">canceled_subscription_fake</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="n">new_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">at_period_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">cancel_at_period_end</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">new_subscription</span><span class="o">.</span><span class="n">reactivate</span><span class="p">()</span>
    <span class="n">subscription_reactivate_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">reactivated_subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span>
        <span class="n">subscription_reactivate_fake</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reactivated_subscription</span><span class="o">.</span><span class="n">cancel_at_period_end</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_cancel_at_period_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_at_period_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cancel_at_period_end</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">current_period_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">current_period_end</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">canceled_subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">current_period_end</span>
    <span class="p">)</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">canceled_subscription_fake</span>  <span class="c1"># retrieve().delete()</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="p">)</span>

    <span class="n">new_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">at_period_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_subscription</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">active</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">cancel_at_period_end</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">canceled_at</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">ended_at</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">is_status_temporarily_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_cancel_during_trial_sets_at_period_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_during_trial_sets_at_period_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cancel_during_trial_sets_at_period_end</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">trial_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">cancel_timestamp</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">canceled_subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancel_timestamp</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;ended_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancel_timestamp</span>
    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">canceled_subscription_fake</span>  <span class="c1"># retrieve().delete()</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="n">new_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">at_period_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">cancel_at_period_end</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">canceled_at</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">ended_at</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_cancel_error_in_cancel" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_error_in_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_delete_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Subscription._api_delete&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cancel_error_in_cancel</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_delete_mock</span>
<span class="p">):</span>
    <span class="n">subscription_delete_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span>
        <span class="s2">&quot;Unexpected error&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span>
    <span class="p">)</span>

    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InvalidRequestError</span><span class="p">):</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">at_period_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_cancel_now" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_cancel_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cancel_now</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">cancel_timestamp</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">canceled_subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancel_timestamp</span>
    <span class="n">canceled_subscription_fake</span><span class="p">[</span><span class="s2">&quot;ended_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancel_timestamp</span>
    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">canceled_subscription_fake</span>  <span class="c1"># retrieve().delete()</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="n">new_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">at_period_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">cancel_at_period_end</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">canceled_at</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">ended_at</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_subscription</span><span class="o">.</span><span class="n">is_status_temporarily_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_subscription</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_extend" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_extend</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;current_period_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_unix</span><span class="p">(</span>
        <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">subscription_fake</span>

    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subscription</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">extended_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">extended_subscription</span><span class="o">.</span><span class="n">trial_end</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">product</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_extend_negative_delta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_extend_negative_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_extend_negative_delta</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_NOT_PERIOD_CURRENT</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="mi">30</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_extend_with_trial" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_extend_with_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_extend_with_trial</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">trial_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">new_trial_end</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">trial_end</span> <span class="o">+</span> <span class="n">delta</span>

    <span class="n">extended_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">new_trial_end</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">extended_subscription</span><span class="o">.</span><span class="n">trial_end</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_is_status_temporarily_current" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_is_status_temporarily_current</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_status_temporarily_current</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">))</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">canceled_at</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">cancel_at_period_end</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_status_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_status_temporarily_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">product</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_is_status_temporarily_current_false" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_is_status_temporarily_current_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_status_temporarily_current_false</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_status_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_status_temporarily_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscription</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_is_status_temporarily_current_false_and_canceled" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_is_status_temporarily_current_false_and_canceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_status_temporarily_current_false_and_canceled</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SubscriptionStatus</span><span class="o">.</span><span class="n">canceled</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_status_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_status_temporarily_current</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subscription</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">active_subscriptions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_active_subscription</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">is_subscribed_to</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">has_any_active_subscription</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_remove_all_multi_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_remove_all_multi_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_remove_all_multi_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="c1"># Simulate a webhook received with no more plan</span>
    <span class="k">del</span> <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="s2">&quot;total_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Subscription.plan&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;cancel_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1624553655</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">subscription</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">subscription</span><span class="o">.</span><span class="n">plan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">subscription</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">cancel_at</span><span class="p">),</span> <span class="mi">1624553655</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_sync_items_with_tax_rates" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_sync_items_with_tax_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_items_with_tax_rates</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_II</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">default_tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">first_item</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_item</span><span class="o">.</span><span class="n">tax_rates</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">tax_rates</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_sync_metered_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_sync_metered_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_METERED</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_metered_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_METERED</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
        <span class="s2">&quot;quantity&quot;</span><span class="p">,</span>
        <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Expect Metered plan SubscriptionItem to have no quantity&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Note that subscription.quantity is 1,</span>
    <span class="c1"># but item.quantity isn&#39;t set on metered plans</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">FAKE_PLAN_METERED</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_sync_multi_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_sync_multi_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_multi_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Subscription.plan&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_update" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_update</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">subscription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>

    <span class="n">new_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_update_multi_plan" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_update_multi_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_update_multi_plan</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_MULTI_PLAN</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="c1"># Simulate a webhook received with one plan that has been removed</span>
    <span class="k">del</span> <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">subscription_fake</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="s2">&quot;total_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span>
        <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
        <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;djstripe.Customer.subscriber&quot;</span><span class="p">,</span> <span class="s2">&quot;djstripe.Subscription.plan&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_update_set_empty_value" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_update_set_empty_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_update_set_empty_value</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription_fake</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tax_percent&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="mf">20.0</span><span class="p">)})</span>
    <span class="n">subscription_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">subscription_fake</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="mf">20.0</span><span class="p">),</span> <span class="n">subscription</span><span class="o">.</span><span class="n">tax_percent</span><span class="p">)</span>

    <span class="n">new_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tax_percent</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">tax_percent</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription.SubscriptionTest.test_update_with_plan_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription</span><span class="o">.</span><span class="n">SubscriptionTest</span><span class="o">.</span><span class="n">test_update_with_plan_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">,</span> <span class="n">subscription_retrieve_mock</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">,</span> <span class="n">plan_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Plan.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Subscription.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_update_with_plan_model</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">customer_retrieve_mock</span><span class="p">,</span>
    <span class="n">subscription_retrieve_mock</span><span class="p">,</span>
    <span class="n">product_retrieve_mock</span><span class="p">,</span>
    <span class="n">plan_retrieve_mock</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">subscription_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">subscription_fake</span><span class="p">)</span>
    <span class="n">new_plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">subscription</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">new_subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">new_plan</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">FAKE_PLAN_II</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">new_subscription</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span>
        <span class="n">subscription</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">new_plan</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="p">{})</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_subscription_schedule" class="doc doc-heading">
        <code>tests.test_subscription_schedule</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe SubscriptionSchedule model tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_subscription_schedule-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_subscription_schedule.SubscriptionScheduleTest" class="doc doc-heading">
        <code>
tests.test_subscription_schedule.SubscriptionScheduleTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_subscription_schedule.SubscriptionScheduleTest-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription_schedule.SubscriptionScheduleTest.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription_schedule</span><span class="o">.</span><span class="n">SubscriptionScheduleTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_subscription_schedule.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER_II</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;djstripe.Customer.coupon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.Customer.default_payment_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;djstripe.SubscriptionSchedule.released_subscription&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_subscription_schedule.SubscriptionScheduleTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_subscription_schedule</span><span class="o">.</span><span class="n">SubscriptionScheduleTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_subscription_schedule.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_II</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_retrieve_mock</span><span class="p">):</span>
    <span class="n">canceled_schedule_fake</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION_SCHEDULE</span><span class="p">)</span>
    <span class="n">canceled_schedule_fake</span><span class="p">[</span><span class="s2">&quot;canceled_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1624553655</span>
    <span class="n">canceled_schedule_fake</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubscriptionScheduleStatus</span><span class="o">.</span><span class="n">canceled</span>

    <span class="n">schedule</span> <span class="o">=</span> <span class="n">SubscriptionSchedule</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">canceled_schedule_fake</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assert_fks</span><span class="p">(</span><span class="n">schedule</span><span class="p">,</span> <span class="n">expected_blank_fks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_expected_blank_fks</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">schedule</span><span class="o">.</span><span class="n">canceled_at</span><span class="p">),</span> <span class="mi">1624553655</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_sync" class="doc doc-heading">
        <code>tests.test_sync</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Sync Method Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_sync-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_sync.TestSyncSubscriber" class="doc doc-heading">
        <code>
tests.test_sync.TestSyncSubscriber        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_sync.TestSyncSubscriber-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_sync.TestSyncSubscriber.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_sync</span><span class="o">.</span><span class="n">TestSyncSubscriber</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_sync.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;123&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_sync.TestSyncSubscriber.test_sync_fail" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_sync</span><span class="o">.</span><span class="n">TestSyncSubscriber</span><span class="o">.</span><span class="n">test_sync_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_customer_create_mock</span><span class="p">,</span> <span class="n">api_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_sync.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.Customer.api_retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_customer_create_mock</span><span class="p">,</span> <span class="n">api_retrieve_mock</span><span class="p">):</span>
    <span class="n">api_retrieve_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;No such customer:&quot;</span><span class="p">,</span> <span class="s2">&quot;blah&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">capture_stdout</span><span class="p">()</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="n">sync_subscriber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;ERROR: No such customer:&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_sync.TestSyncSubscriber.test_sync_success" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_sync</span><span class="o">.</span><span class="n">TestSyncSubscriber</span><span class="o">.</span><span class="n">test_sync_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_customer_create_mock</span><span class="p">,</span> <span class="n">api_retrieve_mock</span><span class="p">,</span> <span class="n">_sync_subscriptions_mock</span><span class="p">,</span> <span class="n">_sync_invoices_mock</span><span class="p">,</span> <span class="n">_sync_charges_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_sync.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer._sync_charges&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer._sync_invoices&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.Customer._sync_subscriptions&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.create&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_success</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">stripe_customer_create_mock</span><span class="p">,</span>
    <span class="n">api_retrieve_mock</span><span class="p">,</span>
    <span class="n">_sync_subscriptions_mock</span><span class="p">,</span>
    <span class="n">_sync_invoices_mock</span><span class="p">,</span>
    <span class="n">_sync_charges_mock</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">sync_subscriber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">FAKE_CUSTOMER</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subscriber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">api_retrieve</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">_sync_subscriptions_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
    <span class="n">_sync_invoices_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
    <span class="n">_sync_charges_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="tests.test_sync.capture_stdout" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_sync</span><span class="o">.</span><span class="n">capture_stdout</span><span class="p">()</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_sync.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">capture_stdout</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

    <span class="n">old_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">old_stdout</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_tax_ids" class="doc doc-heading">
        <code>tests.test_tax_ids</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe TaxId Model Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_tax_ids.TaxIdTest" class="doc doc-heading">
        <code>
tests.test_tax_ids.TaxIdTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_tax_ids.TaxIdTest.test_api_list_invalid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_tax_ids</span><span class="o">.</span><span class="n">TaxIdTest</span><span class="o">.</span><span class="n">test_api_list_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_tax_ids.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_api_list_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">StripeObjectManipulationException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">TaxId</span><span class="o">.</span><span class="n">api_list</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="s2">&quot;Iamastring&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="o">==</span> <span class="s2">&quot;TaxIds must be manipulated through a Customer. Pass a Customer object into this call.&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_tax_ids.TaxIdTest.test_api_list_success" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_tax_ids</span><span class="o">.</span><span class="n">TaxIdTest</span><span class="o">.</span><span class="n">test_api_list_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_tax_ids.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_WITH_TAX_ID</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_api_list_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">customer_mock</span><span class="o">.</span><span class="n">return_value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tax_ids</span> <span class="o">=</span> <span class="n">TaxId</span><span class="o">.</span><span class="n">api_list</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">tax_ids</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_tax_ids.TaxIdTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_tax_ids</span><span class="o">.</span><span class="n">TaxIdTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_tax_ids.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Customer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_WITHOUT_TAX_ID</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_mock</span><span class="p">):</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">FAKE_CUSTOMER_WITHOUT_TAX_ID</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">tax_id</span> <span class="o">=</span> <span class="n">TaxId</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TAX_ID</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tax_id</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">&quot;eu_vat&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tax_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;DE123456789&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">tax_ids</span><span class="o">.</span><span class="n">last</span><span class="p">(),</span> <span class="n">tax_id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_tax_rates" class="doc doc-heading">
        <code>tests.test_tax_rates</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe SetupIntent Model Tests.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tests.test_tax_rates.TaxRateTest" class="doc doc-heading">
        <code>
tests.test_tax_rates.TaxRateTest        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_tax_rates.TaxRateTest.test_sync_from_stripe_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_tax_rates</span><span class="o">.</span><span class="n">TaxRateTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_tax_rates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sync_from_stripe_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tax_rate</span> <span class="o">=</span> <span class="n">TaxRate</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TAX_RATE_EXAMPLE_1_VAT</span><span class="p">))</span>
    <span class="c1"># need to refresh to load percentage as decimal</span>
    <span class="n">tax_rate</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">percentage</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">percentage</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;15.0&quot;</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_tax_rates.TaxRateTest.test_sync_from_stripe_data_non_integer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_tax_rates</span><span class="o">.</span><span class="n">TaxRateTest</span><span class="o">.</span><span class="n">test_sync_from_stripe_data_non_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_tax_rates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_sync_from_stripe_data_non_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># an example non-integer taxrate</span>
    <span class="n">tax_rate</span> <span class="o">=</span> <span class="n">TaxRate</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span>
        <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TAX_RATE_EXAMPLE_2_SALES</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># need to refresh to load percentage as decimal</span>
    <span class="n">tax_rate</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">percentage</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tax_rate</span><span class="o">.</span><span class="n">percentage</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;4.25&quot;</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_utils" class="doc doc-heading">
        <code>tests.test_utils</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Utilities Tests.</p>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tests.test_utils.TZ_IS_UTC" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TZ_IS_UTC</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>


<h4 id="tests.test_utils-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_utils.TestGetSupportedCurrencyChoices" class="doc doc-heading">
        <code>
tests.test_utils.TestGetSupportedCurrencyChoices        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestGetSupportedCurrencyChoices.test_get_choices" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestGetSupportedCurrencyChoices</span><span class="o">.</span><span class="n">test_get_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stripe_account_retrieve_mock</span><span class="p">,</span> <span class="n">stripe_countryspec_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.CountrySpec.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;supported_payment_currencies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;cad&quot;</span><span class="p">,</span> <span class="s2">&quot;eur&quot;</span><span class="p">]},</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Account.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span><span class="p">},</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_choices</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">stripe_account_retrieve_mock</span><span class="p">,</span> <span class="n">stripe_countryspec_retrieve_mock</span>
<span class="p">):</span>
    <span class="c1"># Simple test to test sure that at least one currency choice tuple is returned.</span>

    <span class="n">currency_choices</span> <span class="o">=</span> <span class="n">get_supported_currency_choices</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stripe_account_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
    <span class="n">stripe_countryspec_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;US&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">currency_choices</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Currency choices pull returned an empty list.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="nb">tuple</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">currency_choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;Currency choices are not tuples.&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">((</span><span class="s2">&quot;usd&quot;</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span> <span class="n">currency_choices</span><span class="p">,</span> <span class="s2">&quot;USD not in currency choices.&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_utils.TestTimestampConversion" class="doc doc-heading">
        <code>
tests.test_utils.TestTimestampConversion        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestTimestampConversion.test_conversion" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestTimestampConversion</span><span class="o">.</span><span class="n">test_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">convert_tstamp</span><span class="p">(</span><span class="mi">1365567407</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestTimestampConversion.test_conversion_no_tz" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestTimestampConversion</span><span class="o">.</span><span class="n">test_conversion_no_tz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">TZ_IS_UTC</span><span class="p">,</span> <span class="s2">&quot;Skipped because timezone is not UTC.&quot;</span><span class="p">)</span>
<span class="nd">@override_settings</span><span class="p">(</span><span class="n">USE_TZ</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_conversion_no_tz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">convert_tstamp</span><span class="p">(</span><span class="mi">1365567407</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">47</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_utils.TestUserHasActiveSubscription" class="doc doc-heading">
        <code>
tests.test_utils.TestUserHasActiveSubscription        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_utils.TestUserHasActiveSubscription-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUserHasActiveSubscription.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pydanny&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;pydanny@gmail.com&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">FAKE_CUSTOMER</span><span class="o">.</span><span class="n">create_for_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUserHasActiveSubscription.test_anonymous_user" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_anonymous_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>This needs to throw an ImproperlyConfigured error so the developer
can be guided to properly protect the subscription content.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_anonymous_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This needs to throw an ImproperlyConfigured error so the developer</span>
<span class="sd">    can be guided to properly protect the subscription content.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">anon_user</span> <span class="o">=</span> <span class="n">AnonymousUser</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ImproperlyConfigured</span><span class="p">):</span>
        <span class="n">subscriber_has_active_subscription</span><span class="p">(</span><span class="n">anon_user</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUserHasActiveSubscription.test_custom_subscriber" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_custom_subscriber</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p><code>subscriber_has_active_subscription</code> attempts to create a customer object
for the current user. This causes a ValueError in this test because the
database has already been established with auth.User.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_custom_subscriber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ``subscriber_has_active_subscription`` attempts to create a customer object</span>
<span class="sd">    for the current user. This causes a ValueError in this test because the</span>
<span class="sd">    database has already been established with auth.User.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subscriber</span> <span class="o">=</span> <span class="n">Organization</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">&quot;email@test.com&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">subscriber_has_active_subscription</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUserHasActiveSubscription.test_staff_user" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_staff_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_staff_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscriber_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUserHasActiveSubscription.test_superuser" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscriber_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUserHasActiveSubscription.test_user_has_active_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_user_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Product.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_PRODUCT</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_user_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_retrieve_mock</span><span class="p">):</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">sync_from_stripe_data</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_SUBSCRIPTION</span><span class="p">))</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">current_period_end</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># Assert that the customer&#39;s subscription is valid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subscriber_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUserHasActiveSubscription.test_user_has_inactive_subscription" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUserHasActiveSubscription</span><span class="o">.</span><span class="n">test_user_has_inactive_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_user_has_inactive_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subscriber_has_active_subscription</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_utils.TestUtils" class="doc doc-heading">
        <code>
tests.test_utils.TestUtils        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tests.test_utils.TestUtils.test_get_friendly_currency_amount" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestUtils</span><span class="o">.</span><span class="n">test_get_friendly_currency_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_utils.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_friendly_currency_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">get_friendly_currency_amount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.001&quot;</span><span class="p">),</span> <span class="s2">&quot;usd&quot;</span><span class="p">),</span> <span class="s2">&quot;$1.00 USD&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">get_friendly_currency_amount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10&quot;</span><span class="p">),</span> <span class="s2">&quot;usd&quot;</span><span class="p">),</span> <span class="s2">&quot;$10.00 USD&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">get_friendly_currency_amount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;usd&quot;</span><span class="p">),</span> <span class="s2">&quot;$10.50 USD&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">get_friendly_currency_amount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.51&quot;</span><span class="p">),</span> <span class="s2">&quot;cad&quot;</span><span class="p">),</span> <span class="s2">&quot;$10.51 CAD&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">get_friendly_currency_amount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;9.99&quot;</span><span class="p">),</span> <span class="s2">&quot;eur&quot;</span><span class="p">),</span> <span class="s2">&quot;€9.99 EUR&quot;</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_webhooks" class="doc doc-heading">
        <code>tests.test_webhooks</code>



</h3>

    <div class="doc doc-contents ">

      <p>dj-stripe Webhook Tests.</p>



  <div class="doc doc-children">





<h4 id="tests.test_webhooks-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_webhooks.TestWebhook" class="doc doc-heading">
        <code>
tests.test_webhooks.TestWebhook        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_webhooks.TestWebhook-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.tearDown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for deconstructing the test fixture after testing it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_error" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">mock_invoke_webhook_handlers</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Test the case where webhook processing fails to ensure we rollback
and do not commit the Event object to the database.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;invoke_webhook_handlers&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_error</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">mock_invoke_webhook_handlers</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the case where webhook processing fails to ensure we rollback</span>
<span class="sd">    and do not commit the Event object to the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_invoke_webhook_handlers</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Test error&quot;</span><span class="p">)</span>
    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">WEBHOOK_SECRET</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">fake_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_event</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">fake_event</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">event_trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event_trigger</span><span class="o">.</span><span class="n">is_test_event</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event_trigger</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="s2">&quot;&#39;Test error&#39;&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_good" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_good</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_good</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">):</span>
    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">WEBHOOK_SECRET</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">fake_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_event</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">fake_event</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">event_trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event_trigger</span><span class="o">.</span><span class="n">is_test_event</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_invalid_verify_signature_fail" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_invalid_verify_signature_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_WEBHOOK_VALIDATION</span><span class="o">=</span><span class="s2">&quot;verify_signature&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_WEBHOOK_SECRET</span><span class="o">=</span><span class="s2">&quot;whsec_XXXXX&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_invalid_verify_signature_fail</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>

    <span class="n">invalid_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">invalid_event</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;evt_invalid&quot;</span>
    <span class="n">invalid_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not really&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">invalid_event</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;evt_invalid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_no_signature" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_no_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_webhook_no_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;djstripe:webhook&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_no_validation_pass" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_no_validation_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">verify_header_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_WEBHOOK_VALIDATION</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.WebhookSignature.verify_header&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_no_validation_pass</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">verify_header_mock</span>
<span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>

    <span class="n">invalid_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">invalid_event</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;evt_invalid&quot;</span>
    <span class="n">invalid_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not really&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">invalid_event</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;evt_invalid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">verify_header_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_remote_addr_is_empty_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_remote_addr_is_empty_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_webhook_remote_addr_is_empty_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">Client</span><span class="p">()</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;djstripe:webhook&quot;</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="n">HTTP_STRIPE_SIGNATURE</span><span class="o">=</span><span class="s2">&quot;PLACEHOLDER&quot;</span><span class="p">,</span>
            <span class="n">REMOTE_ADDR</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">event_trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event_trigger</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_remote_addr_is_none" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_remote_addr_is_none</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_webhook_remote_addr_is_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">Client</span><span class="p">()</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;djstripe:webhook&quot;</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="n">HTTP_STRIPE_SIGNATURE</span><span class="o">=</span><span class="s2">&quot;PLACEHOLDER&quot;</span><span class="p">,</span>
            <span class="n">REMOTE_ADDR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">event_trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event_trigger</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_reraise_exception" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_reraise_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webhook_event_process_mock</span><span class="p">,</span> <span class="n">webhook_event_validate_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;djstripe.models.WebhookEventTrigger.validate&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;djstripe.models.WebhookEventTrigger.process&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_reraise_exception</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">webhook_event_process_mock</span><span class="p">,</span> <span class="n">webhook_event_validate_mock</span>
<span class="p">):</span>
    <span class="k">class</span> <span class="nc">ProcessException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">exception_message</span> <span class="o">=</span> <span class="s2">&quot;process fail&quot;</span>

    <span class="n">webhook_event_process_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ProcessException</span><span class="p">(</span><span class="n">exception_message</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">fake_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span><span class="n">ProcessException</span><span class="p">,</span> <span class="n">exception_message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">fake_event</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">event_trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">event_trigger</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="n">exception_message</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_retrieve_event_fail" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_retrieve_event_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_WEBHOOK_VALIDATION</span><span class="o">=</span><span class="s2">&quot;retrieve_event&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_retrieve_event_fail</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>

    <span class="n">invalid_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">invalid_event</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;evt_invalid&quot;</span>
    <span class="n">invalid_event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not really&quot;</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">invalid_event</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;evt_invalid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_retrieve_event_pass" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_retrieve_event_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span><span class="n">DJSTRIPE_WEBHOOK_VALIDATION</span><span class="o">=</span><span class="s2">&quot;retrieve_event&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_retrieve_event_pass</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">djstripe_settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_test_event" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_test_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_webhook_test_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TEST_CHARGE_SUCCEEDED</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">TEST_EVENT_ID</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">event_trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">event_trigger</span><span class="o">.</span><span class="n">is_test_event</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_verify_signature_pass" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_verify_signature_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">verify_header_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@override_settings</span><span class="p">(</span>
    <span class="n">DJSTRIPE_WEBHOOK_VALIDATION</span><span class="o">=</span><span class="s2">&quot;verify_signature&quot;</span><span class="p">,</span>
    <span class="n">DJSTRIPE_WEBHOOK_SECRET</span><span class="o">=</span><span class="s2">&quot;whsec_XXXXX&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.WebhookSignature.verify_header&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">autospec</span><span class="o">=</span><span class="n">IS_STATICMETHOD_AUTOSPEC_SUPPORTED</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span>
    <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">),</span>
    <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_verify_signature_pass</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">verify_header_mock</span>
<span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;evt_invalid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
    <span class="n">verify_header_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">),</span>
        <span class="s2">&quot;PLACEHOLDER&quot;</span><span class="p">,</span>
        <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">WEBHOOK_SECRET</span><span class="p">,</span>
        <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">WEBHOOK_TOLERANCE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_with_custom_callback" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_with_custom_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">webhook_event_callback_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span>
    <span class="n">djstripe_settings</span><span class="p">,</span> <span class="s2">&quot;WEBHOOK_EVENT_CALLBACK&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_webhook_handler</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_with_custom_callback</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">,</span> <span class="n">webhook_event_callback_mock</span>
<span class="p">):</span>
    <span class="n">fake_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_event</span>

    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">WEBHOOK_SECRET</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">fake_event</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">webhook_event_trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">webhook_event_callback_mock</span><span class="o">.</span><span class="n">called_once_with</span><span class="p">(</span><span class="n">webhook_event_trigger</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhook.test_webhook_with_transfer_event_duplicate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhook</span><span class="o">.</span><span class="n">test_webhook_with_transfer_event_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span>
    <span class="s2">&quot;stripe.Transfer.retrieve&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_TRANSFER</span><span class="p">),</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;stripe.Event.retrieve&quot;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_webhook_with_transfer_event_duplicate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">event_retrieve_mock</span><span class="p">,</span> <span class="n">transfer_retrieve_mock</span>
<span class="p">):</span>
    <span class="n">fake_event</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">FAKE_EVENT_TRANSFER_CREATED</span><span class="p">)</span>
    <span class="n">event_retrieve_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_event</span>

    <span class="n">djstripe_settings</span><span class="o">.</span><span class="n">WEBHOOK_SECRET</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">fake_event</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;transfer.created&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;transfer.created&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="c1"># Duplication</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">fake_event</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;transfer.created&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_webhooks.TestWebhookHandlers" class="doc doc-heading">
        <code>
tests.test_webhooks.TestWebhookHandlers        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_webhooks.TestWebhookHandlers-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.setUp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for setting up the test fixture before exercising it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Reset state of registrations per test</span>
    <span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span>
        <span class="n">webhooks</span><span class="p">,</span> <span class="s2">&quot;registrations&quot;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registrations</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">webhooks</span><span class="p">,</span> <span class="s2">&quot;registrations_global&quot;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registrations_global</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.test_event_handle_registation_with_list_of_strings" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">test_event_handle_registation_with_list_of_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_event_handle_registation_with_list_of_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">)(</span><span class="n">func_mock</span><span class="p">)</span>
    <span class="n">event1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;foo.bar&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="n">event2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;bar.foo&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
    <span class="n">func_mock</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span><span class="n">call</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event1</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event2</span><span class="p">)])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.test_event_handle_registation_with_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">test_event_handle_registation_with_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_event_handle_registation_with_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)(</span><span class="n">func_mock</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;foo.bar&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
    <span class="n">func_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.test_event_handler_registration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">test_event_handler_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_event_handler_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">global_func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler_all</span><span class="p">()(</span><span class="n">global_func_mock</span><span class="p">)</span>
    <span class="n">func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)(</span><span class="n">func_mock</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;foo.bar&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;bar.foo&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># not handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">global_func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>  <span class="c1"># called each time</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
    <span class="n">func_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.test_event_subtype_handler_registration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">test_event_subtype_handler_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_event_subtype_handler_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">global_func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler_all</span><span class="p">()(</span><span class="n">global_func_mock</span><span class="p">)</span>
    <span class="n">func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler</span><span class="p">(</span><span class="s2">&quot;foo.bar&quot;</span><span class="p">)(</span><span class="n">func_mock</span><span class="p">)</span>
    <span class="n">event1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;foo.bar&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="n">event2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;foo.bar.wib&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;foo.baz&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># not handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">global_func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>  <span class="c1"># called each time</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
    <span class="n">func_mock</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span><span class="n">call</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event1</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event2</span><span class="p">)])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.test_global_handler_registration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">test_global_handler_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_global_handler_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler_all</span><span class="p">()(</span><span class="n">func_mock</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;wib.ble&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
    <span class="n">func_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.test_global_handler_registration_with_function" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">test_global_handler_registration_with_function</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_global_handler_registration_with_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">func_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">handler_all</span><span class="p">(</span><span class="n">func_mock</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handlers</span><span class="p">(</span><span class="s2">&quot;wib.ble&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">})</span>  <span class="c1"># handled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">func_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
    <span class="n">func_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_webhooks.TestWebhookHandlers.test_webhook_event_trigger_invalid_body" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">TestWebhookHandlers</span><span class="o">.</span><span class="n">test_webhook_event_trigger_invalid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_webhook_event_trigger_invalid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">trigger</span> <span class="o">=</span> <span class="n">WebhookEventTrigger</span><span class="p">(</span><span class="n">remote_ip</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;invalid json&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">trigger</span><span class="o">.</span><span class="n">json_body</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="tests.test_webhooks.mock_webhook_handler" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_webhooks</span><span class="o">.</span><span class="n">mock_webhook_handler</span><span class="p">(</span><span class="n">webhook_event_trigger</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_webhooks.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">mock_webhook_handler</span><span class="p">(</span><span class="n">webhook_event_trigger</span><span class="p">):</span>
    <span class="n">webhook_event_trigger</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.test_zz_jsonfield" class="doc doc-heading">
        <code>tests.test_zz_jsonfield</code>



</h3>

    <div class="doc doc-contents ">

      <p>Tests for JSONField</p>
<p>Due to their nature messing with subclassing, these tests must be run last.</p>



  <div class="doc doc-children">





<h4 id="tests.test_zz_jsonfield-classes">Classes</h4>

  <div class="doc doc-object doc-class">



<h5 id="tests.test_zz_jsonfield.TestFallbackJSONField" class="doc doc-heading">
        <code>
tests.test_zz_jsonfield.TestFallbackJSONField        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_zz_jsonfield.TestFallbackJSONField-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_zz_jsonfield.TestFallbackJSONField.tearDown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_zz_jsonfield</span><span class="o">.</span><span class="n">TestFallbackJSONField</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for deconstructing the test fixture after testing it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_zz_jsonfield.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_zz_jsonfield.TestFallbackJSONField.test_jsonfield_inheritance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_zz_jsonfield</span><span class="o">.</span><span class="n">TestFallbackJSONField</span><span class="o">.</span><span class="n">test_jsonfield_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_zz_jsonfield.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_jsonfield_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">JSONField</span><span class="p">,</span> <span class="n">UglyJSONField</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tests.test_zz_jsonfield.TestNativeJSONField" class="doc doc-heading">
        <code>
tests.test_zz_jsonfield.TestNativeJSONField        </code>



</h5>

    <div class="doc doc-contents ">





  <div class="doc doc-children">







<h6 id="tests.test_zz_jsonfield.TestNativeJSONField-methods">Methods</h6>

  <div class="doc doc-object doc-method">



<h7 id="tests.test_zz_jsonfield.TestNativeJSONField.tearDown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_zz_jsonfield</span><span class="o">.</span><span class="n">TestNativeJSONField</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">

      <p>Hook method for deconstructing the test fixture after testing it.</p>

        <details class="quote">
          <summary>Source code in <code>tests/test_zz_jsonfield.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tests.test_zz_jsonfield.TestNativeJSONField.test_jsonfield_inheritance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">test_zz_jsonfield</span><span class="o">.</span><span class="n">TestNativeJSONField</span><span class="o">.</span><span class="n">test_jsonfield_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/test_zz_jsonfield.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_jsonfield_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">djstripe_settings</span><span class="p">)</span>
    <span class="n">reload</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">JSONField</span><span class="p">,</span> <span class="n">DjangoJSONField</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tests.urls" class="doc doc-heading">
        <code>tests.urls</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tests.urls.urlpatterns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">urlpatterns</span></code>


</h5>

    <div class="doc doc-contents ">

    </div>

  </div>





  <div class="doc doc-object doc-function">



<h5 id="tests.urls.empty_view" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tests</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">empty_view</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>tests/urls.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">empty_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/dj-stripe/dj-stripe/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
      <script src="../../js/version-select.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
